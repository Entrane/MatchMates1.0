<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Tableau de bord ‚Äì MatchMates</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />

  <style>
    :root {
      --primary-color: #22c55e;
      --sidebar-width: 320px;
      --bg-dark: #0f172a;
      --bg-card: #1e293b;
      --text-main: #f1f5f9;
      --text-muted: #94a3b8;
    }

    body {
        background-color: var(--bg-dark);
        color: var(--text-main);
        font-family: 'Inter', sans-serif;
        margin: 0;
        overflow-x: hidden; /* Emp√™che le scroll horizontal global */
    }

    /* --- LAYOUT PRINCIPAL --- */
    .dashboard-layout {
      max-width: 1100px;
      margin: 80px auto 40px;
      padding: 0 20px;
    }
    
    header {
        display: flex; justify-content: space-between; align-items: center;
        padding: 15px 30px; background: rgba(30, 41, 59, 0.9);
        backdrop-filter: blur(10px); position: fixed; top: 0; width: 100%; z-index: 800;
        box-sizing: border-box; border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    nav a { color: var(--text-muted); text-decoration: none; margin-left: 20px; font-size: 0.9rem; }
    nav a:hover { color: white; }

    /* --- SECTION JEUX (Centre) --- */
    h2.section-title {
        font-size: 1.5rem; margin-bottom: 15px; border-left: 4px solid var(--primary-color);
        padding-left: 15px; color: white;
    }

    /* Grille des Favoris */
    .favorites-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 20px;
        margin-bottom: 50px;
        min-height: 100px; /* Pour √©viter le saut si vide */
    }
    .empty-msg { grid-column: 1 / -1; text-align: center; color: var(--text-muted); font-style: italic; padding: 20px; border: 1px dashed #334155; border-radius: 10px; }

    /* Style Carte de Jeu (Commun) */
    .game-card {
        background: var(--bg-card); border-radius: 15px; overflow: hidden;
        position: relative; transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.05);
        aspect-ratio: 3/4; /* Format portrait */
    }
    .game-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.5); }

    .game-img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .game-overlay {
        position: absolute; bottom: 0; left: 0; width: 100%;
        background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
        padding: 60px 10px 15px; pointer-events: none;
    }
    .game-title { font-weight: 700; font-size: 1rem; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }

    /* Bouton Coeur */
    .heart-btn {
        position: absolute; top: 10px; right: 10px;
        background: rgba(0,0,0,0.5); border: none; border-radius: 50%;
        width: 35px; height: 35px; cursor: pointer; z-index: 10;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.2rem; color: white; transition: 0.2s;
        backdrop-filter: blur(4px);
    }
    .heart-btn:hover { background: rgba(255,255,255,0.2); transform: scale(1.1); }
    .heart-btn.active { color: #ef4444; text-shadow: 0 0 10px rgba(239, 68, 68, 0.5); }

    /* --- CARROUSEL --- */
    .carousel-container {
        position: relative;
        overflow: hidden; /* Cache ce qui d√©passe */
        padding: 20px 0;
    }
    /* La piste qui bouge */
    .carousel-track {
        display: flex;
        gap: 20px;
        width: max-content; /* S'adapte au contenu */
        /* Animation g√©r√©e par JS pour le contr√¥le pause/play */
    }
    .carousel-item {
        width: 200px;
        flex-shrink: 0; /* Ne pas √©craser les cartes */
    }

    /* --- BOUTON TOGGLE FLOTTANT --- */
    .toggle-friends-btn {
      position: fixed; top: 80px; right: 20px; z-index: 1100;
      background: var(--primary-color); color: #020617; border: none;
      padding: 10px 16px; border-radius: 30px; cursor: pointer;
      display: flex; align-items: center; gap: 8px; font-weight: 600;
      box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* --- SIDEBAR --- */
    .friends-sidebar {
      position: fixed; top: 0; right: -340px; width: var(--sidebar-width); height: 100vh;
      background: rgba(15, 23, 42, 0.98); border-left: 1px solid rgba(255,255,255,0.1);
      box-shadow: -10px 0 30px rgba(0,0,0,0.5); padding: 80px 15px 20px; z-index: 1000;
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex; flex-direction: column; gap: 15px; backdrop-filter: blur(12px);
    }
    .friends-sidebar.active { right: 0; }
    .friends-sidebar.active ~ .toggle-friends-btn { right: 280px; background: #ef4444; color: white; }
    .friends-sidebar.active ~ .toggle-friends-btn span { display: none; }
    .friends-sidebar.active ~ .toggle-friends-btn::after { content: "‚úï"; }

    /* Sidebar Contenu */
    .sidebar-section-title { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-top: 15px; font-weight: 700; }
    .friend-card { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-radius: 12px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); cursor: pointer; margin-bottom: 5px;}
    .friend-card:hover { background: rgba(255,255,255,0.08); }
    .friend-avatar { width: 32px; height: 32px; border-radius: 50%; background: #3b82f6; display: flex; justify-content: center; align-items: center; font-weight: bold; margin-right: 10px; }
    .friend-status.pending { color: #fbbf24; }
    .add-friend-box { display: flex; gap: 5px; }
    .add-friend-box input { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid #334155; border-radius: 20px; padding: 6px 12px; color: white; outline: none; }
    .add-friend-box button { background: var(--primary-color); border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-weight: bold; }

    /* CHAT */
    .chat-container { position: fixed; bottom: 0; right: 360px; display: flex; flex-direction: row-reverse; gap: 15px; z-index: 900; pointer-events: none; }
    @media(max-width: 900px) { .chat-container { right: 10px; } }
    .chat-window { width: 300px; height: 400px; background: var(--bg-card); border-radius: 12px 12px 0 0; display: flex; flex-direction: column; pointer-events: auto; border: 1px solid #334155; }
    .chat-header { background: #0f172a; padding: 10px; cursor: pointer; display: flex; justify-content: space-between; border-bottom: 1px solid #334155; }
    .chat-body { flex: 1; padding: 10px; overflow-y: auto; background: #020617; display: flex; flex-direction: column; gap: 8px; }
    .chat-input-area { padding: 10px; background: #1e293b; border-top: 1px solid #334155; display: flex; }
    .chat-input-area input { flex: 1; padding: 8px; border-radius: 20px; border: none; background: #334155; color: white; outline: none; }
    .msg { padding: 6px 12px; border-radius: 12px; max-width: 80%; font-size: 0.85rem; }
    .msg.me { align-self: flex-end; background: var(--primary-color); color: #020617; }
    .msg.them { align-self: flex-start; background: #334155; color: white; }

  </style>
</head>

<body data-current-username="{{ username }}">

  <header>
    <div style="font-weight: 800; font-size: 1.2rem; display:flex; align-items:center; gap:10px;">
        <span style="color:var(--primary-color); font-size:1.5rem;">M</span> MatchMates
    </div>
    <nav>
        <a href="/logout">D√©connexion</a>
    </nav>
  </header>

  <main class="dashboard-layout">
      
      <h2 class="section-title">üíñ Mes Jeux Favoris</h2>
      <div id="favorites-container" class="favorites-grid">
          <div class="empty-msg">Tu n'as pas encore de favoris. Ajoute-les via le carrousel ci-dessous !</div>
      </div>

      <h2 class="section-title">üéÆ Tous les Jeux</h2>
      <div class="carousel-container" id="carousel-container">
          <div class="carousel-track" id="carousel-track">
              </div>
      </div>

  </main>

  <button class="toggle-friends-btn" onclick="toggleSidebar()">
    <span>üí¨ Amis</span>
  </button>

  <aside class="friends-sidebar" id="friendsSidebar">
    <h2 style="margin: 0; font-size: 1.1rem;">Social</h2>

    <div class="sidebar-section-title">Ajouter</div>
    <form class="add-friend-box" id="add-friend-form">
        <input type="text" id="friend-input" placeholder="Pseudo..." autocomplete="off">
        <button type="submit">+</button>
    </form>
    <div id="friend-notif" style="font-size:0.75rem; margin-top:5px; min-height:1em;"></div>

    <div id="section-requests-in" style="display:none;">
        <div class="sidebar-section-title">Re√ßues</div>
        <div id="list-requests-in"></div>
    </div>

    <div id="section-requests-out" style="display:none;">
        <div class="sidebar-section-title">Envoy√©es</div>
        <div id="list-requests-out"></div>
    </div>

    <div class="sidebar-section-title">Mes Amis (<span id="friend-count">0</span>)</div>
    <div id="friends-list" style="overflow-y: auto; flex: 1;"></div>
  </aside>

  <div id="chat-container" class="chat-container"></div>

  <script>
    function toggleSidebar() { document.getElementById('friendsSidebar').classList.toggle('active'); }

    (function() {
        /* =========================================
           1. CONFIGURATION DES JEUX
           ========================================= */
        // Liste statique pour l'exemple. Tu peux changer les URLs d'images.
        const ALL_GAMES = [
            { id: 'lol', name: 'League of Legends', img: 'https://placehold.co/300x400/16213e/fff?text=LoL' },
            { id: 'valorant', name: 'Valorant', img: 'https://placehold.co/300x400/ff4655/fff?text=Valorant' },
            { id: 'wow', name: 'World of Warcraft', img: 'https://placehold.co/300x400/f1c40f/000?text=WoW' },
            { id: 'minecraft', name: 'Minecraft', img: 'https://placehold.co/300x400/27ae60/fff?text=Minecraft' },
            { id: 'gta', name: 'GTA V', img: 'https://placehold.co/300x400/2c3e50/fff?text=GTA+V' },
            { id: 'rocket', name: 'Rocket League', img: 'https://placehold.co/300x400/2980b9/fff?text=Rocket+League' },
            { id: 'fortnite', name: 'Fortnite', img: 'https://placehold.co/300x400/8e44ad/fff?text=Fortnite' },
            { id: 'cod', name: 'Call of Duty', img: 'https://placehold.co/300x400/34495e/fff?text=CoD' },
            { id: 'apex', name: 'Apex Legends', img: 'https://placehold.co/300x400/e74c3c/fff?text=Apex' },
            { id: 'overwatch', name: 'Overwatch 2', img: 'https://placehold.co/300x400/e67e22/fff?text=Overwatch' },
        ];

        // Charger favoris depuis LocalStorage
        let favorites = JSON.parse(localStorage.getItem('mm_favorites')) || [];

        /* =========================================
           2. LOGIQUE CARROUSEL & FAVORIS
           ========================================= */
        const track = document.getElementById('carousel-track');
        const favContainer = document.getElementById('favorites-container');
        const carouselContainer = document.getElementById('carousel-container');

        function isFav(id) { return favorites.includes(id); }

        function toggleFavorite(id) {
            if (isFav(id)) {
                favorites = favorites.filter(fid => fid !== id); // Retirer
            } else {
                favorites.push(id); // Ajouter
            }
            localStorage.setItem('mm_favorites', JSON.stringify(favorites)); // Sauvegarder
            renderAll(); // Tout rafraichir
        }

        // G√©n√©rer le HTML d'une carte
        function createCardHTML(game) {
            const activeClass = isFav(game.id) ? 'active' : '';
            const heartIcon = isFav(game.id) ? '‚ô•' : '‚ô°';
            
            return `
                <div class="game-card">
                    <img src="${game.img}" alt="${game.name}" class="game-img">
                    <div class="game-overlay">
                        <div class="game-title">${game.name}</div>
                    </div>
                    <button class="heart-btn ${activeClass}" onclick="window.toggleGameFav('${game.id}')">
                        ${heartIcon}
                    </button>
                </div>
            `;
        }

        function renderAll() {
            // 1. Rendu Favoris
            favContainer.innerHTML = "";
            if (favorites.length === 0) {
                favContainer.innerHTML = '<div class="empty-msg">Clique sur le coeur ‚ô° des jeux ci-dessous pour les ajouter ici !</div>';
            } else {
                favorites.forEach(fid => {
                    const game = ALL_GAMES.find(g => g.id === fid);
                    if (game) {
                        const div = document.createElement('div');
                        div.innerHTML = createCardHTML(game);
                        favContainer.appendChild(div);
                    }
                });
            }

            // 2. Rendu Carrousel (On vide et on recr√©e pour mettre √† jour les coeurs)
            // Pour un effet "infini", on double la liste
            track.innerHTML = "";
            const displayList = [...ALL_GAMES, ...ALL_GAMES]; // Doubl√© pour scroll fluide
            
            displayList.forEach(game => {
                const div = document.createElement('div');
                div.className = 'carousel-item';
                div.innerHTML = createCardHTML(game);
                track.appendChild(div);
            });
        }

        // Exposer la fonction au global pour le onclick
        window.toggleGameFav = (id) => toggleFavorite(id);

        // --- Animation Carrousel ---
        let scrollAmount = 0;
        let isHovered = false;
        
        // Pause quand la souris est sur le carrousel
        carouselContainer.addEventListener('mouseenter', () => isHovered = true);
        carouselContainer.addEventListener('mouseleave', () => isHovered = false);

        function autoScroll() {
            if (!isHovered) {
                scrollAmount += 1; // Vitesse (plus haut = plus vite)
                // Si on arrive √† la moiti√© (fin de la liste originale), on reset pour boucle infini
                if (scrollAmount >= track.scrollWidth / 2) {
                    scrollAmount = 0;
                }
                track.style.transform = `translateX(-${scrollAmount}px)`;
            }
            requestAnimationFrame(autoScroll);
        }

        // Init
        renderAll();
        autoScroll();


        /* =========================================
           3. LOGIQUE AMIS (Code pr√©c√©dent)
           ========================================= */
        const friendNotif = document.getElementById('friend-notif');
        const chatContainer = document.getElementById('chat-container');
        const activeChats = {}; 

        async function loadSocialData() {
            try {
                const [fRes, rRes] = await Promise.all([fetch('/api/friends'), fetch('/api/friends/requests')]);
                const fData = await fRes.json();
                const rData = await rRes.json();
                renderFriends(fData.friends);
                renderRequests(rData.incoming, rData.outgoing);
            } catch(e) {}
        }

        function renderFriends(list) {
            const container = document.getElementById('friends-list');
            document.getElementById('friend-count').innerText = list.length;
            container.innerHTML = "";
            if(list.length === 0) { container.innerHTML = '<div style="text-align:center; color:#64748b; font-size:0.8rem; margin-top:10px;">Aucun ami.</div>'; return; }
            list.forEach(f => {
                const div = document.createElement('div');
                div.className = 'friend-card';
                div.onclick = () => openChat(f.username);
                div.innerHTML = `
                    <div style="display:flex; align-items:center;">
                        <div class="friend-avatar">${f.username[0].toUpperCase()}</div>
                        <div><div style="font-size:0.9rem; font-weight:500; color:white;">${f.username}</div><div class="friend-status">‚óè En ligne</div></div>
                    </div>
                    <span>üí¨</span>`;
                container.appendChild(div);
            });
        }

        function renderRequests(inc, out) {
            const inC = document.getElementById('list-requests-in');
            document.getElementById('section-requests-in').style.display = inc.length ? 'block' : 'none';
            inC.innerHTML = "";
            inc.forEach(r => {
                const d = document.createElement('div'); d.className = 'friend-card'; d.style.border='1px solid #eab308';
                d.innerHTML = `<span style="font-size:0.85rem;">${r.from_username}</span><div><button onclick="handleReq(${r.id},'accept')" style="background:#22c55e;border:none;border-radius:4px;cursor:pointer;">‚úî</button><button onclick="handleReq(${r.id},'reject')" style="background:#ef4444;border:none;border-radius:4px;cursor:pointer;margin-left:5px;">‚úñ</button></div>`;
                inC.appendChild(d);
            });

            const outC = document.getElementById('list-requests-out');
            document.getElementById('section-requests-out').style.display = out.length ? 'block' : 'none';
            outC.innerHTML = "";
            out.forEach(r => {
                const d = document.createElement('div'); d.className = 'friend-card'; d.style.cursor='default';
                d.innerHTML = `<div style="display:flex; align-items:center; opacity:0.7;"><div class="friend-avatar" style="background:#64748b; width:24px; height:24px; font-size:0.7rem;">?</div><div><div style="font-size:0.85rem;">${r.to_username}</div><div class="friend-status pending">En attente...</div></div></div>`;
                outC.appendChild(d);
            });
        }

        document.getElementById('add-friend-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('friend-input');
            if(!input.value.trim()) return;
            const res = await fetch('/api/friends/request', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({toUsername: input.value.trim()})});
            const data = await res.json();
            friendNotif.innerText = data.ok ? "Envoy√© !" : data.error;
            friendNotif.style.color = data.ok ? "#22c55e" : "#ef4444";
            input.value = "";
            loadSocialData();
            setTimeout(() => friendNotif.innerText = "", 3000);
        });

        window.handleReq = async (id, act) => { await fetch(`/api/friends/requests/${id}/${act}`, {method:'POST'}); loadSocialData(); };

        window.openChat = (user) => {
            if(document.getElementById(`cw-${user}`)) return;
            const d = document.createElement('div'); d.className = 'chat-window'; d.id = `cw-${user}`;
            d.innerHTML = `<div class="chat-header" onclick="closeChat('${user}')"><span>${user}</span><span>‚úñ</span></div><div class="chat-body" id="msg-${user}"></div><form class="chat-input-area" onsubmit="sendM(event,'${user}')"><input type="text" placeholder="Message..." autocomplete="off"></form>`;
            chatContainer.appendChild(d);
            fetchM(user);
            activeChats[user] = setInterval(() => fetchM(user), 3000);
        };

        window.closeChat = (user) => { 
            const el = document.getElementById(`cw-${user}`); if(el) el.remove(); 
            if(activeChats[user]) { clearInterval(activeChats[user]); delete activeChats[user]; }
        };

        window.sendM = async (e, user) => {
            e.preventDefault(); const inp = e.target.querySelector('input'); if(!inp.value.trim()) return;
            await fetch('/api/messages', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({toUsername: user, content: inp.value.trim()})});
            inp.value = ""; fetchM(user);
        };

        async function fetchM(user) {
            const c = document.getElementById(`msg-${user}`); if(!c) return;
            const res = await fetch(`/api/messages/${user}`); const data = await res.json();
            c.innerHTML = data.messages.map(m => `<div class="msg ${m.fromSelf?'me':'them'}">${m.content}</div>`).join('');
            c.scrollTop = c.scrollHeight;
        }

        loadSocialData();
        setInterval(loadSocialData, 5000);

    })();
  </script>
</body>
</html>
