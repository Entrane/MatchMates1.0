<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Tableau de bord ‚Äì MatchMates</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />

  <style>
    :root {
      --primary-color: #22c55e;
      --sidebar-width: 320px;
      --bg-dark: #0f172a;
      --bg-card: #1e293b;
      --text-main: #f1f5f9;
      --text-muted: #94a3b8;
    }

    body {
        background-color: var(--bg-dark);
        color: var(--text-main);
        font-family: 'Inter', sans-serif;
        margin: 0;
    }

    /* --- LAYOUT PRINCIPAL --- */
    .dashboard-layout {
      max-width: 1200px;
      margin: 80px auto 0;
      padding: 0 20px;
    }
    
    header {
        display: flex; justify-content: space-between; align-items: center;
        padding: 15px 30px; background: rgba(30, 41, 59, 0.8);
        backdrop-filter: blur(10px); position: fixed; top: 0; width: 100%; z-index: 800;
        box-sizing: border-box; border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    nav a { color: var(--text-muted); text-decoration: none; margin-left: 20px; font-size: 0.9rem; }
    nav a:hover { color: white; }

    /* --- BOUTON TOGGLE FLOTTANT --- */
    .toggle-friends-btn {
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 1100; /* Au-dessus du bandeau */
      background: var(--primary-color);
      color: #020617;
      border: none;
      padding: 10px 16px;
      border-radius: 30px;
      cursor: pointer;
      display: flex; align-items: center; gap: 8px;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .toggle-friends-btn:hover { transform: translateY(-2px); }

    /* --- SIDEBAR (BANDEAU DROIT) --- */
    .friends-sidebar {
      position: fixed;
      top: 0;
      right: -340px; /* Cach√© compl√®tement */
      width: var(--sidebar-width);
      height: 100vh;
      background: rgba(15, 23, 42, 0.98);
      border-left: 1px solid rgba(255,255,255,0.1);
      box-shadow: -10px 0 30px rgba(0,0,0,0.5);
      padding: 80px 15px 20px; /* Espace pour le header */
      z-index: 1000;
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex; flex-direction: column; gap: 15px;
      backdrop-filter: blur(12px);
    }

    /* Quand actif, on le glisse √† 0 */
    .friends-sidebar.active { right: 0; }
    
    /* Le bouton bouge avec le bandeau */
    .friends-sidebar.active ~ .toggle-friends-btn { right: 280px; background: #ef4444; color: white; }
    .friends-sidebar.active ~ .toggle-friends-btn span { display: none; }
    .friends-sidebar.active ~ .toggle-friends-btn::after { content: "‚úï"; }

    /* --- CONTENU SIDEBAR --- */
    .sidebar-section-title {
        font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted);
        margin-top: 15px; margin-bottom: 5px; font-weight: 700; letter-spacing: 0.5px;
    }

    /* Carte Ami */
    .friend-card {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px; border-radius: 12px; background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: 0.2s;
    }
    .friend-card:hover { background: rgba(255,255,255,0.08); }
    
    .friend-avatar { width: 36px; height: 36px; border-radius: 50%; background: #3b82f6; display: flex; justify-content: center; align-items: center; font-weight: bold; color: white; margin-right: 10px; }
    .friend-info { display: flex; flex-direction: column; }
    .friend-name { font-size: 0.9rem; color: white; font-weight: 500; }
    .friend-status { font-size: 0.75rem; color: var(--primary-color); }
    .friend-status.pending { color: #fbbf24; } /* Jaune pour l'attente */

    /* Formulaire Ajout */
    .add-friend-box { display: flex; gap: 5px; }
    .add-friend-box input { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid #334155; border-radius: 20px; padding: 8px 12px; color: white; outline: none; }
    .add-friend-box button { background: var(--primary-color); border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center;}
    
    /* Messages erreurs/succ√®s */
    #friend-notif { font-size: 0.8rem; margin-top: 5px; min-height: 1.2em; }

    /* --- CHAT WINDOWS --- */
    .chat-container {
        position: fixed; bottom: 0; right: 360px; /* √Ä gauche du bandeau */
        display: flex; flex-direction: row-reverse; gap: 15px; z-index: 900; pointer-events: none;
    }
    /* Responsive: si √©cran petit, chat en bas √† droite classique */
    @media(max-width: 900px) { .chat-container { right: 10px; } }

    .chat-window {
        width: 300px; height: 400px; background: var(--bg-card);
        border-radius: 12px 12px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        display: flex; flex-direction: column; pointer-events: auto;
        border: 1px solid #334155; overflow: hidden;
    }
    .chat-header {
        background: #0f172a; padding: 10px 15px; cursor: pointer;
        display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155;
    }
    .chat-body { flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; background: #020617; }
    .chat-input-area { padding: 10px; background: #1e293b; border-top: 1px solid #334155; display: flex; }
    .chat-input-area input { flex: 1; padding: 8px; border-radius: 20px; border: none; background: #334155; color: white; outline: none; }

    .msg { padding: 6px 12px; border-radius: 12px; max-width: 80%; font-size: 0.85rem; line-height: 1.4; }
    .msg.me { align-self: flex-end; background: var(--primary-color); color: #020617; }
    .msg.them { align-self: flex-start; background: #334155; color: white; }

  </style>
</head>

<body data-current-username="{{ username }}">

  <header>
    <div style="font-weight: 800; font-size: 1.2rem;">MatchMates</div>
    <nav>
        <a href="/logout">D√©connexion</a>
    </nav>
  </header>

  <main class="dashboard-layout">
      <h1>Bienvenue, {{ username }} !</h1>
      <p style="color: var(--text-muted);">Ton tableau de bord est pr√™t.</p>
      
      <div style="padding: 40px; border: 1px dashed #334155; border-radius: 20px; margin-top: 20px; text-align: center;">
          Zone de contenu principale (Jeux, Stats, etc.)
      </div>
  </main>

  <button class="toggle-friends-btn" onclick="toggleSidebar()">
    <span>üí¨ Amis</span>
  </button>

  <aside class="friends-sidebar" id="friendsSidebar">
    <h2 style="margin: 0; font-size: 1.1rem;">Social</h2>

    <div class="sidebar-section-title">Ajouter un ami</div>
    <form class="add-friend-box" id="add-friend-form">
        <input type="text" id="friend-input" placeholder="Pseudo..." autocomplete="off">
        <button type="submit">+</button>
    </form>
    <div id="friend-notif"></div>

    <div id="section-requests-in" style="display:none;">
        <div class="sidebar-section-title">Demandes Re√ßues</div>
        <div id="list-requests-in"></div>
    </div>

    <div id="section-requests-out" style="display:none;">
        <div class="sidebar-section-title">En attente (Envoy√©es)</div>
        <div id="list-requests-out"></div>
    </div>

    <div class="sidebar-section-title">Mes Amis (<span id="friend-count">0</span>)</div>
    <div id="friends-list" style="overflow-y: auto; flex: 1;">
        <div style="text-align:center; color: var(--text-muted); font-size: 0.8rem; margin-top: 20px;">Aucun ami connect√©.</div>
    </div>
  </aside>

  <div id="chat-container" class="chat-container"></div>

  <script>
    // --- 1. GESTION SIDEBAR ---
    function toggleSidebar() {
        document.getElementById('friendsSidebar').classList.toggle('active');
    }

    // --- 2. LOGIQUE JS ---
    (function() {
        const friendNotif = document.getElementById('friend-notif');
        const chatContainer = document.getElementById('chat-container');
        
        // Variable globale pour suivre les chats ouverts
        // Stocke les ID d'intervalles pour pouvoir les stopper proprement
        const activeChats = {}; 

        // --- DATA LOADING ---
        async function loadData() {
            try {
                const [fRes, rRes] = await Promise.all([
                    fetch('/api/friends'),
                    fetch('/api/friends/requests')
                ]);
                const friendsData = await fRes.json();
                const requestsData = await rRes.json();

                renderFriends(friendsData.friends);
                renderRequests(requestsData.incoming, requestsData.outgoing);
            } catch(e) { console.error("Erreur loadData", e); }
        }

        // --- RENDU AMIS ---
        function renderFriends(list) {
            const container = document.getElementById('friends-list');
            document.getElementById('friend-count').innerText = list.length;
            container.innerHTML = "";

            if(list.length === 0) {
                container.innerHTML = '<div style="text-align:center; color: #64748b; font-size: 0.8rem; margin-top: 10px;">Pas encore d\'amis.</div>';
                return;
            }

            list.forEach(f => {
                const div = document.createElement('div');
                div.className = 'friend-card';
                div.onclick = () => openChat(f.username); // Clic pour ouvrir chat
                div.innerHTML = `
                    <div style="display:flex; align-items:center;">
                        <div class="friend-avatar">${f.username[0].toUpperCase()}</div>
                        <div class="friend-info">
                            <span class="friend-name">${f.username}</span>
                            <span class="friend-status">‚óè En ligne</span>
                        </div>
                    </div>
                    <span style="font-size:1.2rem; color: #475569;">üí¨</span>
                `;
                container.appendChild(div);
            });
        }

        // --- RENDU DEMANDES (IN & OUT) ---
        function renderRequests(incoming, outgoing) {
            // Incoming (Re√ßues)
            const inContainer = document.getElementById('list-requests-in');
            document.getElementById('section-requests-in').style.display = incoming.length ? 'block' : 'none';
            inContainer.innerHTML = "";
            incoming.forEach(req => {
                const div = document.createElement('div');
                div.className = 'friend-card';
                div.style.border = '1px solid #eab308'; // Bordure jaune
                div.innerHTML = `
                    <span class="friend-name">${req.from_username}</span>
                    <div>
                        <button onclick="handleRequest(${req.id}, 'accept')" style="background:#22c55e; border:none; border-radius:4px; cursor:pointer;">‚úî</button>
                        <button onclick="handleRequest(${req.id}, 'reject')" style="background:#ef4444; border:none; border-radius:4px; cursor:pointer; margin-left:5px;">‚úñ</button>
                    </div>
                `;
                inContainer.appendChild(div);
            });

            // Outgoing (Envoy√©es - SUIVI)
            const outContainer = document.getElementById('list-requests-out');
            document.getElementById('section-requests-out').style.display = outgoing.length ? 'block' : 'none';
            outContainer.innerHTML = "";
            outgoing.forEach(req => {
                const div = document.createElement('div');
                div.className = 'friend-card';
                div.style.cursor = 'default'; // Pas cliquable
                div.innerHTML = `
                    <div style="display:flex; align-items:center; opacity: 0.7;">
                        <div class="friend-avatar" style="background:#64748b; width:30px; height:30px; font-size:0.8rem;">?</div>
                        <div class="friend-info">
                            <span class="friend-name">${req.to_username}</span>
                            <span class="friend-status pending">En attente...</span>
                        </div>
                    </div>
                `;
                outContainer.appendChild(div);
            });
        }

        // --- ACTIONS (Ajout / R√©ponse) ---
        document.getElementById('add-friend-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('friend-input');
            const username = input.value.trim();
            if(!username) return;

            const res = await fetch('/api/friends/request', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({toUsername: username})
            });
            const data = await res.json();
            
            if(data.ok) {
                friendNotif.innerText = "Demande envoy√©e !";
                friendNotif.style.color = "#22c55e";
                input.value = "";
                loadData(); // Rafraichir pour voir la demande dans "Envoy√©es"
            } else {
                friendNotif.innerText = data.error;
                friendNotif.style.color = "#ef4444";
            }
            setTimeout(() => friendNotif.innerText = "", 3000);
        });

        window.handleRequest = async (id, action) => {
            await fetch(`/api/friends/requests/${id}/${action}`, { method: 'POST' });
            loadData();
        };

        // --- 3. CHAT SYSTEM (CORRIG√â) ---
        
        window.openChat = function(username) {
            // V√©rification : si d√©j√† ouvert, on ne fait rien
            if(document.getElementById(`chat-window-${username}`)) return;

            const chatDiv = document.createElement('div');
            chatDiv.className = 'chat-window';
            chatDiv.id = `chat-window-${username}`; // ID Unique CRUCIAL pour la fermeture
            
            chatDiv.innerHTML = `
                <div class="chat-header" onclick="closeChat('${username}')">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div class="friend-avatar" style="width:24px; height:24px; font-size:0.7rem;">${username[0]}</div>
                        <span>${username}</span>
                    </div>
                    <span>‚úñ</span>
                </div>
                <div class="chat-body" id="msgs-${username}">Chargement...</div>
                <form class="chat-input-area" onsubmit="sendMessage(event, '${username}')">
                    <input type="text" placeholder="Message..." autocomplete="off">
                </form>
            `;
            
            chatContainer.appendChild(chatDiv);

            // Lancer le chargement des messages
            fetchMessages(username);
            // Polling : rafraichir toutes les 3s
            activeChats[username] = setInterval(() => fetchMessages(username), 3000);
        };

        window.closeChat = function(username) {
            // 1. Trouver l'√©l√©ment
            const el = document.getElementById(`chat-window-${username}`);
            if(el) el.remove(); // 2. Le supprimer du DOM

            // 3. Arr√™ter le polling (intervalle) pour √©conomiser des ressources
            if(activeChats[username]) {
                clearInterval(activeChats[username]);
                delete activeChats[username];
            }
        };

        window.sendMessage = async (e, username) => {
            e.preventDefault();
            const input = e.target.querySelector('input');
            const content = input.value.trim();
            if(!content) return;

            await fetch('/api/messages', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({toUsername: username, content})
            });
            input.value = "";
            fetchMessages(username); // Refresh imm√©diat
        };

        async function fetchMessages(username) {
            const container = document.getElementById(`msgs-${username}`);
            if(!container) return; // Si fen√™tre ferm√©e entre temps

            const res = await fetch(`/api/messages/${username}`);
            const data = await res.json();
            
            container.innerHTML = data.messages.map(m => `
                <div class="msg ${m.fromSelf ? 'me' : 'them'}">
                    ${m.content}
                </div>
            `).join('');
            
            // Scroll en bas seulement si on n'est pas en train de lire plus haut (optionnel, ici on force le bas)
            container.scrollTop = container.scrollHeight;
        }

        // Init globale
        loadData();
        setInterval(loadData, 5000); // Rafraichir liste amis/demandes toutes les 5s
    })();
  </script>
</body>
</html>
