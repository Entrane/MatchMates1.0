<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Tableau de bord ‚Äì MatchMates</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />

  <style>
    :root {
      --primary-color: #22c55e;
      --sidebar-width: 320px;
      --bg-dark: #0f172a;
      --bg-card: #1e293b;
      --text-main: #f1f5f9;
      --text-muted: #94a3b8;
    }

    body {
        background-color: var(--bg-dark);
        color: var(--text-main);
        font-family: 'Inter', sans-serif;
        margin: 0;
        overflow-x: hidden;
    }

    /* --- LAYOUT PRINCIPAL --- */
    .dashboard-layout {
      max-width: 1100px;
      margin: 80px auto 40px;
      padding: 0 20px;
    }
    
    header {
        display: flex; justify-content: space-between; align-items: center;
        padding: 15px 30px; background: rgba(30, 41, 59, 0.9);
        backdrop-filter: blur(10px); position: fixed; top: 0; width: 100%; z-index: 800;
        box-sizing: border-box; border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    nav a { color: var(--text-muted); text-decoration: none; margin-left: 20px; font-size: 0.9rem; }
    nav a:hover { color: white; }

    /* --- SECTION TITRES --- */
    h2.section-title {
        font-size: 1.5rem; margin-bottom: 15px; border-left: 4px solid var(--primary-color);
        padding-left: 15px; color: white; display: flex; align-items: center; gap: 10px;
    }

    /* --- GRILLE FAVORIS --- */
    .favorites-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 20px;
        margin-bottom: 50px;
        min-height: 100px;
    }
    .empty-msg { grid-column: 1 / -1; text-align: center; color: var(--text-muted); font-style: italic; padding: 20px; border: 1px dashed #334155; border-radius: 10px; }

    /* --- STYLE CARTE JEU --- */
    .game-card {
        background: var(--bg-card); border-radius: 15px; overflow: hidden;
        position: relative; transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.05);
        aspect-ratio: 3/4;
    }
    .game-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
    .game-img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .game-overlay {
        position: absolute; bottom: 0; left: 0; width: 100%;
        background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
        padding: 60px 10px 15px; pointer-events: none;
    }
    .game-title { font-weight: 700; font-size: 1rem; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }

    /* Bouton Coeur */
    .heart-btn {
        position: absolute; top: 10px; right: 10px;
        background: rgba(0,0,0,0.5); border: none; border-radius: 50%;
        width: 35px; height: 35px; cursor: pointer; z-index: 10;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.2rem; color: white; transition: 0.2s; backdrop-filter: blur(4px);
    }
    .heart-btn:hover { background: rgba(255,255,255,0.2); transform: scale(1.1); }
    .heart-btn.active { color: #ef4444; text-shadow: 0 0 10px rgba(239, 68, 68, 0.5); }

    /* --- CARROUSEL CONTROLS (NOUVEAU) --- */
    .carousel-controls {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 15px; gap: 20px; flex-wrap: wrap;
    }
    
    /* Barre de recherche */
    .search-wrapper {
        position: relative; flex: 1; min-width: 200px;
    }
    .search-wrapper input {
        width: 100%; padding: 10px 15px 10px 40px;
        background: #1e293b; border: 1px solid #334155;
        border-radius: 25px; color: white; outline: none;
        font-size: 0.9rem; transition: 0.2s;
    }
    .search-wrapper input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2); }
    .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }

    /* Fl√®ches de navigation */
    .nav-buttons { display: flex; gap: 10px; }
    .nav-btn {
        background: #1e293b; border: 1px solid #334155; color: white;
        width: 40px; height: 40px; border-radius: 50%; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.2rem; transition: 0.2s;
    }
    .nav-btn:hover { background: var(--primary-color); border-color: var(--primary-color); color: #020617; }
    .nav-btn:active { transform: scale(0.95); }

    /* --- CARROUSEL --- */
    .carousel-container {
        position: relative; overflow: hidden; padding: 20px 0;
        /* Masque sur les c√¥t√©s pour effet fondu */
        mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
    }
    .carousel-track {
        display: flex; gap: 20px; width: max-content;
    }
    .carousel-item { width: 200px; flex-shrink: 0; }

    /* --- BOUTON SIDEBAR --- */
    .toggle-friends-btn {
      position: fixed; top: 80px; right: 20px; z-index: 1100;
      background: var(--primary-color); color: #020617; border: none;
      padding: 10px 16px; border-radius: 30px; cursor: pointer;
      display: flex; align-items: center; gap: 8px; font-weight: 600;
      box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* --- SIDEBAR --- */
    .friends-sidebar {
      position: fixed; top: 0; right: -340px; width: var(--sidebar-width); height: 100vh;
      background: rgba(15, 23, 42, 0.98); border-left: 1px solid rgba(255,255,255,0.1);
      box-shadow: -10px 0 30px rgba(0,0,0,0.5); padding: 80px 15px 20px; z-index: 1000;
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex; flex-direction: column; gap: 15px; backdrop-filter: blur(12px);
    }
    .friends-sidebar.active { right: 0; }
    .friends-sidebar.active ~ .toggle-friends-btn { right: 280px; background: #ef4444; color: white; }
    .friends-sidebar.active ~ .toggle-friends-btn span { display: none; }
    .friends-sidebar.active ~ .toggle-friends-btn::after { content: "‚úï"; }

    .sidebar-section-title { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-top: 15px; font-weight: 700; }
    .friend-card { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-radius: 12px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); cursor: pointer; margin-bottom: 5px;}
    .friend-card:hover { background: rgba(255,255,255,0.08); }
    .friend-avatar { width: 32px; height: 32px; border-radius: 50%; background: #3b82f6; display: flex; justify-content: center; align-items: center; font-weight: bold; margin-right: 10px; }
    .friend-status.pending { color: #fbbf24; }
    .add-friend-box { display: flex; gap: 5px; }
    .add-friend-box input { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid #334155; border-radius: 20px; padding: 6px 12px; color: white; outline: none; }
    .add-friend-box button { background: var(--primary-color); border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-weight: bold; }

    /* CHAT */
    .chat-container { position: fixed; bottom: 0; right: 360px; display: flex; flex-direction: row-reverse; gap: 15px; z-index: 900; pointer-events: none; }
    @media(max-width: 900px) { .chat-container { right: 10px; } }
    .chat-window { width: 300px; height: 400px; background: var(--bg-card); border-radius: 12px 12px 0 0; display: flex; flex-direction: column; pointer-events: auto; border: 1px solid #334155; }
    .chat-header { background: #0f172a; padding: 10px; cursor: pointer; display: flex; justify-content: space-between; border-bottom: 1px solid #334155; }
    .chat-body { flex: 1; padding: 10px; overflow-y: auto; background: #020617; display: flex; flex-direction: column; gap: 8px; }
    .chat-input-area { padding: 10px; background: #1e293b; border-top: 1px solid #334155; display: flex; }
    .chat-input-area input { flex: 1; padding: 8px; border-radius: 20px; border: none; background: #334155; color: white; outline: none; }
    .msg { padding: 6px 12px; border-radius: 12px; max-width: 80%; font-size: 0.85rem; }
    .msg.me { align-self: flex-end; background: var(--primary-color); color: #020617; }
    .msg.them { align-self: flex-start; background: #334155; color: white; }
  </style>
</head>

<body data-current-username="{{ username }}">

  <header>
    <div style="font-weight: 800; font-size: 1.2rem; display:flex; align-items:center; gap:10px;">
        <span style="color:var(--primary-color); font-size:1.5rem;">M</span> MatchMates
    </div>
    <nav>
        <a href="/logout">D√©connexion</a>
    </nav>
  </header>

  <main class="dashboard-layout">
      
      <h2 class="section-title">üíñ Mes Jeux Favoris</h2>
      <div id="favorites-container" class="favorites-grid">
          <div class="empty-msg">Chargement...</div>
      </div>

      <h2 class="section-title">üéÆ Tous les Jeux</h2>
      
      <div class="carousel-controls">
          <div class="search-wrapper">
              <span class="search-icon">üîç</span>
              <input type="text" id="game-search" placeholder="Rechercher (ex: Valorant)..." autocomplete="off">
          </div>
          <div class="nav-buttons">
              <button class="nav-btn" id="prev-btn">‚óÄ</button>
              <button class="nav-btn" id="next-btn">‚ñ∂</button>
          </div>
      </div>

      <div class="carousel-container" id="carousel-container">
          <div class="carousel-track" id="carousel-track">
              </div>
      </div>

  </main>

  <button class="toggle-friends-btn" onclick="toggleSidebar()">
    <span>üí¨ Amis</span>
  </button>

  <aside class="friends-sidebar" id="friendsSidebar">
    <h2 style="margin: 0; font-size: 1.1rem;">Social</h2>
    <div class="sidebar-section-title">Ajouter</div>
    <form class="add-friend-box" id="add-friend-form">
        <input type="text" id="friend-input" placeholder="Pseudo..." autocomplete="off">
        <button type="submit">+</button>
    </form>
    <div id="friend-notif" style="font-size:0.75rem; margin-top:5px; min-height:1em;"></div>
    <div id="section-requests-in" style="display:none;">
        <div class="sidebar-section-title">Re√ßues</div>
        <div id="list-requests-in"></div>
    </div>
    <div id="section-requests-out" style="display:none;">
        <div class="sidebar-section-title">Envoy√©es</div>
        <div id="list-requests-out"></div>
    </div>
    <div class="sidebar-section-title">Mes Amis (<span id="friend-count">0</span>)</div>
    <div id="friends-list" style="overflow-y: auto; flex: 1;"></div>
  </aside>

  <div id="chat-container" class="chat-container"></div>

  <script>
    function toggleSidebar() { document.getElementById('friendsSidebar').classList.toggle('active'); }

    (function() {
        /* =========================================
           1. CONFIG JEUX
           ========================================= */
        const ALL_GAMES = [
            { id: 'lol', name: 'League of Legends', img: 'https://placehold.co/300x400/16213e/fff?text=LoL' },
            { id: 'valorant', name: 'Valorant', img: 'https://placehold.co/300x400/ff4655/fff?text=Valorant' },
            { id: 'wow', name: 'World of Warcraft', img: 'https://placehold.co/300x400/f1c40f/000?text=WoW' },
            { id: 'minecraft', name: 'Minecraft', img: 'https://placehold.co/300x400/27ae60/fff?text=Minecraft' },
            { id: 'gta', name: 'GTA V', img: 'https://placehold.co/300x400/2c3e50/fff?text=GTA+V' },
            { id: 'rocket', name: 'Rocket League', img: 'https://placehold.co/300x400/2980b9/fff?text=Rocket+League' },
            { id: 'fortnite', name: 'Fortnite', img: 'https://placehold.co/300x400/8e44ad/fff?text=Fortnite' },
            { id: 'cod', name: 'Call of Duty', img: 'https://placehold.co/300x400/34495e/fff?text=CoD' },
            { id: 'apex', name: 'Apex Legends', img: 'https://placehold.co/300x400/e74c3c/fff?text=Apex' },
            { id: 'overwatch', name: 'Overwatch 2', img: 'https://placehold.co/300x400/e67e22/fff?text=Overwatch' },
            { id: 'csgo', name: 'CS:GO 2', img: 'https://placehold.co/300x400/333/fff?text=CS:GO+2' },
            { id: 'fifa', name: 'EA FC 24', img: 'https://placehold.co/300x400/222/fff?text=FC+24' },
        ];

        let favorites = JSON.parse(localStorage.getItem('mm_favorites')) || [];

        /* =========================================
           2. CARROUSEL & RECHERCHE
           ========================================= */
        const track = document.getElementById('carousel-track');
        const favContainer = document.getElementById('favorites-container');
        const searchInput = document.getElementById('game-search');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const carouselContainer = document.getElementById('carousel-container');

        let isFav = (id) => favorites.includes(id);
        let scrollAmount = 0;
        let isHovered = false;
        let isSearching = false;

        // G√©n√©ration HTML Carte
        function createCardHTML(game) {
    const active = isFav(game.id) ? 'active' : '';
    const heart = isFav(game.id) ? '‚ô•' : '‚ô°';
    
    // On ajoute onclick="goToGame('...')" sur la div principale
    return `
        <div class="game-card" onclick="window.location.href='/game/${game.id}'" style="cursor:pointer;">
            <img src="${game.img}" alt="${game.name}" class="game-img">
            <div class="game-overlay"><div class="game-title">${game.name}</div></div>
            
            <button class="heart-btn ${active}" onclick="event.stopPropagation(); window.toggleGameFav('${game.id}')">
                ${heart}
            </button>
        </div>
    `;
}

        // Rendu Favoris
        function renderFavs() {
            favContainer.innerHTML = "";
            if(favorites.length === 0) {
                favContainer.innerHTML = '<div class="empty-msg">Aucun favori. Ajoute des jeux ci-dessous !</div>';
            } else {
                favorites.forEach(fid => {
                    const g = ALL_GAMES.find(x => x.id === fid);
                    if(g) {
                        const d = document.createElement('div');
                        d.innerHTML = createCardHTML(g);
                        favContainer.appendChild(d);
                    }
                });
            }
        }

        // Rendu Carrousel (liste filtr√©e ou compl√®te)
        function renderCarousel(list = ALL_GAMES) {
            track.innerHTML = "";
            // Si recherche active, on affiche juste la liste (pas de doublon pour boucle)
            // Si pas de recherche, on double la liste pour effet infini
            const displayList = isSearching ? list : [...list, ...list];
            
            if(displayList.length === 0) {
                track.innerHTML = '<div style="color:#94a3b8; padding:20px;">Aucun jeu trouv√©.</div>';
                return;
            }

            displayList.forEach(g => {
                const d = document.createElement('div');
                d.className = 'carousel-item';
                d.innerHTML = createCardHTML(g);
                track.appendChild(d);
            });
        }

        // Action Toggle Favori
        window.toggleGameFav = (id) => {
            if(isFav(id)) favorites = favorites.filter(x => x !== id);
            else favorites.push(id);
            localStorage.setItem('mm_favorites', JSON.stringify(favorites));
            renderFavs();
            // Re-render carrousel pour mettre √† jour les coeurs, en gardant le filtre actuel
            const term = searchInput.value.toLowerCase().trim();
            const filtered = term ? ALL_GAMES.filter(g => g.name.toLowerCase().includes(term)) : ALL_GAMES;
            renderCarousel(filtered);
        };

        // --- LOGIQUE RECHERCHE ---
        searchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase().trim();
            if(term.length > 0) {
                isSearching = true;
                const filtered = ALL_GAMES.filter(g => g.name.toLowerCase().includes(term));
                renderCarousel(filtered);
                track.style.transform = `translateX(0px)`; // Reset position
            } else {
                isSearching = false;
                renderCarousel(ALL_GAMES);
            }
        });

        // --- LOGIQUE FL√àCHES ---
        prevBtn.addEventListener('click', () => {
            if(isSearching) return; // Pas de scroll manuel si filtre actif (liste courte)
            scrollAmount -= 300; // Reculer
            if(scrollAmount < 0) scrollAmount = 0; // Bloquer au d√©but
            track.style.transform = `translateX(-${scrollAmount}px)`;
        });

        nextBtn.addEventListener('click', () => {
            if(isSearching) return;
            scrollAmount += 300; // Avancer
            // Reset si trop loin (boucle simple)
            if(scrollAmount > track.scrollWidth / 2) scrollAmount = 0;
            track.style.transform = `translateX(-${scrollAmount}px)`;
        });

        // --- AUTO SCROLL ---
        carouselContainer.addEventListener('mouseenter', () => isHovered = true);
        carouselContainer.addEventListener('mouseleave', () => isHovered = false);

        function autoScrollLoop() {
            // On ne scroll pas si : souris dessus OU recherche active
            if (!isHovered && !isSearching) {
                scrollAmount += 0.8; // Vitesse
                if (scrollAmount >= track.scrollWidth / 2) {
                    scrollAmount = 0; // Retour au d√©but invisible
                }
                track.style.transform = `translateX(-${scrollAmount}px)`;
            }
            requestAnimationFrame(autoScrollLoop);
        }

        // Init
        renderFavs();
        renderCarousel(ALL_GAMES);
        autoScrollLoop();
    // ====================================================
    // --- D√âCLARATION DES VARIABLES GLOBALES ---
    // ====================================================
    const friendsSidebar = document.getElementById('friendsSidebar');
    const chatContainer = document.getElementById('chat-container'); 
    const friendNotif = document.getElementById('friend-notif');
    const friendsCount = document.getElementById('friendsCount');
    const receivedCount = document.getElementById('receivedCount');
    const sentCount = document.getElementById('sentCount');
    const activeChats = {}; 

    // ====================================================
    // --- 1. FONCTION DE BASCULE DE LA SIDEBAR (Amis) ---
    // ====================================================
    window.toggleSidebar = function() {
        const isActive = friendsSidebar.classList.toggle('active');
        const toggleBtn = document.querySelector('.toggle-friends-btn');
        
        toggleBtn.classList.toggle('active', isActive);
        
        if (!isActive) {
            Object.keys(activeChats).forEach(closeChat);
        }

        localStorage.setItem('socialSidebarActive', isActive);
    };

    // ====================================================
    // --- 2. LOGIQUE SOCIALE (Amis/Requests) ---
    // (Cette fonction est cl√© pour la synchro)
    // ====================================================
    async function loadSocial() {
        try {
            // R√©cup√®re les amis et les demandes en parall√®le (m√™me API que game.html)
            const [fRes, rRes] = await Promise.all([
                fetch('/api/friends'), 
                fetch('/api/friends/requests')
            ]);
            
            const fData = await fRes.json();
            const rData = await rRes.json();

            renderFriends(fData.friends || []);
            renderRequests(rData.incoming || []); 
            renderSent(rData.outgoing || []); 

        } catch (e) {
            console.error("Erreur chargement social:", e);
        }
    }

    // Fonctions de rendu (restent les m√™mes)
    function renderFriends(list) {
        const c = document.getElementById('friendsList');
        c.innerHTML = "";
        friendsCount.textContent = list.length;
        
        if (!list.length) {
            c.innerHTML = `<p style="text-align:center; color:var(--text-muted); font-size:0.9rem;">Ajoutez des amis !</p>`;
            return;
        }

        list.forEach(f => {
            const d = document.createElement('div');
            d.className = 'friend-card';
            d.onclick = () => openChat(f.username); 
            d.innerHTML = `
                <div style="display: flex; align-items: center;">
                    <div class="friend-avatar">${f.username.charAt(0).toUpperCase()}</div>
                    <span>${f.username}</span>
                </div>
            `;
            c.appendChild(d);
        });
    }

    function renderRequests(list) {
        const c = document.getElementById('requestsList');
        c.innerHTML = "";
        receivedCount.textContent = list.length;
        document.getElementById('receivedRequestsTitle').style.display = list.length ? 'block' : 'none';

        list.forEach(r => {
            const d = document.createElement('div');
            d.className = 'friend-card';
            d.innerHTML = `
                <div style="display: flex; align-items: center; flex-grow: 1;">
                    <div class="friend-avatar">${r.from_username.charAt(0).toUpperCase()}</div>
                    <span>${r.from_username}</span>
                </div>
                <div class="request-actions" style="display:flex; gap:5px;">
                    <button class="action-btn" style="padding: 5px 8px; font-size: 0.8rem; background: #10b981;" onclick="hReq(${r.id}, 'accept')"><i class="fas fa-check"></i></button>
                    <button class="action-btn" style="padding: 5px 8px; font-size: 0.8rem; background: #ef4444;" onclick="hReq(${r.id}, 'reject')"><i class="fas fa-times"></i></button>
                </div>
            `;
            c.appendChild(d);
        });
    }

    function renderSent(list) {
        const c = document.getElementById('sentList');
        c.innerHTML = "";
        sentCount.textContent = list.length;
        document.getElementById('sentRequestsTitle').style.display = list.length ? 'block' : 'none';

        list.forEach(r => {
            const d = document.createElement('div');
            d.className = 'friend-card';
            d.style.opacity = 0.7; 
            d.innerHTML = `
                <div style="display: flex; align-items: center; flex-grow: 1;">
                    <div class="friend-avatar">${r.to_username.charAt(0).toUpperCase()}</div>
                    <span style="font-style:italic;">${r.to_username} (En attente)</span>
                </div>
                <div class="request-actions">
                    <button class="action-btn" style="padding: 5px 8px; font-size: 0.8rem; background: #334155;" onclick="hReq(${r.id}, 'reject')"><i class="fas fa-minus-circle"></i></button>
                </div>
            `;
            c.appendChild(d);
        });
    }

    // G√®re l'envoi de la demande d'ami
    document.getElementById('add-friend-form').addEventListener('submit', async function(e) { 
        e.preventDefault(); 
        const input = document.getElementById('friend-input'); 
        
        const res = await fetch('/api/friends/request', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({toUsername:input.value})
        });
        const d = await res.json();
        
        // Mise √† jour imm√©diate de l'interface (synchro)
        loadSocial(); 
        
        friendNotif.innerText = d.ok ? `Demande envoy√©e √† ${input.value} !` : d.error || `Erreur: impossible d'envoyer la demande.`;
        input.value = "";
        setTimeout(()=>friendNotif.innerText="",3000); 
    });
    
    // G√®re l'acceptation/rejet d'une demande d'ami
    window.hReq = async(id, a) => { 
        await fetch(`/api/friends/requests/${id}/${a}`, {method:'POST'}); 
        // Mise √† jour imm√©diate de l'interface (synchro)
        loadSocial(); 
    };

    // ====================================================
    // --- 3. LOGIQUE DE CHAT (Identique √† game.html) ---
    // ====================================================

    async function fetchMessages(u) {
        const c = document.getElementById(`msg-${u}`);
        if (!c) return;

        const res = await fetch(`/api/messages/${u}`);
        const d = await res.json();
        
        const isScrolledToBottom = c.scrollHeight - c.clientHeight <= c.scrollTop + 1;
        
        c.innerHTML = d.messages.map(m =>
            `<div class="msg ${m.fromSelf ? 'self' : 'other'}">${m.content}</div>`
        ).join('');
        
        if (isScrolledToBottom || d.messages.length === 1) {
            c.scrollTop = c.scrollHeight;
        }
    }
    
    window.openChat = (u) => { 
        if(document.getElementById(`cw-${u}`)) return;
        const d=document.createElement('div'); d.className='chat-window'; d.id=`cw-${u}`;
        d.innerHTML=`
            <div class="chat-header" onclick="closeChat('${u}')">
                <span>${u}</span>
                <span><i class="fas fa-times"></i></span>
            </div>
            <div class="chat-body" id="msg-${u}"></div>
            <form class="chat-input-area" onsubmit="sM(event,'${u}')">
                <input type="text" placeholder="√âcrire un message..." autocomplete="off">
                <button type="submit"><i class="fas fa-paper-plane"></i></button>
            </form>
        `;
        chatContainer.appendChild(d); 
        fetchMessages(u); 
        activeChats[u]=setInterval(()=>fetchMessages(u),3000);
    };
    
    window.closeChat = (u) => { 
        const el=document.getElementById(`cw-${u}`); 
        if(el) el.remove(); 
        if(activeChats[u]){
            clearInterval(activeChats[u]);
            delete activeChats[u];
        } 
    };
    
    window.sM = async (e, u) => {
        e.preventDefault();
        const input = e.target.querySelector('input');
        if (!input.value.trim()) return; 

        await fetch('/api/messages', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ toUsername: u, content: input.value.trim() })
        });
        
        input.value = "";
        fetchMessages(u); 
    };

    // ====================================================
    // --- 4. INITIALISATION FINALE ---
    // ====================================================
    (async function() {
        // R√©tablit l'√©tat de la sidebar (Amis) au chargement
        if (localStorage.getItem('socialSidebarActive') === 'true') {
            friendsSidebar.classList.add('active');
            document.querySelector('.toggle-friends-btn').classList.add('active');
        }
        
        // Chargement des donn√©es sociales et rafra√Æchissement
        loadSocial();
        // Le rafra√Æchissement p√©riodique est CRUCIAL pour la synchro entre les pages.
        setInterval(loadSocial, 5000); 
    })();

</script>
  </script>
</body>
</html>
