<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Tableau de bord ‚Äì MatchMates</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Police Google -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <!-- Ton CSS global -->
  <link rel="stylesheet" href="style.css" />

  <!-- Styles sp√©cifiques carrousel jeux + amis + chat -->
  <style>
    :root {
      --card-radius: 22px;
    }

    /* Layout principale : contenu + bandeau amis */
    .dashboard-layout {
      display: flex;
      flex-direction: row-reverse; /* Met le bandeau amis √† droite */
      align-items: flex-start;
      gap: 24px;
      margin-top: 40px;
    }

    .dashboard-layout > section {
      flex: 1;
    }

    @media (max-width: 900px) {
      .dashboard-layout {
        flex-direction: column-reverse; /* Empile le contenu au-dessus des amis */
      }
    }

    /* SECTION JEUX */

    .games-section {
      margin-top: 32px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .games-section h2 {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .games-section small {
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    /* Bloc favoris */
    .favorites-box {
      background: rgba(10, 16, 28, 0.9);
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      padding: 14px 16px;
    }

    .favorites-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .favorites-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      min-height: 24px;
    }

    .favorite-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 0.75rem;
      color: #e5e7eb;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.15s ease;
    }

    .favorite-pill:hover {
      background: rgba(30, 64, 175, 0.95);
      transform: translateY(-1px);
    }

    .favorite-pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }

    .favorites-empty {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* Barre de recherche */
    .games-search {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .games-search-input-wrapper {
      position: relative;
      flex: 1;
    }

    .games-search-input-wrapper input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.9);
      padding: 9px 12px 9px 32px;
      font-size: 0.85rem;
      color: #e5e7eb;
      outline: none;
      transition: border 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    .games-search-input-wrapper input::placeholder {
      color: var(--text-muted);
    }

    .games-search-input-wrapper input:focus {
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.4);
      background: rgba(15, 23, 42, 1);
    }

    .games-search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    /* Carrousel */
    .games-carousel {
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.12), transparent),
                  radial-gradient(circle at bottom right, rgba(94, 234, 212, 0.11), transparent),
                  rgba(15, 23, 42, 0.95);
      border-radius: 26px;
      border: 1px solid rgba(15, 23, 42, 1);
      padding: 16px 18px 18px;
      overflow: hidden;
    }

    .games-carousel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
    }

    .carousel-controls {
      display: flex;
      gap: 6px;
    }

    .carousel-btn {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.15s ease, border-color 0.15s ease;
    }

    .carousel-btn:hover {
      background: rgba(30, 64, 175, 0.95);
      border-color: rgba(191, 219, 254, 0.8);
      transform: translateY(-1px);
    }

    .carousel-viewport {
      overflow: hidden;
    }

    .carousel-track {
      display: flex;
      gap: 16px;
      transition: transform 0.45s ease;
      will-change: transform;
    }

    .game-card {
      position: relative;
      flex: 0 0 230px;
      height: 140px;
      border-radius: var(--card-radius);
      overflow: hidden;
      background: #020617;
      border: 1px solid rgba(15, 23, 42, 1);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.75);
      cursor: pointer;
    }

    .game-gradient {
      position: absolute;
      inset: 0;
    }

    .game-fav-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid rgba(15, 23, 42, 0.9);
      background: rgba(15, 23, 42, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      color: #e5e7eb;
      cursor: pointer;
      z-index: 2;
      transition: background 0.15s ease, transform 0.15s ease, box-shadow 0.15s ease;
    }

    .game-fav-btn:hover {
      background: rgba(15, 118, 110, 0.95);
      transform: translateY(-1px);
      box-shadow: 0 0 0 1px rgba(45, 212, 191, 0.8);
    }

    .game-fav-btn.active {
      color: #facc15;
      box-shadow: 0 0 0 1px rgba(250, 204, 21, 0.8);
      background: rgba(15, 23, 42, 1);
    }

    .game-info {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 10px 12px 11px;
      background: linear-gradient(to top, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.65));
      backdrop-filter: blur(12px);
      z-index: 1;
    }

    .game-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: #f9fafb;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .game-tags {
      margin-top: 3px;
      font-size: 0.75rem;
      color: rgba(209, 213, 219, 0.9);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    @media (max-width: 900px) {
      .game-card {
        flex: 0 0 70%;
      }
    }

    @media (max-width: 600px) {
      .game-card {
        flex: 0 0 85%;
      }
    }

    /* BANDEAU LISTE D'AMIS */

    .friends-sidebar {
      width: 270px;
      background: rgba(10, 16, 28, 0.98);
      border-radius: 20px;
      border: 1px solid rgba(15, 23, 42, 1);
      padding: 16px 14px 14px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.85);
      position: sticky;
      top: 80px;
      max-height: calc(100vh - 120px);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .friends-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .friends-header h2 {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .friends-header small {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .friends-username {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .friends-username strong {
      color: #e5e7eb;
    }

    .friends-add-form {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }

    .friends-add-form input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.95);
      padding: 6px 10px;
      font-size: 0.8rem;
      color: #e5e7eb;
      outline: none;
    }

    .friends-add-form input::placeholder {
      color: var(--text-muted);
    }

    .friends-add-form button {
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #020617;
      font-size: 0.8rem;
      padding: 6px 10px;
      cursor: pointer;
      font-weight: 600;
      white-space: nowrap;
      transition: transform 0.1s ease, box-shadow 0.1s ease;
    }

    .friends-add-form button:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(34, 197, 94, 0.4);
    }

    .friends-error {
      font-size: 0.75rem;
      color: #f97316;
      min-height: 14px;
    }

    .friends-list {
      margin-top: 4px;
      overflow-y: auto;
      padding-right: 4px;
      flex: 1;
    }

    .friend-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 7px 9px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(30, 64, 175, 0.7);
      margin-bottom: 6px;
      cursor: pointer;
    }

    .friend-main {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }

    .friend-avatar {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: radial-gradient(circle at top left, #60a5fa, #1d4ed8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 600;
      color: #e5e7eb;
      flex-shrink: 0;
    }

    .friend-info {
      min-width: 0;
    }

    .friend-name {
      font-size: 0.82rem;
      color: #e5e7eb;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .friend-status {
      font-size: 0.7rem;
      color: #22c55e;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .friend-status-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }

    .friend-remove-btn {
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 0.8rem;
      cursor: pointer;
      padding: 3px 4px;
      border-radius: 999px;
      transition: background 0.1s ease, color 0.1s ease;
    }

    .friend-remove-btn:hover {
      background: rgba(30, 64, 175, 0.3);
      color: #fca5a5;
    }

    .friends-empty {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    @media (max-width: 900px) {
      .friends-sidebar {
        width: 100%;
        max-height: none;
        position: static;
      }
    }

    /* CHAT : fen√™tres flottantes fa√ßon Messenger */

    .chat-windows-container {
      position: fixed;
      bottom: 12px;
      right: 12px;
      display: flex;
      flex-direction: row-reverse;
      gap: 8px;
      z-index: 50;
      pointer-events: none; /* clics passent au travers sauf sur les fen√™tres */
    }

    .chat-window {
      width: 260px;
      background: rgba(10, 16, 28, 0.98);
      border-radius: 18px 18px 0 0;
      border: 1px solid rgba(31, 41, 55, 0.9);
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.9);
      display: flex;
      flex-direction: column;
      pointer-events: auto;
      overflow: hidden;
    }

    .chat-window-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 8px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      background: rgba(15, 23, 42, 1);
    }

    .chat-window-title {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      color: #e5e7eb;
    }

    .chat-window-title .avatar {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: radial-gradient(circle at top left, #60a5fa, #1d4ed8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
      color: #e5e7eb;
    }

    .chat-window-controls {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .chat-window-btn {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: none;
      background: rgba(15, 23, 42, 0.9);
      color: #9ca3af;
      font-size: 0.75rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chat-window-btn:hover {
      background: rgba(30, 64, 175, 0.9);
      color: #e5e7eb;
    }

    .chat-window-body {
      padding: 6px 6px 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .chat-window.minimized .chat-window-body {
      display: none;
    }

    .chat-messages {
      background: rgba(15, 23, 42, 0.95);
      border-radius: 10px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      padding: 8px;
      height: 170px;
      overflow-y: auto;
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .chat-message {
      max-width: 85%;
      padding: 4px 8px;
      border-radius: 10px;
      word-wrap: break-word;
    }

    .chat-message.me {
      align-self: flex-end;
      background: rgba(34, 197, 94, 0.15);
    }

    .chat-message.them {
      align-self: flex-start;
      background: rgba(30, 64, 175, 0.3);
    }

    .chat-message-time {
      display: block;
      font-size: 0.65rem;
      opacity: 0.6;
      margin-top: 1px;
    }

    .chat-form {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }

    .chat-form input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.95);
      padding: 6px 10px;
      font-size: 0.8rem;
      color: #e5e7eb;
      outline: none;
    }

    .chat-form input::placeholder {
      color: var(--text-muted);
    }

    .chat-form button {
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #020617;
      font-size: 0.8rem;
      padding: 6px 10px;
      cursor: pointer;
      font-weight: 600;
      white-space: nowrap;
    }

    /* Demandes d'amis */

    .friend-request-title {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin: 4px 0;
    }

    .friend-request-card {
      border-color: rgba(234, 179, 8, 0.7);
      cursor: default;
    }

    .friend-request-actions {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .friend-request-accept {
      border-radius: 999px;
      border: none;
      background: #16a34a;
      color: #020617;
      font-size: 0.75rem;
      padding: 3px 7px;
      cursor: pointer;
      font-weight: 600;
    }

    .friend-request-reject {
      border-radius: 999px;
      border: 1px solid rgba(248, 113, 113, 0.9);
      background: transparent;
      color: #fecaca;
      font-size: 0.75rem;
      padding: 3px 7px;
      cursor: pointer;
      font-weight: 500;
    }
  </style>
</head>

<body data-current-username="{{ username }}">
  <div class="page-wrapper">
    <!-- HEADER -->
    <header>
      <div class="logo">
        <div class="logo-mark">MM</div>
        <div class="logo-text">MatchMates</div>
      </div>

      <nav>
        <a href="dashboard.html">Tableau de bord</a>
        <a href="profile.html">Profil</a>
        <a href="#">Param√®tres</a>

        <span style="margin-left:auto; margin-right: 12px; color: var(--text-muted);">
          {{ username }}
        </span>

        <a href="/logout" class="btn btn-outline">D√©connexion</a>
      </nav>
    </header>

    <!-- CONTENU PRINCIPAL -->
    <main>
      <div class="dashboard-layout">
        <!-- Colonne principale -->
        <section>
          <h1 class="section-title">Tableau de bord</h1>
          <p class="section-subtitle">
            Ici, tu pourras voir un r√©sum√© rapide de ton activit√© MatchMates :
            derniers matchs, co√©quipiers r√©cents, jeux les plus jou√©s, et plus encore.
          </p>

          <div class="steps">
            <div class="step-card">
              <div class="step-icon">üéÆ</div>
              <div class="step-title">Activit√© r√©cente</div>
              <div class="step-text">
                Plus tard : historique de tes parties, co√©quipiers jou√©s r√©cemment, etc.
              </div>
            </div>

            <div class="step-card">
              <div class="step-icon">‚≠ê</div>
              <div class="step-title">Stats & progression</div>
              <div class="step-text">
                Plus tard : ton niveau par jeu, ton style de jeu, ton taux de victoire‚Ä¶
              </div>
            </div>

            <div class="step-card">
              <div class="step-icon">üë•</div>
              <div class="step-title">Co√©quipiers favoris</div>
              <div class="step-text">
                Plus tard : joueurs avec qui tu joues le plus et acc√®s rapide √† leur profil.
              </div>
            </div>
          </div>

          <!-- ====== SECTION JEUX / FAVORIS / CARROUSEL ====== -->
          <section class="games-section">
            <!-- Biblioth√®que de favoris -->
            <div class="favorites-box">
              <div class="favorites-header">
                <div>
                  <h2>Jeux suivis</h2>
                  <small>Ajoute des jeux √† tes favoris pour les retrouver rapidement.</small>
                </div>
                <small id="favorites-count">0 jeu en favoris</small>
              </div>
              <div id="favorites-list" class="favorites-list">
                <span class="favorites-empty">
                  Aucun favori pour l‚Äôinstant. Clique sur ‚òÖ sur un jeu pour l‚Äôajouter ici.
                </span>
              </div>
            </div>

            <!-- Barre de recherche -->
            <div class="games-search">
              <div class="games-search-input-wrapper">
                <span class="games-search-icon">üîç</span>
                <input
                  type="text"
                  id="game-search"
                  placeholder="Rechercher un jeu (nom, mode, type...)"
                  autocomplete="off"
                />
              </div>
            </div>

            <!-- Carrousel -->
            <div class="games-carousel">
              <div class="games-carousel-header">
                <div>
                  <h2>Jeux populaires</h2>
                  <small id="games-result-count"></small>
                </div>
                <div class="carousel-controls">
                  <button class="carousel-btn" id="carousel-prev" aria-label="Pr√©c√©dent">‚óÄ</button>
                  <button class="carousel-btn" id="carousel-next" aria-label="Suivant">‚ñ∂</button>
                </div>
              </div>

              <div class="carousel-viewport">
                <div class="carousel-track" id="games-track">
                  <!-- Cartes jeux inject√©es en JS -->
                </div>
              </div>
            </div>
          </section>
          <!-- ====== FIN SECTION JEUX ====== -->
        </section>

        <!-- BANDEAU LISTE D'AMIS -->
        <aside class="friends-sidebar">
          <div class="friends-header">
            <h2>Liste d‚Äôamis</h2>
            <small id="friends-count">0 ami</small>
          </div>

          <p class="friends-username">
            Connect√© en tant que <strong id="current-username">Utilisateur</strong>
          </p>

          <form id="add-friend-form" class="friends-add-form" autocomplete="off">
            <input
              type="text"
              id="friend-username"
              placeholder="Pseudo de ton ami"
            />
            <button type="submit">Ajouter</button>
          </form>
          <div id="friend-error" class="friends-error"></div>

          <button id="create-group-btn" class="btn btn-outline" style="width: 100%; margin-top: 12px;">Cr√©er une discussion de groupe</button>

          <div class="friends-list" id="groups-list" style="margin-top: 12px;">

          </div>

          <div class="friends-list" id="friends-list">
            <p class="friends-empty">Tu n‚Äôas encore aucun ami ajout√©.</p>
          </div>
        </aside>
      </div>
    </main>

    <!-- FOOTER -->
    <footer>
      <div class="footer-links">
        <a href="#">√Ä propos</a>
        <a href="#">Contact</a>
        <a href="#">Conditions d‚Äôutilisation</a>
        <a href="#">Confidentialit√©</a>
      </div>

      <div class="footer-socials">
        <div class="footer-pill">Rejoindre le Discord</div>
        <div class="footer-pill">Twitter</div>
        <div class="footer-pill">Instagram</div>
      </div>
    </footer>
  </div>

  <!-- Conteneur des fen√™tres de chat flottantes -->
  <div id="chat-windows-container" class="chat-windows-container"></div>

  <!-- Script carrousel / favoris / amis / chat -->
  <script>
    (function () {
      /* ========= GESTION JEUX / CARROUSEL ========= */

      const GAMES = [
        {
          id: "lol",
          name: "League of Legends",
          tags: ["MOBA", "Ranked", "Flex"],
          from: "#1d4ed8",
          to: "#22c55e",
        },
        {
          id: "valorant",
          name: "Valorant",
          tags: ["FPS", "Comp√©titif", "5v5"],
          from: "#b91c1c",
          to: "#7f1d1d",
        },
        {
          id: "wow",
          name: "World of Warcraft",
          tags: ["MMORPG", "Donjons", "Raids"],
          from: "#eab308",
          to: "#1d4ed8",
        },
        {
          id: "rocketleague",
          name: "Rocket League",
          tags: ["2v2", "3v3", "Ranked"],
          from: "#06b6d4",
          to: "#2563eb",
        },
        {
          id: "gta",
          name: "GTA Online / RP",
          tags: ["RP", "Heists", "Free roam"],
          from: "#ea580c",
          to: "#7c2d12",
        },
        {
          id: "amongus",
          name: "Among Us",
          tags: ["Party game", "Social"],
          from: "#db2777",
          to: "#7c3aed",
        },
      ];

      const FAVORITES_KEY = "matchmates_favorite_games";

      const track = document.getElementById("games-track");
      const searchInput = document.getElementById("game-search");
      const favoritesList = document.getElementById("favorites-list");
      const favoritesCount = document.getElementById("favorites-count");
      const resultCount = document.getElementById("games-result-count");
      const prevBtn = document.getElementById("carousel-prev");
      const nextBtn = document.getElementById("carousel-next");

      let favorites = [];
      let filteredGames = [...GAMES];
      let currentIndex = 0;
      let autoSlideInterval = null;

      function loadFavorites() {
        try {
          const raw = localStorage.getItem(FAVORITES_KEY);
          if (!raw) return;
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) {
            favorites = parsed;
          }
        } catch (e) {
          console.warn("Impossible de charger les favoris", e);
        }
      }

      function saveFavorites() {
        try {
          localStorage.setItem(FAVORITES_KEY, JSON.stringify(favorites));
        } catch (e) {
          console.warn("Impossible d‚Äôenregistrer les favoris", e);
        }
      }

      function isFavorite(id) {
        return favorites.includes(id);
      }

      function toggleFavorite(id) {
        if (isFavorite(id)) {
          favorites = favorites.filter((fid) => fid !== id);
        } else {
          favorites.push(id);
        }
        saveFavorites();
        renderFavorites();
        updateFavoriteButtonsState();
      }

      function renderFavorites() {
        favoritesList.innerHTML = "";

        if (!favorites.length) {
          favoritesList.innerHTML =
            '<span class="favorites-empty">Aucun favori pour l‚Äôinstant. Clique sur ‚òÖ sur un jeu pour l‚Äôajouter ici.</span>';
          favoritesCount.textContent = "0 jeu en favoris";
          return;
        }

        const favGames = GAMES.filter((g) => favorites.includes(g.id));
        favoritesCount.textContent =
          favGames.length + (favGames.length > 1 ? " jeux en favoris" : " jeu en favoris");

        favGames.forEach((game) => {
          const pill = document.createElement("button");
          pill.className = "favorite-pill";
          pill.type = "button";
          pill.innerHTML = '<span class="favorite-pill-dot"></span>' + game.name;

          pill.addEventListener("click", () => {
            searchInput.value = game.name;
            applySearch();
          });

          favoritesList.appendChild(pill);
        });
      }

      function createGameCard(game) {
        const card = document.createElement("div");
        card.className = "game-card";
        card.dataset.id = game.id;

        const gradient = document.createElement("div");
        gradient.className = "game-gradient";
        gradient.style.background = `linear-gradient(135deg, ${game.from}, ${game.to})`;
        card.appendChild(gradient);

        const favBtn = document.createElement("button");
        favBtn.type = "button";
        favBtn.className = "game-fav-btn";
        favBtn.innerHTML = "‚òÜ";
        favBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          toggleFavorite(game.id);
        });
        card.appendChild(favBtn);

        const info = document.createElement("div");
        info.className = "game-info";
        const title = document.createElement("div");
        title.className = "game-title";
        title.textContent = game.name;
        const tags = document.createElement("div");
        tags.className = "game-tags";
        tags.textContent = game.tags.join(" ¬∑ ");

        info.appendChild(title);
        info.appendChild(tags);
        card.appendChild(info);

        return card;
      }

      function renderGames() {
        track.innerHTML = "";
        filteredGames.forEach((game) => {
          track.appendChild(createGameCard(game));
        });
        updateFavoriteButtonsState();
        updateResultCount();
        resetCarouselPosition();
      }

      function updateFavoriteButtonsState() {
        const cards = track.querySelectorAll(".game-card");
        cards.forEach((card) => {
          const gameId = card.dataset.id;
          const btn = card.querySelector(".game-fav-btn");
          if (!btn) return;

          if (isFavorite(gameId)) {
            btn.classList.add("active");
            btn.innerHTML = "‚òÖ";
          } else {
            btn.classList.remove("active");
            btn.innerHTML = "‚òÜ";
          }
        });
      }

      function updateResultCount() {
        if (!filteredGames.length) {
          resultCount.textContent = "Aucun jeu trouv√©";
        } else if (filteredGames.length === GAMES.length) {
          resultCount.textContent = filteredGames.length + " jeux disponibles";
        } else {
          resultCount.textContent =
            filteredGames.length +
            (filteredGames.length > 1 ? " jeux correspondent √† la recherche" : " jeu correspond √† la recherche");
        }
      }

      function applySearch() {
        const q = searchInput.value.toLowerCase().trim();
        if (!q) {
          filteredGames = [...GAMES];
        } else {
          filteredGames = GAMES.filter((game) => {
            const inName = game.name.toLowerCase().includes(q);
            const inTags = game.tags.some((t) =>
              t.toLowerCase().includes(q)
            );
            return inName || inTags;
          });
        }
        renderGames();
      }

      searchInput.addEventListener("input", applySearch);

      function getCardStep() {
        const firstCard = track.querySelector(".game-card");
        if (!firstCard) return 0;

        const style = window.getComputedStyle(firstCard);
        const marginRight = parseFloat(style.marginRight) || 0;
        return firstCard.offsetWidth + marginRight;
      }

      function updateCarouselTransform() {
        const step = getCardStep();
        const offset = step * currentIndex;
        track.style.transform = "translateX(" + -offset + "px)";
      }

      function resetCarouselPosition() {
        currentIndex = 0;
        updateCarouselTransform();
        restartAutoSlide();
      }

      function goToNext() {
        if (!filteredGames.length) return;
        currentIndex = (currentIndex + 1) % filteredGames.length;
        updateCarouselTransform();
      }

      function goToPrev() {
        if (!filteredGames.length) return;
        currentIndex =
          currentIndex === 0 ? filteredGames.length - 1 : currentIndex - 1;
        updateCarouselTransform();
      }

      prevBtn.addEventListener("click", () => {
        goToPrev();
        restartAutoSlide();
      });

      nextBtn.addEventListener("click", () => {
        goToNext();
        restartAutoSlide();
      });

      function restartAutoSlide() {
        if (autoSlideInterval) clearInterval(autoSlideInterval);
        autoSlideInterval = setInterval(goToNext, 3500);
      }

      window.addEventListener("resize", () => {
        updateCarouselTransform();
      });

      loadFavorites();
      renderFavorites();
      renderGames();
      restartAutoSlide();

      /* ========= GESTION LISTE D'AMIS + DEMANDES + CHAT ========= */

      const friendsListEl = document.getElementById("friends-list");
      const friendsCount = document.getElementById("friends-count");
      const addFriendForm = document.getElementById("add-friend-form");
      const addFriendInput = document.getElementById("friend-username");
      const friendError = document.getElementById("friend-error");
      const currentUsernameEl = document.getElementById("current-username");

      const chatWindowsContainer = document.getElementById("chat-windows-container");

      // pseudo du joueur connect√©, inject√© via data-current-username
      const bodyUsername = document.body.getAttribute("data-current-username");
      const currentUsername = bodyUsername && bodyUsername.trim() ? bodyUsername.trim() : "Moi";
      currentUsernameEl.textContent = currentUsername;

      // conteneur pour les demandes d'amis
      const requestsContainer = document.createElement("div");
      requestsContainer.id = "friends-requests";
      friendsListEl.parentNode.insertBefore(requestsContainer, friendsListEl);

      let friends = [];
      const openChats = {}; // username -> { friend, windowEl, messagesEl, inputEl, form, intervalId }

      function showFriendError(message) {
        friendError.textContent = message || "";
      }

      function renderFriends() {
        friendsListEl.innerHTML = "";

        if (!friends.length) {
          friendsListEl.innerHTML =
            '<p class="friends-empty">Tu n‚Äôas encore aucun ami ajout√©.</p>';
          friendsCount.textContent = "0 ami";
          return;
        }

        friendsCount.textContent =
          friends.length + (friends.length > 1 ? " amis" : " ami");

        friends.forEach((friend) => {
          const card = document.createElement("div");
          card.className = "friend-card";

          // Ouverture du chat au clic sur la carte
          card.addEventListener("click", () => {
            openChat(friend);
          });

          const main = document.createElement("div");
          main.className = "friend-main";

          const avatar = document.createElement("div");
          avatar.className = "friend-avatar";
          avatar.textContent = friend.username.charAt(0).toUpperCase();

          const info = document.createElement("div");
          info.className = "friend-info";

          const name = document.createElement("div");
          name.className = "friend-name";
          name.textContent = friend.username;

          const status = document.createElement("div");
          status.className = "friend-status";
          status.innerHTML =
            '<span class="friend-status-dot"></span>En ligne';

          info.appendChild(name);
          info.appendChild(status);

          main.appendChild(avatar);
          main.appendChild(info);

          const removeBtn = document.createElement("button");
          removeBtn.className = "friend-remove-btn";
          removeBtn.type = "button";
          removeBtn.textContent = "‚úï";
          removeBtn.title = "Retirer cet ami";
          removeBtn.addEventListener("click", (e) => {
            e.stopPropagation(); // √©vite d'ouvrir le chat en cliquant sur la croix
            console.warn("Suppression d'ami non encore impl√©ment√©e c√¥t√© backend");
          });

          card.appendChild(main);
          card.appendChild(removeBtn);
          friendsListEl.appendChild(card);
        });
      }

      function renderFriendRequests(incoming, outgoing) {
        requestsContainer.innerHTML = "";

        if (!incoming.length && !outgoing.length) return;

        if (incoming.length) {
          const title = document.createElement("p");
          title.textContent = "Demandes re√ßues";
          title.className = "friend-request-title";
          requestsContainer.appendChild(title);

          incoming.forEach((req) => {
            const row = document.createElement("div");
            row.className = "friend-card friend-request-card";

            const txt = document.createElement("div");
            txt.className = "friend-name";
            txt.textContent = `${req.from_username} souhaite t‚Äôajouter`;

            const actions = document.createElement("div");
            actions.className = "friend-request-actions";

            const acceptBtn = document.createElement("button");
            acceptBtn.className = "friend-request-accept";
            acceptBtn.textContent = "‚úî";
            acceptBtn.title = "Accepter";
            acceptBtn.onclick = (e) => {
              e.stopPropagation();
              respondToRequest(req.id, true);
            };

            const rejectBtn = document.createElement("button");
            rejectBtn.className = "friend-request-reject";
            rejectBtn.textContent = "‚úï";
            rejectBtn.title = "Refuser";
            rejectBtn.onclick = (e) => {
              e.stopPropagation();
              respondToRequest(req.id, false);
            };

            actions.appendChild(acceptBtn);
            actions.appendChild(rejectBtn);

            row.appendChild(txt);
            row.appendChild(actions);
            requestsContainer.appendChild(row);
          });
        }

        if (outgoing.length) {
          const title = document.createElement("p");
          title.textContent = "Demandes envoy√©es";
          title.className = "friend-request-title";
          requestsContainer.appendChild(title);

          outgoing.forEach((req) => {
            const row = document.createElement("div");
            row.className = "friend-card friend-request-card";
            row.style.borderColor = "rgba(59,130,246,0.7)";

            const txt = document.createElement("div");
            txt.className = "friend-name";
            txt.textContent = `En attente : ${req.to_username}`;

            row.appendChild(txt);
            requestsContainer.appendChild(row);
          });
        }
      }

      async function respondToRequest(requestId, accept) {
        try {
          const res = await fetch(
            "/api/friends/requests/" + requestId + (accept ? "/accept" : "/reject"),
            { method: "POST" }
          );

          if (!res.ok) {
            console.error("Erreur r√©ponse √† la demande");
            return;
          }

          // Recharger amis + demandes
          loadFriendData();
        } catch (e) {
          console.error(e);
        }
      }

      addFriendForm.addEventListener("submit", async function (e) {
        e.preventDefault();
        const username = addFriendInput.value.trim();
        showFriendError("");

        if (!username) {
          showFriendError("Entre un pseudo pour ajouter un ami.");
          return;
        }

        if (username.toLowerCase() === currentUsername.toLowerCase()) {
          showFriendError("Tu ne peux pas t‚Äôajouter toi-m√™me üòÖ");
          return;
        }

        try {
          const res = await fetch("/api/friends/request", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ toUsername: username }),
          });

          const data = await res.json();

          if (!res.ok) {
            if (data.error === "user_not_found") {
              showFriendError("Cet utilisateur n‚Äôexiste pas.");
            } else if (data.error === "already_friends") {
              showFriendError("Vous √™tes d√©j√† amis.");
            } else if (data.error === "request_already_pending") {
              showFriendError("Une demande est d√©j√† en attente.");
            } else if (data.error === "cannot_add_self") {
              showFriendError("Tu ne peux pas t‚Äôajouter toi-m√™me.");
            } else {
              showFriendError("Erreur lors de l‚Äôenvoi de la demande.");
            }
            return;
          }

          addFriendInput.value = "";
          showFriendError("Demande envoy√©e ‚úÖ");
          loadFriendData();
        } catch (err) {
          console.error(err);
          showFriendError("Erreur r√©seau.");
        }
      });

      async function loadFriendData() {
        try {
          const [friendsRes, requestsRes] = await Promise.all([
            fetch("/api/friends"),
            fetch("/api/friends/requests"),
          ]);

          const friendsData = await friendsRes.json();
          const reqData = await requestsRes.json();

          friends = friendsData.friends || [];
          renderFriends();

          renderFriendRequests(reqData.incoming || [], reqData.outgoing || []);
        } catch (e) {
          console.error("Erreur chargement amis/demandes", e);
        }
      }

      /* ========= MESSAGERIE : fen√™tres multiples ========= */

      function renderMessages(chat, messages) {
        const el = chat.messagesEl;
        el.innerHTML = "";

        if (!messages.length) {
          el.innerHTML =
            '<p style="font-size: 0.75rem; color: var(--text-muted);">Aucun message pour le moment. Commence la conversation !</p>';
          return;
        }

        messages.forEach((m) => {
          const bubble = document.createElement("div");
          bubble.className = "chat-message " + (m.fromSelf ? "me" : "them");
          const text = document.createElement("div");
          text.textContent = m.content;

          const time = document.createElement("span");
          time.className = "chat-message-time";
          time.textContent = m.created_at
            ? new Date(m.created_at).toLocaleTimeString("fr-FR", {
                hour: "2-digit",
                minute: "2-digit",
              })
            : "";

          bubble.appendChild(text);
          bubble.appendChild(time);
          el.appendChild(bubble);
        });

        el.scrollTop = el.scrollHeight;
      }

      async function loadMessagesForChat(chat) {
        const isGroup = chat.friend.isGroup;
        const url = isGroup
          ? `/api/groups/${chat.friend.id}/messages`
          : `/api/messages/${encodeURIComponent(chat.friend.username)}`;

        try {
          const res = await fetch(url);
          const data = await res.json();

          if (!res.ok) {
            console.error("Erreur chargement messages", data);
            chat.messagesEl.innerHTML =
              '<p style="font-size: 0.75rem; color: #f97316;">Impossible de charger les messages.</p>';
            return;
          }

          renderMessages(chat, data.messages || []);
        } catch (e) {
          console.error(e);
          chat.messagesEl.innerHTML =
            '<p style="font-size: 0.75rem; color: #f97316;">Erreur r√©seau lors du chargement des messages.</p>';
        }
      }

      function startPolling(chat) {
        if (chat.intervalId) clearInterval(chat.intervalId);
        chat.intervalId = setInterval(() => {
          loadMessagesForChat(chat);
        }, 4000);
      }

      function toggleMinimize(chat) {
        chat.windowEl.classList.toggle("minimized");
      }

      function closeChat(chat) {
        if (chat.intervalId) clearInterval(chat.intervalId);
        if (chat.windowEl.parentNode) {
          chat.windowEl.parentNode.removeChild(chat.windowEl);
        }
        delete openChats[chat.friend.username];
      }

      async function sendMessage(chat, text) {
        const isGroup = chat.friend.isGroup;
        const url = isGroup ? `/api/groups/${chat.friend.id}/messages` : "/api/messages";
        const body = isGroup
          ? { content: text }
          : { toUsername: chat.friend.username, content: text };

        try {
          const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });

          const data = await res.json();

          if (!res.ok) {
            console.error("Erreur envoi message", data);
            return;
          }

          chat.inputEl.value = "";
          loadMessagesForChat(chat);
        } catch (e) {
          console.error(e);
        }
      }

      function createChatWindow(friend) {
        const windowEl = document.createElement("div");
        windowEl.className = "chat-window";

        const header = document.createElement("div");
        header.className = "chat-window-header";

        const title = document.createElement("div");
        title.className = "chat-window-title";

        const avatar = document.createElement("div");
        avatar.className = "avatar";
        avatar.textContent = friend.username.charAt(0).toUpperCase();

        const name = document.createElement("span");
        name.textContent = friend.username;

        title.appendChild(avatar);
        title.appendChild(name);

        const controls = document.createElement("div");
        controls.className = "chat-window-controls";

        const minimizeBtn = document.createElement("button");
        minimizeBtn.className = "chat-window-btn";
        minimizeBtn.textContent = "‚Äì";
        minimizeBtn.title = "R√©duire";

        const closeBtn = document.createElement("button");
        closeBtn.className = "chat-window-btn";
        closeBtn.textContent = "‚úï";
        closeBtn.title = "Fermer";

        controls.appendChild(minimizeBtn);
        controls.appendChild(closeBtn);

        header.appendChild(title);
        header.appendChild(controls);

        const body = document.createElement("div");
        body.className = "chat-window-body";

        const messagesEl = document.createElement("div");
        messagesEl.className = "chat-messages";

        const form = document.createElement("form");
        form.className = "chat-form";

        const input = document.createElement("input");
        input.type = "text";
        input.placeholder = "√âcrire un message...";
        input.autocomplete = "off";

        const sendBtn = document.createElement("button");
        sendBtn.type = "submit";
        sendBtn.textContent = "Envoyer";

        form.appendChild(input);
        form.appendChild(sendBtn);

        body.appendChild(messagesEl);
        body.appendChild(form);

        windowEl.appendChild(header);
        windowEl.appendChild(body);

        const chat = {
          friend,
          windowEl,
          messagesEl,
          inputEl: input,
          form,
          intervalId: null,
        };

        minimizeBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          toggleMinimize(chat);
        });

        closeBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          closeChat(chat);
        });

        form.addEventListener("submit", (e) => {
          e.preventDefault();
          const text = chat.inputEl.value.trim();
          if (!text) return;
          sendMessage(chat, text);
        });

        return chat;
      }

      function openChat(friend) {
        const key = friend.username;
        if (openChats[key]) {
          // mettre la fen√™tre au premier plan (tout √† droite)
          const existing = openChats[key].windowEl;
          if (existing.parentNode === chatWindowsContainer) {
            chatWindowsContainer.removeChild(existing);
            chatWindowsContainer.prepend(existing);
          }
          return;
        }

        const chat = createChatWindow(friend);
        openChats[key] = chat;
        chatWindowsContainer.prepend(chat.windowEl);

        loadMessagesForChat(chat);
        startPolling(chat);
      }

      // chargement initial de la liste d'amis + demandes
      loadFriendData();

      // rafra√Æchissement auto des amis & demandes toutes les 5s
      setInterval(loadFriendData, 5000);


      /* ========= GESTION GROUPES ========= */

      const createGroupBtn = document.getElementById("create-group-btn");
      const groupsListEl = document.getElementById("groups-list");

      async function loadGroups() {
        try {
          const res = await fetch("/api/groups");
          const data = await res.json();
          if (res.ok) {
            renderGroups(data.groups || []);
          }
        } catch (e) {
          console.error("Erreur chargement groupes", e);
        }
      }

      function renderGroups(groups) {
        groupsListEl.innerHTML = "";
        if (!groups.length) return;

        const title = document.createElement("p");
        title.textContent = "Discussions de groupe";
        title.className = "friend-request-title";
        groupsListEl.appendChild(title);

        groups.forEach(group => {
          const card = document.createElement("div");
          card.className = "friend-card";
          card.textContent = group.name;
          card.addEventListener("click", () => {
            openChat({ username: group.name, isGroup: true, id: group.id });
          });
          groupsListEl.appendChild(card);
        });
      }

      createGroupBtn.addEventListener("click", () => {
        const groupName = prompt("Nom du groupe :");
        if (!groupName || !groupName.trim()) return;

        // Pour l'instant, on ajoute tous les amis au groupe
        const memberIds = friends.map(f => f.id);

        fetch("/api/groups", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: groupName, members: memberIds }),
        })
        .then(res => res.json())
        .then(data => {
          if (data.ok) {
            loadGroups();
          }
        })
        .catch(err => console.error("Erreur cr√©ation groupe", err));
      });

      loadGroups();
      setInterval(loadGroups, 5000);
    })();
  </script>
</body>
</html>
