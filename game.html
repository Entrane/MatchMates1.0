<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Jeu ‚Äì MatchMates</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

  <style>
    /* On r√©utilise les m√™mes variables et styles de base pour la coh√©rence */
    :root { 
        --primary-color: #22c55e; 
        --sidebar-width: 320px; 
        --game-info-width: 280px; 
        --bg-dark: #0f172a; 
        --bg-card: #1e293b; 
        --text-main: #f1f5f9; 
        --text-muted: #94a3b8; 
    }
    body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Inter', sans-serif; margin: 0; overflow-x: hidden; }
    
    /* HEADER */
    header { display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(10px); position: fixed; top: 0; width: 100%; z-index: 800; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
    .logo { color: var(--primary-color); font-size: 1.5rem; font-weight: 800; text-decoration: none; }
    .nav-links a { color: var(--text-main); text-decoration: none; margin-left: 20px; font-weight: 500; transition: color 0.2s; }
    .nav-links a:hover { color: var(--primary-color); }
    .user-info { color: var(--text-main); font-weight: 500; }
    
    /* LAYOUT PRINCIPAL (Structure √† 2 zones avec Flexbox) */
    main { 
        padding-top: 80px; 
        display: flex;
        justify-content: flex-start;
        align-items: flex-start;
        min-height: calc(100vh - 80px); 
    }

    /* Bandeau d'information du jeu √† gauche (Statique) */
    .game-info-sidebar {
        width: var(--game-info-width);
        min-height: calc(100vh - 80px);
        background-color: #172031;
        padding: 20px;
        position: sticky;
        top: 80px;
        z-index: 700;
        border-right: 1px solid rgba(255,255,255,0.05);
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    /* Le contenu du jeu prend l'espace restant */
    .game-content-area {
        flex: 1; 
        padding: 20px 30px; 
        max-width: 800px; 
    }
    
    /* Structure 1 colonne */
    .game-settings-layout {
        display: flex; 
        gap: 30px;
        align-items: flex-start;
        flex-direction: column; /* Forcer en colonne pour la lisibilit√© */
    }
    .settings-column {
        width: 100%; 
    }


    /* CARD STYLING */
    .card { background-color: var(--bg-card); padding: 25px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); }
    .card h3 { color: var(--text-main); margin-top: 0; margin-bottom: 20px; font-weight: 600; font-size: 1.4rem; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 10px; }

    /* FORM / INPUTS */
    .checkbox-group { display: flex; align-items: center; margin-bottom: 15px; }
    .checkbox-group input[type="radio"], .checkbox-group input[type="checkbox"] { margin-right: 10px; width: 16px; height: 16px; border-radius: 4px; border: 1px solid var(--text-muted); background: transparent; appearance: none; cursor: pointer; position: relative; }
    .checkbox-group input:checked::before { content: '‚úì'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--primary-color); font-size: 14px; font-weight: bold; }
    .checkbox-group label { color: var(--text-main); font-size: 1rem; cursor: pointer; }
    .profile-controls { margin-bottom: 25px; display: flex; flex-direction: column; gap: 15px;}
    #ranked-options { margin-bottom: 10px; }

    /* RANK GRID */
    .rank-selector-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px; margin-top: 15px; }
    .rank-item { background-color: rgba(255,255,255,0.05); border: 2px solid transparent; border-radius: 8px; padding: 10px 5px; text-align: center; cursor: pointer; font-size: 0.8rem; font-weight: 500; transition: all 0.2s; }
    .rank-item:hover { border-color: rgba(255,255,255,0.2); }
    .rank-item.selected { border-color: var(--primary-color); background-color: rgba(34, 197, 94, 0.15); font-weight: 700; color: var(--primary-color); }
    .rank-item img { width: 30px; height: 30px; display: block; margin: 0 auto 5px; }

    /* BUTTONS */
    .action-btn { background-color: var(--primary-color); color: var(--bg-dark); border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; font-size: 1rem; }
    .action-btn:hover { background-color: #10b981; }
    .btn-secondary { background-color: var(--bg-card); color: var(--primary-color); border: 1px solid var(--primary-color); }
    .btn-secondary:hover { background-color: rgba(34, 197, 94, 0.1); }
    .action-btn:disabled { background-color: var(--text-muted); cursor: not-allowed; }

    /* --- BOUTON SIDEBAR --- */
    .toggle-friends-btn {
      position: fixed; top: 80px; right: 20px; z-index: 9999; 
      background: var(--primary-color); color: #020617; border: none;
      padding: 10px 16px; border-radius: 30px; cursor: pointer;
      display: flex; align-items: center; gap: 8px; font-weight: 600;
      box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* R√àGLES POUR LE BOUTON ACTIF */
    .toggle-friends-btn.active {
        /* D√©place le bouton vers la gauche: 320px (sidebar) + 20px (marge initiale) */
        right: calc(var(--sidebar-width) + 20px); 
        background: #ef4444; 
        color: white;
    }
    .toggle-friends-btn.active span {
        display: none; 
    }
    .toggle-friends-btn.active::after {
        content: "‚úï"; 
    }

    /* --- SIDEBAR SOCIALE (Amis) --- */
    .friends-sidebar {
      position: fixed; top: 0; 
      /* Position cach√©e: -320px (largeur de la sidebar) */
      right: calc(0px - var(--sidebar-width)); 
      width: var(--sidebar-width); height: 100vh;
      background: rgba(15, 23, 42, 0.98); border-left: 1px solid rgba(255,255,255,0.1);
      box-shadow: -10px 0 30px rgba(0,0,0,0.5); 
      padding: 80px 15px 20px; 
      z-index: 1000;
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex; flex-direction: column; gap: 15px; backdrop-filter: blur(12px);
      box-sizing: border-box; 
    }
    .friends-sidebar.active { right: 0; } /* R√©v√®le la sidebar */

    .sidebar-section-title { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-top: 15px; font-weight: 700; }
    .friend-card { 
        display: flex; align-items: center; justify-content: space-between; padding: 10px; 
        border-radius: 12px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); 
        cursor: pointer; margin-bottom: 5px;
    }
    .friend-card:hover { background: rgba(255,255,255,0.08); }
    .friend-avatar { 
        width: 32px; height: 32px; border-radius: 50%; background: #3b82f6; 
        display: flex; justify-content: center; align-items: center; font-weight: bold; 
        margin-right: 10px; color: white;
    }
    .add-friend-box { display: flex; gap: 5px; }
    .add-friend-box input { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid #334155; border-radius: 20px; padding: 6px 12px; color: white; outline: none; }
    .add-friend-box button { background: var(--primary-color); border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-weight: bold; color: var(--bg-dark);}

    /* CHAT CONTAINER & WINDOW */
    .chat-container { 
        position: fixed; bottom: 0; right: calc(20px); /* Position sans la sidebar */
        display: flex; flex-direction: row-reverse; gap: 15px; z-index: 900; 
        transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        pointer-events: none; /* Important pour laisser cliquer en dessous */
    }
    /* D√©place le chat lorsque la sidebar est ouverte */
    .friends-sidebar.active ~ .chat-container { 
        right: calc(var(--sidebar-width) + 20px); /* Position du chat AVEC la sidebar */
    }
    .chat-window {
        width: 300px; height: 400px; background: var(--bg-card); 
        border-radius: 12px 12px 0 0; display: flex; flex-direction: column;
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.4);
        pointer-events: auto; /* R√©tablit le clic sur la fen√™tre de chat */
    }
    .chat-header {
        padding: 10px 15px; background: var(--primary-color); color: var(--bg-dark); 
        font-weight: 600; cursor: pointer; display: flex;
        justify-content: space-between; align-items: center; border-radius: 10px 10px 0 0;
    }
    .chat-body {
        flex-grow: 1; overflow-y: auto; padding: 15px; 
        display: flex; flex-direction: column; gap: 8px; background: #141c2c;
    }
    .msg { max-width: 80%; padding: 8px 12px; border-radius: 16px; font-size: 0.9rem; word-wrap: break-word; }
    .msg.self { background: var(--primary-color); color: var(--bg-dark); align-self: flex-end; border-bottom-right-radius: 4px; }
    .msg.other { background: #334155; color: var(--text-main); align-self: flex-start; border-bottom-left-radius: 4px; }
    .chat-input-area { display: flex; padding: 10px; border-top: 1px solid #334155; }
    .chat-input-area input {
        flex-grow: 1; padding: 10px; border: 1px solid #334155; border-radius: 8px; 
        background: var(--bg-dark); color: var(--text-main); margin-right: 10px;
        outline: none;
    }
    .chat-input-area button {
        background: var(--primary-color); color: var(--bg-dark); border: none;
        width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1rem;
    }

  </style>
</head>
<body>

    <header>
        <a href="/dashboard" class="logo">MatchMates</a>
        <div class="nav-links">
            <a href="/dashboard">Dashboard</a>
            <a href="/profile">Profil</a>
            <a href="/logout">D√©connexion</a>
        </div>
    </header>

    <main>
        <div class="game-info-sidebar">
            <img id="game-image" src="/img/games/default.png" alt="Logo du Jeu" style="width: 100%; height: auto; border-radius: 8px; margin-bottom: 10px; object-fit: cover; aspect-ratio: 16/9;">
            <h2 id="game-short-name" style="margin: 0 0 5px; font-size: 1.8rem; font-weight: 700; color: var(--primary-color);">Chargement...</h2>
            <p id="game-description" style="color: var(--text-muted); font-size: 0.95rem; margin-top: 0;"> Description du jeu... </p>
            
            <button class="action-btn btn-secondary" id="favorite-btn" onclick="toggleFavorite()">
                <i class="far fa-star"></i> Ajouter aux favoris
            </button>
        </div>

        <div class="game-content-area">
            <h1 id="game-title" style="font-size: 2.5rem; margin-bottom: 30px;">Matchmaking</h1>
            
            <div class="game-settings-layout">
                
                <div class="settings-column">
                    <div class="card">
                        <h3>Mon Profil de Jeu</h3>
                        <div class="profile-controls">
                            <div style="display: flex; gap: 20px;">
                                <div class="checkbox-group">
                                    <input type="radio" id="ranked" name="mode" value="ranked" checked onchange="toggleRanks()">
                                    <label for="ranked">Class√©</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="radio" id="unrank" name="mode" value="unrank" onchange="toggleRanks()">
                                    <label for="unrank">Non-class√©</label>
                                </div>
                            </div>
                            
                            <div id="rank-selector">
                                <label style="display:block; margin-bottom:10px;">Mon Rang Actuel :</label>
                                <div id="rank-grid" class="rank-selector-grid">
                                    </div>
                            </div>
                            
                            <div class="checkbox-group">
                                <input type="checkbox" id="discord-vocal">
                                <label for="discord-vocal">Utiliser Discord Vocal</label>
                            </div>
                        </div>
                        
                        <button class="action-btn" id="publish-profile-btn" onclick="publishProfile()">
                            Publier mon profil de jeu
                        </button>
                        <p id="publish-status" style="text-align:center; font-size:0.9rem; margin-top:10px;"></p>
                    </div>
                </div>
                
                <div class="settings-column">
                    <div class="card">
                        <h3>Partenaire Recherch√©</h3>
                        <div class="profile-controls">
                            <div style="display: flex; gap: 20px;">
                                <div class="checkbox-group">
                                    <input type="radio" id="partner-ranked" name="partner-mode" value="ranked" checked onchange="togglePartnerRanks()">
                                    <label for="partner-ranked">Class√©</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="radio" id="partner-unrank" name="partner-mode" value="unrank" onchange="togglePartnerRanks()">
                                    <label for="partner-unrank">Non-class√©</label>
                                </div>
                            </div>
                            
                            <div id="partner-rank-selector">
                                <label style="display:block; margin-bottom:10px;">Rang Minimum Recherch√© :</label>
                                <div id="partner-rank-grid" class="rank-selector-grid">
                                    </div>
                            </div>
                            
                            <div class="checkbox-group">
                                <input type="checkbox" id="partner-discord-vocal" onchange="savePartnerPreferences()">
                                <label for="partner-discord-vocal">Partenaire avec Vocal requis</label>
                            </div>
                        </div>
                        
                        <button class="action-btn btn-secondary" onclick="savePartnerPreferences()">
                            <i class="fas fa-save"></i> Sauvegarder les crit√®res
                        </button>
                    </div>
                </div>

                <div class="settings-column">
                    <div class="card">
                        <h3>Trouver des co√©quipiers</h3>
                        <p style="color:var(--text-muted); font-size:0.9rem;"> Cliquez pour trouver des joueurs correspondant √† vos crit√®res. </p>
                        <button class="action-btn btn-primary" onclick="findPlayers()" style="width: 100%; margin-bottom: 20px;"> üöÄ Lancer la recherche </button>
                        
                        <div id="match-list">
                            <p style="text-align:center; color:var(--text-muted);"> Cliquez sur "Lancer la recherche" pour trouver des co√©quipiers. </p>
                        </div>
                        <p id="no-match-message" style="text-align:center; color:#eab308; display:none; font-weight: 500;"> üò≠ Aucun joueur ne correspond √† vos crit√®res pour le moment. </p>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <button class="toggle-friends-btn" onclick="toggleSidebar()">
        <i class="fas fa-users"></i> <span>Amis</span>
    </button>
    
    <aside class="friends-sidebar" id="friendsSidebar">
        <h2 style="margin: 0; font-size: 1.1rem; color: var(--primary-color);">Social</h2>
        
        <div class="sidebar-section-title">Ajouter</div>
        <form class="add-friend-box" id="add-friend-form">
            <input type="text" id="friend-input" placeholder="Pseudo..." autocomplete="off">
            <button type="submit"><i class="fas fa-user-plus"></i></button>
        </form>
        <div id="friend-notif" style="color:var(--primary-color); font-size: 0.8rem; margin-top: 5px;"></div>

        <div class="sidebar-section-title">Amis (<span id="friendsCount">0</span>)</div>
        <div id="friendsList">
            <p style="text-align:center; color:var(--text-muted); font-size:0.9rem;">Ajoutez des amis !</p>
        </div>

        <div class="sidebar-section-title" id="receivedRequestsTitle" style="display:none;">Demandes re√ßues (<span id="receivedCount">0</span>)</div>
        <div id="requestsList">
            </div>
        
        <div class="sidebar-section-title" id="sentRequestsTitle" style="display:none;">Demandes envoy√©es (<span id="sentCount">0</span>)</div>
        <div id="sentList">
            </div>

    </aside>
    
    <div id="chat-container" class="chat-container"></div>


    <script>
        // ====================================================
        // --- D√âCLARATION DES VARIABLES GLOBALES ---
        // ====================================================
        const activeChats = {}; 
        const gameId = '{{ gameId }}'; 
        const friendsSidebar = document.getElementById('friendsSidebar');
        const chatContainer = document.getElementById('chat-container'); 
        
        let currentRankSelection = null;
        let currentPartnerRankSelection = null;
        let isFavorite = false;

        // Fausse BDD pour info jeu (sera remplac√© par un fetch API plus tard)
        const GAME_INFOS = { 
            valorant: { name: "Valorant", description: "Jeu de tir tactique en 5v5 bas√© sur les personnages d√©velopp√© par Riot Games.", image: "/img/games/valorant.png" }, 
            leagueoflegends: { name: "League of Legends", description: "Jeu de strat√©gie en √©quipe o√π deux √©quipes de cinq puissants champions s'affrontent pour d√©truire la base adverse.", image: "/img/games/lol.png" }, 
            cs2: { name: "Counter-Strike 2", description: "La nouvelle √®re du jeu de tir √† la premi√®re personne embl√©matique.", image: "/img/games/cs2.png" } 
        };
        
        // Simule les rangs (Doit correspondre aux images sur le serveur)
        const RANKS = { 
            valorant: [
                { name: 'Fer', img: 'fer.png' }, { name: 'Bronze', img: 'bronze.png' }, 
                { name: 'Argent', img: 'argent.png' }, { name: 'Or', img: 'or.png' }, 
                { name: 'Platine', img: 'platine.png' }, { name: 'Diamant', img: 'diamant.png' }, 
                { name: 'Ascendant', img: 'ascendant.png' }, { name: 'Immortel', img: 'immortel.png' }, 
                { name: 'Radiant', img: 'radiant.png' }, 
            ],
            cs2: [ /* ... */ ], 
            leagueoflegends: [ /* ... */ ]
        }; 

        // ====================================================
        // --- 1. FONCTIONS DE BASES POUR LES CARTES DE JEU ---
        // ====================================================
        
        function setupRankGrids(gameRanks) {
            const playerGrid = document.getElementById('rank-grid');
            const partnerGrid = document.getElementById('partner-rank-grid');
            playerGrid.innerHTML = '';
            partnerGrid.innerHTML = '';

            gameRanks.forEach(rank => {
                playerGrid.appendChild(buildRankItem(rank, 'player'));
                partnerGrid.appendChild(buildRankItem(rank, 'partner'));
            });
        }

        function buildRankItem(rank, type) {
            const item = document.createElement('div');
            item.className = 'rank-item';
            item.setAttribute('data-rank', rank.name);
            item.onclick = (e) => selectRank(e, type);
            
            const gameName = gameId.toLowerCase();
            const imgName = rank.img;
            const rankName = rank.name;

            item.innerHTML = `
                <img src="/img/ranks/${gameName}/${imgName}" alt="${rankName}" onerror="this.onerror=null;this.src='/img/ranks/default.png';">
                <span>${rankName}</span>
            `;
            return item;
        }

        function selectRank(event, type) {
            const target = event.currentTarget;
            const rank = target.getAttribute('data-rank');
            const gridId = type === 'player' ? 'rank-grid' : 'partner-rank-grid';
            
            document.querySelectorAll(`#${gridId} .rank-item`).forEach(item => {
                item.classList.remove('selected');
            });
            target.classList.add('selected');
            
            if (type === 'player') {
                currentRankSelection = target;
                saveGameSettings();
            } else {
                currentPartnerRankSelection = target;
                savePartnerPreferences();
            }
        }
        
        window.toggleRanks = function(save = true) {
            const rankedChecked = document.getElementById('ranked').checked;
            const rankSelector = document.getElementById('rank-selector');
            rankSelector.style.display = rankedChecked ? 'block' : 'none';
            if (save) saveGameSettings();
        }
        
        window.togglePartnerRanks = function(save = true) {
            const partnerRankedChecked = document.getElementById('partner-ranked').checked;
            const partnerRankSelector = document.getElementById('partner-rank-selector');
            partnerRankSelector.style.display = partnerRankedChecked ? 'block' : 'none';
            if (save) savePartnerPreferences();
        }

        // --- Fonctions de chargement/sauvegarde de la page de jeu ---
        
        async function loadGameSettings() {
            // Logique pour charger les r√©glages du profil de jeu de l'utilisateur
            // depuis /api/game-settings/{{ gameId }}
            // ...
        }

        async function saveGameSettings() {
            // Logique pour sauvegarder les r√©glages du profil de jeu de l'utilisateur
            // vers /api/game-settings
            // ...
        }
        
        async function loadPartnerPreferences() {
            try {
                const res = await fetch(`/api/partner-preferences/${gameId}`);
                const prefs = await res.json();
                
                // Assurez-vous que les √©l√©ments existent avant d'essayer d'acc√©der √† .checked/.value
                const partnerRankedRadio = document.getElementById('partner-ranked');
                const partnerUnrankRadio = document.getElementById('partner-unrank');
                
                if(prefs.mode === 'ranked') {
                    partnerRankedRadio.checked = true;
                    partnerUnrankRadio.checked = false;
                } else {
                    partnerRankedRadio.checked = false;
                    partnerUnrankRadio.checked = true;
                }
                
                document.getElementById('partner-discord-vocal').checked = prefs.vocal_required;
                togglePartnerRanks(false); 
                
                if (prefs.min_rank && prefs.mode === 'ranked') {
                    const rankItem = document.querySelector(`#partner-rank-grid [data-rank="${prefs.min_rank}"]`);
                    if (rankItem) {
                        rankItem.classList.add('selected');
                        currentPartnerRankSelection = rankItem;
                    }
                }

            } catch (e) {
                console.error("Erreur chargement des pr√©f√©rences partenaire:", e);
                document.getElementById('partner-ranked').checked = true;
                document.getElementById('partner-discord-vocal').checked = false;
                togglePartnerRanks(false);
            }
        }
        
        async function savePartnerPreferences() {
            const mode = document.getElementById('partner-ranked').checked ? 'ranked' : 'unrank';
            const rank = currentPartnerRankSelection ? currentPartnerRankSelection.getAttribute('data-rank') : null;
            const vocal = document.getElementById('partner-discord-vocal').checked;
            
            await fetch('/api/partner-preferences', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    gameId: gameId,
                    mode: mode,
                    min_rank: rank,
                    vocal_required: vocal
                })
            });
        }
        
        // ... (Autres fonctions comme publishProfile, findPlayers, renderMatches, etc.)

        // ====================================================
        // --- 2. FONCTION DE BASCULE DE LA SIDEBAR (Amis) ---
        // (Assure le fonctionnement du bouton)
        // ====================================================
        window.toggleSidebar = function() {
            const isActive = friendsSidebar.classList.toggle('active');
            const toggleBtn = document.querySelector('.toggle-friends-btn');
            
            // Bascule la classe 'active' sur le bouton pour le style/ic√¥ne
            toggleBtn.classList.toggle('active', isActive);
            
            // Si la sidebar est ferm√©e, on ferme aussi tous les chats actifs.
            if (!isActive) {
                Object.keys(activeChats).forEach(closeChat);
            }

            // Sauvegarde l'√©tat dans le stockage local
            localStorage.setItem('socialSidebarActive', isActive);
        };
        
        // ====================================================
        // --- 3. LOGIQUE SOCIALE (Amis/Requests) ---
        // ====================================================

        async function loadSocial() {
            try {
                const friendNotif = document.getElementById('friend-notif');
                const [fRes, rRes] = await Promise.all([fetch('/api/friends'), fetch('/api/friends/requests')]);
                const fData = await fRes.json();
                const rData = await rRes.json();

                renderFriends(fData.friends || []);
                renderRequests(rData.incoming || []); 
                renderSent(rData.outgoing || []); 

            } catch (e) {
                console.error("Erreur chargement social:", e);
            }
        }

        function renderFriends(list) {
            const c = document.getElementById('friendsList');
            c.innerHTML = "";
            document.getElementById('friendsCount').textContent = list.length;
            
            if (!list.length) {
                c.innerHTML = `<p style="color:var(--text-muted); text-align:center; font-size:0.9rem;">Ajoutez des amis !</p>`;
                return;
            }

            list.forEach(f => {
                const d = document.createElement('div');
                d.className = 'friend-card';
                d.onclick = () => openChat(f.username); 
                d.innerHTML = `
                    <div style="display: flex; align-items: center;">
                        <div class="friend-avatar">${f.username.charAt(0).toUpperCase()}</div>
                        <span>${f.username}</span>
                    </div>
                `;
                c.appendChild(d);
            });
        }

        function renderRequests(list) {
            const c = document.getElementById('requestsList');
            c.innerHTML = "";
            document.getElementById('receivedCount').textContent = list.length;
            document.getElementById('receivedRequestsTitle').style.display = list.length ? 'block' : 'none';

            list.forEach(r => {
                const d = document.createElement('div');
                d.className = 'friend-card';
                d.innerHTML = `
                    <div style="display: flex; align-items: center; flex-grow: 1;">
                        <div class="friend-avatar">${r.from_username.charAt(0).toUpperCase()}</div>
                        <span>${r.from_username}</span>
                    </div>
                    <div class="request-actions" style="display:flex; gap:5px;">
                        <button class="action-btn" style="padding: 5px 8px; font-size: 0.8rem; background: #10b981;" onclick="hReq(${r.id}, 'accept')"><i class="fas fa-check"></i></button>
                        <button class="action-btn" style="padding: 5px 8px; font-size: 0.8rem; background: #ef4444;" onclick="hReq(${r.id}, 'reject')"><i class="fas fa-times"></i></button>
                    </div>
                `;
                c.appendChild(d);
            });
        }

        function renderSent(list) {
            const c = document.getElementById('sentList');
            c.innerHTML = "";
            document.getElementById('sentCount').textContent = list.length;
            document.getElementById('sentRequestsTitle').style.display = list.length ? 'block' : 'none';

            list.forEach(r => {
                const d = document.createElement('div');
                d.className = 'friend-card';
                d.style.opacity = 0.7; 
                d.innerHTML = `
                    <div style="display: flex; align-items: center; flex-grow: 1;">
                        <div class="friend-avatar">${r.to_username.charAt(0).toUpperCase()}</div>
                        <span style="font-style:italic;">${r.to_username} (En attente)</span>
                    </div>
                    <div class="request-actions">
                        <button class="action-btn" style="padding: 5px 8px; font-size: 0.8rem; background: #334155;" onclick="hReq(${r.id}, 'reject')"><i class="fas fa-minus-circle"></i></button>
                    </div>
                `;
                c.appendChild(d);
            });
        }

        // G√®re l'envoi de la demande d'ami
        document.getElementById('add-friend-form').addEventListener('submit', async function(e) { 
            e.preventDefault(); 
            const input = document.getElementById('friend-input'); 
            const friendNotif = document.getElementById('friend-notif');
            
            const res = await fetch('/api/friends/request', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({toUsername:input.value})
            });
            const d = await res.json();
            friendNotif.innerText = d.ok ? `Demande envoy√©e √† ${input.value} !` : d.error || `Erreur: impossible d'envoyer la demande.`;
            input.value = "";
            loadSocial();
            setTimeout(()=>friendNotif.innerText="",3000); 
        });
        
        // G√®re l'acceptation/rejet d'une demande d'ami
        window.hReq = async(id, a) => { 
            await fetch(`/api/friends/requests/${id}/${a}`, {method:'POST'}); 
            loadSocial(); 
        };

        // ====================================================
        // --- 4. LOGIQUE DE CHAT ---
        // ====================================================
        
        async function fetchMessages(u) {
            const c = document.getElementById(`msg-${u}`);
            if (!c) return;

            const res = await fetch(`/api/messages/${u}`);
            const d = await res.json();
            
            const isScrolledToBottom = c.scrollHeight - c.clientHeight <= c.scrollTop + 1;
            
            c.innerHTML = d.messages.map(m =>
                `<div class="msg ${m.fromSelf ? 'self' : 'other'}">${m.content}</div>`
            ).join('');
            
            if (isScrolledToBottom || d.messages.length === 1) {
                c.scrollTop = c.scrollHeight;
            }
        }
        
        window.openChat = (u) => { 
            if(document.getElementById(`cw-${u}`)) return;
            const d=document.createElement('div'); d.className='chat-window'; d.id=`cw-${u}`;
            d.innerHTML=`
                <div class="chat-header" onclick="closeChat('${u}')">
                    <span>${u}</span>
                    <span><i class="fas fa-times"></i></span>
                </div>
                <div class="chat-body" id="msg-${u}"></div>
                <form class="chat-input-area" onsubmit="sM(event,'${u}')">
                    <input type="text" placeholder="√âcrire un message..." autocomplete="off">
                    <button type="submit"><i class="fas fa-paper-plane"></i></button>
                </form>
            `;
            chatContainer.appendChild(d); 
            fetchMessages(u); 
            activeChats[u]=setInterval(()=>fetchMessages(u),3000);
        };
        
        window.closeChat = (u) => { 
            const el=document.getElementById(`cw-${u}`); 
            if(el) el.remove(); 
            if(activeChats[u]){
                clearInterval(activeChats[u]);
                delete activeChats[u];
            } 
        };
        
        window.sM = async (e, u) => {
            e.preventDefault();
            const input = e.target.querySelector('input');
            if (!input.value.trim()) return; 

            await fetch('/api/messages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ toUsername: u, content: input.value.trim() })
            });
            
            input.value = "";
            fetchMessages(u); 
        };
        
        // ====================================================
        // --- 5. INITIALISATION FINALE ---
        // ====================================================
        (async function() {
            // Initialisation des grilles de rangs
            const gameRanks = RANKS[gameId.toLowerCase()] || RANKS.valorant;
            setupRankGrids(gameRanks); 

            // Chargement des donn√©es 
            await loadGameInfo();
            loadGameSettings();
            await loadPartnerPreferences();
            
            // R√©tablit l'√©tat de la sidebar (Amis) au chargement
            if (localStorage.getItem('socialSidebarActive') === 'true') {
                friendsSidebar.classList.add('active');
                document.querySelector('.toggle-friends-btn').classList.add('active');
            }
            
            // Chargement des donn√©es sociales et rafra√Æchissement
            loadSocial();
            setInterval(loadSocial, 5000); 
        })();

    </script>
</body>
</html>
