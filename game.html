<!DOCTYPE html>
<html lang="fr">
<head>
    <style>
        /* ... (CSS inchang√©) ... */

        /* Bouton pour basculer la sidebar */
        #sidebar-toggle {
            position: fixed; 
            right: var(--sidebar-width); 
            top: 150px;
            z-index: 701;
            background: var(--bg-card);
            color: var(--primary-color);
            border: 1px solid rgba(255,255,255,0.1);
            border-right: none;
            padding: 8px 12px;
            border-radius: 8px 0 0 8px;
            cursor: pointer;
            transition: right 0.3s ease; /* Changement ici: on utilise 'right' pour le mouvement */
        }
        .social-sidebar.collapsed + #sidebar-toggle {
            right: 0px; /* Le bouton se positionne sur le bord de l'√©cran */
        }
        /* ... (Reste du CSS inchang√©) ... */
    </style>
</head>
<body>
    <header>
        </header>

    <main>
        
        <div class="game-info-sidebar">
            <img id="game-image" src="/img/games/default.png" alt="Logo du Jeu" 
                 style="width: 100%; height: auto; border-radius: 8px; margin-bottom: 10px; object-fit: cover; aspect-ratio: 16/9;">

            <h2 id="game-short-name" style="margin: 0 0 5px; font-size: 1.8rem; font-weight: 700; color: var(--primary-color);">Chargement...</h2>
            
            <p id="game-description" style="color: var(--text-muted); font-size: 0.95rem; margin-top: 0;">
                Description du jeu...
            </p>

            <button class="action-btn btn-secondary" id="favorite-toggle-btn" onclick="toggleFavorite()" style="width: 100%; font-size: 0.9rem; padding: 10px;">
                ‚≠ê Charger...
            </button>
        </div>
        
        <div class="game-content-area">
            <div class="game-settings-layout">
                <div class="settings-column" style="flex: 1;">
                    
                    <div class="card">
                        <h3>Ton profil de joueur</h3>
                        <div class="profile-controls">
                            <div id="ranked-options" style="display: flex; gap: 20px;">
                                <div class="checkbox-group">
                                    <input type="radio" id="ranked" name="mode" value="ranked" onchange="toggleRanks(true)">
                                    <label for="ranked">Class√©</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="radio" id="unrank" name="mode" value="unrank" onchange="toggleRanks(true)">
                                    <label for="unrank">Non class√©</label>
                                </div>
                            </div>
                            
                            <div class="checkbox-group">
                                <input type="checkbox" id="discord-vocal" onchange="saveGameSettings()">
                                <label for="discord-vocal">Vocal Discord</label>
                            </div>
                        </div>

                        <div id="rank-selector" style="display: none;">
                            <div class="sidebar-section-title" style="margin-top:0; color: #cbd5e1; font-size: 0.9rem;">Mon rang actuel</div>
                            <div id="rank-grid" class="rank-selector-grid">
                                </div>
                        </div>

                        </div>

                    <div class="card" id="partner-profile-card">
                        <h3>üéØ Les joueurs que tu recherches</h3>
                        <div class="profile-controls">
                            <div id="partner-ranked-options" style="display: flex; gap: 20px;">
                                <div class="checkbox-group">
                                    <input type="radio" id="partner-ranked" name="partner-mode" value="ranked" onchange="togglePartnerRanks(true)">
                                    <label for="partner-ranked">Class√©</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="radio" id="partner-unrank" name="partner-mode" value="unrank" onchange="togglePartnerRanks(true)">
                                    <label for="partner-unrank">Non class√©</label>
                                </div>
                            </div>
                            
                            <div class="checkbox-group">
                                <input type="checkbox" id="partner-discord-vocal" onchange="savePartnerPreferences()">
                                <label for="partner-discord-vocal">Vocal Discord (requis)</label>
                            </div>
                        </div>

                        <div id="partner-rank-selector" style="display: none;">
                            <div class="sidebar-section-title" style="margin-top:0; color: #cbd5e1; font-size: 0.9rem;">Rang minimum recherch√©</div>
                            <div id="partner-rank-grid" class="rank-selector-grid">
                                </div>
                        </div>

                        </div>
                    </div>
            </div>
        </div>

        <button id="sidebar-toggle" onclick="toggleSocialSidebar()">
            <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
        </button>
        
        <div class="social-sidebar" id="social-sidebar">
            </div>
    </main>

    <script>
        // ... (Variables globales inchang√©es) ...

        // ====================================================
        // --- LOGIQUE SIDEBAR SOCIALE RETRACTABLE (CORRIG√âE) ---
        // ====================================================
        window.toggleSocialSidebar = function() {
            const isCollapsed = socialSidebar.classList.toggle('collapsed');
            
            // Le bouton suit maintenant la sidebar via la propri√©t√© 'right' du CSS
            // sidebarToggle.classList.toggle('collapsed-mode-toggle', isCollapsed); // Ligne non n√©cessaire si on utilise le CSS pur
            chatContainer.classList.toggle('sidebar-collapsed', isCollapsed);

            localStorage.setItem('socialSidebarCollapsed', isCollapsed);
        }
        
        // ... (loadGameInfo, checkFavoriteStatus, updateFavoriteButton, toggleFavorite inchang√©s) ...

        // ====================================================
        // --- LOGIQUE PROFIL JOUEUR (Sauvegarde) ---
        // ====================================================

        // Fonction pour afficher/cacher le s√©lecteur de rang (CORRIG√âE pour re-d√©clencher l'√©tat)
        window.toggleRanks = function(shouldSave = true) {
            const isRanked = document.getElementById('ranked').checked;
            document.getElementById('rank-selector').style.display = isRanked ? 'block' : 'none';
            if (!isRanked) {
                document.getElementById('rank-grid').querySelectorAll('.rank-item').forEach(item => item.classList.remove('selected'));
                currentRankSelection = null;
            }
            if (shouldSave) saveGameSettings();
        }

        // ... (saveGameSettings, loadGameSettings - Correction mineure dans loadGameSettings pour s'assurer que toggleRanks est appel√© APR√àS que les boutons radio soient coch√©s) ...
        function loadGameSettings() {
            const settingsRadio = document.getElementById('ranked');
            const settingsUnrank = document.getElementById('unrank');
            
            const savedSettings = localStorage.getItem(`gameSettings-${gameId}`);
            if (!savedSettings) {
                settingsRadio.checked = true; // Par d√©faut sur Class√©
                document.getElementById('discord-vocal').checked = false;
                toggleRanks(false); // Appelle la fonction pour cacher/montrer le s√©lecteur
                return;
            }

            const settings = JSON.parse(savedSettings);
            
            // Correction: cocher le bon bouton radio
            if(settings.mode === 'ranked') {
                settingsRadio.checked = true;
                settingsUnrank.checked = false;
            } else {
                settingsRadio.checked = false;
                settingsUnrank.checked = true;
            }
            
            document.getElementById('discord-vocal').checked = settings.vocal;
            
            // Appeler toggleRanks APR√àS avoir coch√© le bouton radio
            toggleRanks(false); 

            if (settings.rank && settings.mode === 'ranked') {
                const rankItem = document.querySelector(`#rank-grid [data-rank="${settings.rank}"]`);
                if (rankItem) {
                    rankItem.classList.add('selected');
                    currentRankSelection = rankItem;
                }
            }
        }
        
        // ... (savePartnerPreferences, loadPartnerPreferences - Correction similaire pour la logique de chargement des rangs partenaire) ...
        async function loadPartnerPreferences() {
            const partnerRankedRadio = document.getElementById('partner-ranked');
            const partnerUnrankRadio = document.getElementById('partner-unrank');

            try {
                // ... (Fetch pr√©f√©rences) ...
                const response = await fetch(`/api/partner-preferences/${gameId}`);
                if (!response.ok) throw new Error('Failed to load partner preferences');
                const prefs = await response.json();
                
                // Correction: cocher le bon bouton radio
                if(prefs.mode === 'ranked') {
                    partnerRankedRadio.checked = true;
                    partnerUnrankRadio.checked = false;
                } else {
                    partnerRankedRadio.checked = false;
                    partnerUnrankRadio.checked = true;
                }

                document.getElementById('partner-discord-vocal').checked = prefs.vocal_required;
                
                // Appeler togglePartnerRanks APR√àS avoir coch√© le bouton radio
                togglePartnerRanks(false);

                if (prefs.min_rank && prefs.mode === 'ranked') {
                    const rankItem = document.querySelector(`#partner-rank-grid [data-rank="${prefs.min_rank}"]`);
                    if (rankItem) {
                        rankItem.classList.add('selected');
                        currentPartnerRankSelection = rankItem;
                    }
                }

            } catch (e) {
                // Initialisation par d√©faut
                partnerRankedRadio.checked = true;
                document.getElementById('partner-discord-vocal').checked = false;
                togglePartnerRanks(false);
            }
        }

        // Fonction pour afficher/cacher le s√©lecteur de rang PARTENAIRE (CORRIG√âE)
        window.togglePartnerRanks = function(shouldSave = true) {
            const isRanked = document.getElementById('partner-ranked').checked;
            document.getElementById('partner-rank-selector').style.display = isRanked ? 'block' : 'none';
            if (!isRanked) {
                document.getElementById('partner-rank-grid').querySelectorAll('.rank-item').forEach(item => item.classList.remove('selected'));
                currentPartnerRankSelection = null;
            }
            if (shouldSave) savePartnerPreferences();
        }

        // ... (Reste des fonctions inchang√©es : publishProfile, findPlayers, renderMatches, etc.) ...


        // ====================================================
        // --- INITIALISATION FINALE ---
        // ====================================================
        
        (async function() {
            // Initialisation de la sidebar r√©tractable
            if (localStorage.getItem('socialSidebarCollapsed') === 'true') {
                socialSidebar.classList.add('collapsed');
                // sidebarToggle.classList.add('collapsed-mode-toggle'); // Retir√©
                chatContainer.classList.add('sidebar-collapsed');
            }

            // ... (setupRankGrids inchang√©) ...
            const gameRanks = RANKS[gameId] || RANKS.valorant;
            setupRankGrids(gameRanks);

            // Chargement des donn√©es (Ces fonctions appellent d√©sormais toggleRanks/togglePartnerRanks correctement)
            loadGameSettings();
            await loadPartnerPreferences();

            await loadGameInfo(); // Chargement des informations du jeu (Nom, image, etc.)

            loadSocial();
            setInterval(loadSocial, 5000);
            
        })();
    </script>
</body>
</html>
