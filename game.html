<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Jeu ‚Äì MatchMates</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />

  <style>
    /* On r√©utilise les m√™mes variables et styles de base pour la coh√©rence */
    :root { 
        --primary-color: #22c55e; 
        --sidebar-width: 320px; 
        --game-info-width: 280px; 
        --bg-dark: #0f172a; 
        --bg-card: #1e293b; 
        --text-main: #f1f5f9; 
        --text-muted: #94a3b8; 
    }
    body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Inter', sans-serif; margin: 0; overflow-x: hidden; }
    
    /* HEADER */
    header { display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(10px); position: fixed; top: 0; width: 100%; z-index: 800; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
    .logo { color: var(--primary-color); font-size: 1.5rem; font-weight: 800; text-decoration: none; }
    .nav-links a { color: var(--text-main); text-decoration: none; margin-left: 20px; font-weight: 500; transition: color 0.2s; }
    .nav-links a:hover { color: var(--primary-color); }
    .user-info { color: var(--text-main); font-weight: 500; }
    
    /* LAYOUT PRINCIPAL (Structure √† 2 zones avec Flexbox) */
    main { 
        padding-top: 80px; 
        display: flex;
        justify-content: flex-start;
        align-items: flex-start;
        min-height: calc(100vh - 80px); 
    }

    /* Bandeau d'information du jeu √† gauche (Statique) */
    .game-info-sidebar {
        width: var(--game-info-width);
        min-height: calc(100vh - 80px);
        background-color: #172031;
        padding: 20px;
        position: sticky;
        top: 80px;
        z-index: 700;
        border-right: 1px solid rgba(255,255,255,0.05);
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    /* Le contenu du jeu prend l'espace restant */
    .game-content-area {
        flex: 1; 
        padding: 20px 30px; 
        max-width: 800px; 
    }
    
    /* Structure 1 colonne (Anciennement 2, maintenant juste un conteneur) */
    .game-settings-layout {
        display: flex; 
        gap: 30px;
        align-items: flex-start;
    }
    .settings-column {
        flex: 1; 
    }


    /* CARD STYLING */
    .card { background-color: var(--bg-card); padding: 25px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); }
    .card h3 { color: var(--text-main); margin-top: 0; margin-bottom: 20px; font-weight: 600; font-size: 1.4rem; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 10px; }

    /* FORM / INPUTS */
    .checkbox-group { display: flex; align-items: center; margin-bottom: 15px; }
    .checkbox-group input[type="radio"], .checkbox-group input[type="checkbox"] { margin-right: 10px; width: 16px; height: 16px; border-radius: 4px; border: 1px solid var(--text-muted); background: transparent; appearance: none; cursor: pointer; position: relative; }
    .checkbox-group input:checked::before { content: '‚úì'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--primary-color); font-size: 14px; font-weight: bold; }
    .checkbox-group label { color: var(--text-main); font-size: 1rem; cursor: pointer; }
    .profile-controls { margin-bottom: 25px; display: flex; flex-direction: column; gap: 15px;}
    #ranked-options { margin-bottom: 10px; }

    /* RANK GRID */
    .rank-selector-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px; margin-top: 15px; }
    .rank-item { background-color: rgba(255,255,255,0.05); border: 2px solid transparent; border-radius: 8px; padding: 10px 5px; text-align: center; cursor: pointer; font-size: 0.8rem; font-weight: 500; transition: all 0.2s; }
    .rank-item:hover { border-color: rgba(255,255,255,0.2); }
    .rank-item.selected { border-color: var(--primary-color); background-color: rgba(34, 197, 94, 0.15); font-weight: 700; color: var(--primary-color); }
    .rank-item img { width: 30px; height: 30px; display: block; margin: 0 auto 5px; }

    /* BUTTONS */
    .action-btn { background-color: var(--primary-color); color: var(--bg-dark); border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; font-size: 1rem; }
    .action-btn:hover { background-color: #10b981; }
    .btn-secondary { background-color: var(--bg-card); color: var(--primary-color); border: 1px solid var(--primary-color); }
    .btn-secondary:hover { background-color: rgba(34, 197, 94, 0.1); }
    .action-btn:disabled { background-color: var(--text-muted); cursor: not-allowed; }

    /* --- BOUTON SIDEBAR --- */
    .toggle-friends-btn {
      position: fixed; top: 80px; right: 20px; z-index: 9999; 
      background: var(--primary-color); color: #020617; border: none;
      padding: 10px 16px; border-radius: 30px; cursor: pointer;
      display: flex; align-items: center; gap: 8px; font-weight: 600;
      box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* NOUVELLES R√àGLES POUR LE BOUTON ACTIF (bas√© sur la classe 'active' ajout√©e par JS) */
    .toggle-friends-btn.active {
        right: calc(20px + var(--sidebar-width) - 40px); /* D√©place le bouton vers la gauche de la sidebar - 40px */
        background: #ef4444; 
        color: white;
    }
    .toggle-friends-btn.active span {
        display: none; 
    }
    .toggle-friends-btn.active::after {
        content: "‚úï"; 
    }

    /* --- SIDEBAR --- */
    .friends-sidebar {
      position: fixed; top: 0; right: calc(0px - var(--sidebar-width)); /* Cache la sidebar compl√®tement */
      width: var(--sidebar-width); height: 100vh;
      background: rgba(15, 23, 42, 0.98); border-left: 1px solid rgba(255,255,255,0.1);
      box-shadow: -10px 0 30px rgba(0,0,0,0.5); padding: 80px 15px 20px; z-index: 1000;
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex; flex-direction: column; gap: 15px; backdrop-filter: blur(12px);
    }
    .friends-sidebar.active { right: 0; } /* R√©v√®le la sidebar */

    .sidebar-section-title { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-top: 15px; font-weight: 700; }
    .friend-card { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-radius: 12px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); cursor: pointer; margin-bottom: 5px;}
    .friend-card:hover { background: rgba(255,255,255,0.08); }
    .friend-avatar { width: 32px; height: 32px; border-radius: 50%; background: #3b82f6; display: flex; justify-content: center; align-items: center; font-weight: bold; margin-right: 10px; }
    .friend-status.pending { color: #fbbf24; }
    .add-friend-box { display: flex; gap: 5px; }
    .add-friend-box input { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid #334155; border-radius: 20px; padding: 6px 12px; color: white; outline: none; }
    .add-friend-box button { background: var(--primary-color); border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-weight: bold; }

    /* CHAT */
    .chat-container { position: fixed; bottom: 0; right: calc(360px + 20px); /* Ajuste la position initiale */
        display: flex; flex-direction: row-reverse; gap: 15px; z-index: 900; pointer-events: none; 
        transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    /* D√©place le chat lorsque la sidebar est ouverte */
    .friends-sidebar.active + .chat-container { 
        right: 20px; /* Position du chat sans la sidebar */
    }
    @media(max-width: 900px) { 
        .chat-container { right: 10px; } 
        .friends-sidebar.active + .chat-container { right: 10px; } /* Ne bouge pas sur mobile */
    }
    .chat-window { width: 300px; height: 400px; background: var(--bg-card); border-radius: 12px 12px 0 0; display: flex; flex-direction: column; pointer-events: auto; border: 1px solid #334155; }
    .chat-header { background: #0f172a; padding: 10px; cursor: pointer; display: flex; justify-content: space-between; border-bottom: 1px solid #334155; }
    .chat-body { flex: 1; padding: 10px; overflow-y: auto; background: #020617; display: flex; flex-direction: column; gap: 8px; }
    .chat-input-area { padding: 10px; background: #1e293b; border-top: 1px solid #334155; display: flex; }
    .chat-input-area input { flex: 1; padding: 8px; border-radius: 20px; border: none; background: #334155; color: white; outline: none; }
    .msg { padding: 6px 12px; border-radius: 12px; max-width: 80%; font-size: 0.85rem; }
    .msg.me { align-self: flex-end; background: var(--primary-color); color: #020617; }
    .msg.them { align-self: flex-start; background: #334155; color: white; }

    /* RESPONSIVE */
    @media (max-width: 1200px) {
        .game-info-sidebar { --game-info-width: 250px; }
    }
    @media (max-width: 900px) {
        main { flex-direction: column; }
        .game-info-sidebar { position: relative; width: 100%; top: auto; border-right: none; border-bottom: 1px solid rgba(255,255,255,0.05); gap: 10px; }
        .game-info-sidebar > * { margin: 0 !important; padding: 0 !important;}
        .game-info-sidebar img { margin-bottom: 5px !important; }
        .game-content-area { padding: 20px; max-width: 100%; }
        .game-settings-layout { flex-direction: column; gap: 0; }
    }
  </style>
</head>
<body>
  <header>
    <a href="/dashboard" class="logo">MatchMates</a>
    <div class="nav-links">
      <a href="/dashboard">Dashboard</a>
      <a href="/profile">Profil</a>
      <a href="/logout">D√©connexion</a>
    </div>
  </header>

  <main>
    
    <div class="game-info-sidebar">
        <img id="game-image" src="/img/games/default.png" alt="Logo du Jeu" 
             style="width: 100%; height: auto; border-radius: 8px; margin-bottom: 10px; object-fit: cover; aspect-ratio: 16/9;">

        <h2 id="game-short-name" style="margin: 0 0 5px; font-size: 1.8rem; font-weight: 700; color: var(--primary-color);">Chargement...</h2>
        
        <p id="game-description" style="color: var(--text-muted); font-size: 0.95rem; margin-top: 0;">
            Description du jeu...
        </p>

        <button class="action-btn btn-secondary" id="favorite-toggle-btn" onclick="toggleFavorite()" style="width: 100%; font-size: 0.9rem; padding: 10px;">
            ‚≠ê Charger...
        </button>
    </div>
    
    <div class="game-content-area">
        <h1 id="game-title">Chargement du Jeu...</h1>

        <div class="game-settings-layout">
            
            <div class="settings-column" style="flex: 1;"> 
                
                <div class="card">
                    <h3>Ton profil de joueur</h3>
                    <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 15px;">
                        Configurez votre style de jeu pour trouver des partenaires compatibles.
                    </p>

                    <div class="profile-controls">
                        <div id="ranked-options" style="display: flex; gap: 20px;">
                            <div class="checkbox-group">
                                <input type="radio" id="ranked" name="mode" value="ranked" onchange="toggleRanks(true)">
                                <label for="ranked">Class√©</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="radio" id="unrank" name="mode" value="unrank" onchange="toggleRanks(true)">
                                <label for="unrank">Non class√©</label>
                            </div>
                        </div>
                        
                        <div class="checkbox-group">
                            <input type="checkbox" id="discord-vocal" onchange="saveGameSettings()">
                            <label for="discord-vocal">Vocal Discord</label>
                        </div>
                    </div>

                    <div id="rank-selector" style="display: none;">
                        <div class="sidebar-section-title" style="margin-top:0; color: #cbd5e1; font-size: 0.9rem;">Mon rang actuel</div>
                        <div id="rank-grid" class="rank-selector-grid">
                            </div>
                    </div>

                    <div style="margin-top: 25px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 20px;">
                        <button class="action-btn btn-primary" id="publish-profile-btn" onclick="publishProfile()" style="width: 100%;">
                            üì¢ Publier mon profil
                        </button>
                        <div id="publish-status" style="font-size:0.8rem; text-align:center; margin-top:10px; min-height: 1.2em;"></div>
                    </div>
                </div>

                <div class="card" id="partner-profile-card">
                    <h3>üéØ Les joueurs que tu recherches</h3>
                    <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 15px;">
                        D√©finis les crit√®res des joueurs que tu souhaites rencontrer.
                    </p>

                    <div class="profile-controls">
                        <div id="partner-ranked-options" style="display: flex; gap: 20px;">
                            <div class="checkbox-group">
                                <input type="radio" id="partner-ranked" name="partner-mode" value="ranked" onchange="togglePartnerRanks(true)">
                                <label for="partner-ranked">Class√©</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="radio" id="partner-unrank" name="partner-mode" value="unrank" onchange="togglePartnerRanks(true)">
                                <label for="partner-unrank">Non class√©</label>
                            </div>
                        </div>
                        
                        <div class="checkbox-group">
                            <input type="checkbox" id="partner-discord-vocal" onchange="savePartnerPreferences()">
                            <label for="partner-discord-vocal">Vocal Discord requis</label>
                        </div>
                    </div>

                    <div id="partner-rank-selector" style="display: none;">
                        <div class="sidebar-section-title" style="margin-top:0; color: #cbd5e1; font-size: 0.9rem;">Rang minimum recherch√©</div>
                        <div id="partner-rank-grid" class="rank-selector-grid">
                            </div>
                    </div>

                    <div style="margin-top: 25px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 20px;">
                        <button class="action-btn btn-secondary" onclick="savePartnerPreferences()" style="width: 100%;">
                            üíæ Sauvegarder mes pr√©f√©rences
                        </button>
                    </div>
                </div>

                <div class="card" id="match-results-card">
                    <h3>üîç Chercher des Partenaires</h3>
                    <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 15px;">
                        Lancez la recherche pour trouver des joueurs correspondant √† vos crit√®res.
                    </p>
                    <button class="action-btn btn-primary" onclick="findPlayers()" style="width: 100%; margin-bottom: 20px;">
                        üöÄ Lancer la recherche
                    </button>
                    
                    <div id="match-list">
                        <p style="text-align:center; color:var(--text-muted);">
                            Cliquez sur "Lancer la recherche" pour trouver des co√©quipiers.
                        </p>
                    </div>
                    <p id="no-match-message" style="text-align:center; color:#eab308; display:none; font-weight: 500;">
                        üò≠ Aucun joueur ne correspond √† vos crit√®res pour le moment.
                    </p>
                </div>
            </div>

        </div>
    </div>
  </main>

  <button class="toggle-friends-btn" onclick="toggleSidebar()">
    <span>üí¨ Amis</span>
  </button>

  <aside class="friends-sidebar" id="friendsSidebar">
    <h2 style="margin: 0; font-size: 1.1rem;">Social</h2>
    <div class="sidebar-section-title">Ajouter</div>
    <form class="add-friend-box" id="add-friend-form">
        <input type="text" id="friend-input" placeholder="Pseudo..." autocomplete="off">
        <button type="submit">+</button>
    </form>
    <div id="friend-notif" style="font-size:0.75rem; margin-top:5px; min-height:1em;"></div>
    <div id="section-requests-in" style="display:none;">
        <div class="sidebar-section-title">Re√ßues</div>
        <div id="list-requests-in"></div>
    </div>
    <div id="section-requests-out" style="display:none;">
        <div class="sidebar-section-title">Envoy√©es</div>
        <div id="list-requests-out"></div>
    </div>
    <div class="sidebar-section-title">Mes Amis (<span id="friend-count">0</span>)</div>
    <div id="friends-list" style="overflow-y: auto; flex: 1;"></div>
  </aside>

  <div id="chat-container" class="chat-container"></div>

  <script>
    // R√©tablissement de la fonction de bascule de la barre lat√©rale
    function toggleSidebar() { 
        const sidebar = document.getElementById('friendsSidebar');
        const button = document.querySelector('.toggle-friends-btn');
        // Bascule la classe 'active' sur la sidebar
        sidebar.classList.toggle('active');
        // CORRECTION: Bascule la classe 'active' sur le bouton
        button.classList.toggle('active');
        
        // CORRECTION: Si la sidebar est ouverte, on pourrait vouloir ajuster la position du chat
        const chatContainer = document.getElementById('chat-container');
        if(chatContainer) {
            // Le chat a besoin de la classe 'sidebar-active' ou autre pour s'ajuster
            // Bas√© sur le CSS mis √† jour, il est g√©r√© par la relation `friends-sidebar.active + .chat-container`
            // Je supprime le besoin de basculer la classe 'active' sur le bouton du code JS pr√©c√©dent
            // Je laisse le bouton se g√©rer via la classe 'active' sur la sidebar.
            // **RE-CORRECTION:** Puisque l'ordre HTML a √©t√© modifi√©, le tilde n'est pas le meilleur, je reviens √† l'approche de basculer sur le bouton ET la sidebar.
        }
    }

    // Variables globales (variables sociales r√©int√©gr√©es)
    const pathSegments = window.location.pathname.split('/');
    const gameId = pathSegments[pathSegments.length - 1];
    let currentRankSelection = null;
    let currentPartnerRankSelection = null;
    const friendNotif = document.getElementById('friend-notif');
    const chatContainer = document.getElementById('chat-container');
    const activeChats = {}; 

    // D√©finitions des rangs (√† adapter par jeu)
    const RANKS = {
        valorant: [
            { name: 'Fer', img: 'fer.png' },
            { name: 'Bronze', img: 'bronze.png' },
            { name: 'Argent', img: 'argent.png' },
            { name: 'Or', img: 'or.png' },
            { name: 'Platine', img: 'platine.png' },
            { name: 'Diamant', img: 'diamant.png' },
            { name: 'Ascendant', img: 'ascendant.png' },
            { name: 'Immortel', img: 'immortel.png' },
            { name: 'Radieux', img: 'radieux.png' },
        ],
        // Autres jeux...
        leagueoflegends: [
            { name: 'Fer', img: 'fer.png' },
            { name: 'Bronze', img: 'bronze.png' },
            { name: 'Argent', img: 'argent.png' },
            { name: 'Or', img: 'or.png' },
            { name: 'Platine', img: 'platine.png' },
            { name: '√âmeraude', img: 'emeraude.png' },
            { name: 'Diamant', img: 'diamant.png' },
            { name: 'Ma√Ætre', img: 'maitre.png' },
            { name: 'Grand Ma√Ætre', img: 'grand_maitre.png' },
            { name: 'Challenger', img: 'challenger.png' },
        ],
        cs2: [
            { name: 'Silver I', img: 's1.png' },
            { name: 'Silver Elite Master', img: 'sem.png' },
            { name: 'Gold Nova I', img: 'gn1.png' },
            { name: 'Master Guardian Elite', img: 'mge.png' },
            { name: 'Global Elite', img: 'ge.png' },
        ]
    };

    // Fausse BDD pour info jeu (sera remplac√© par un fetch API plus tard)
    const GAME_INFOS = {
        valorant: {
            name: "Valorant",
            description: "Jeu de tir tactique en 5v5 bas√© sur les personnages d√©velopp√© par Riot Games.",
            image: "/img/games/valorant.png"
        },
        leagueoflegends: {
            name: "League of Legends",
            description: "Jeu de strat√©gie en √©quipe o√π deux √©quipes de cinq puissants champions s'affrontent pour d√©truire la base adverse.",
            image: "/img/games/lol.png"
        },
        cs2: {
            name: "Counter-Strike 2",
            description: "La nouvelle √®re du jeu de tir √† la premi√®re personne embl√©matique.",
            image: "/img/games/cs2.png"
        }
    };

    // ====================================================
    // --- LOGIQUE FAVORI (Inchang√©) ---
    // ====================================================

    let isFavorite = false;

    async function loadGameInfo() {
        const info = GAME_INFOS[gameId] || { name: gameId.toUpperCase(), description: 'Description non disponible', image: '/img/games/default.png' };
        document.getElementById('game-title').textContent = `${info.name} - Matchmaking`;
        document.getElementById('game-short-name').textContent = info.name;
        document.getElementById('game-description').innerHTML = info.description;
        document.getElementById('game-image').src = info.image;

        await checkFavoriteStatus();
    }

    async function checkFavoriteStatus() {
        const btn = document.getElementById('favorite-toggle-btn');
        try {
            const res = await fetch('/api/favorites');
            const data = await res.json();
            isFavorite = data.favorites.includes(gameId);
        } catch(e) {
            console.error("Erreur chargement favoris:", e);
            isFavorite = false;
        }
        updateFavoriteButton(btn);
    }

    function updateFavoriteButton(btn) {
        if (isFavorite) {
            btn.textContent = '‚ùå Retirer des Favoris';
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-secondary');
        } else {
            btn.textContent = '‚≠ê Ajouter aux Favoris';
            btn.classList.remove('btn-secondary');
            btn.classList.add('btn-primary');
        }
    }

    window.toggleFavorite = async function() {
        const btn = document.getElementById('favorite-toggle-btn');
        btn.disabled = true;
        try {
            const res = await fetch(`/api/favorites/${gameId}`, { method: 'POST' });
            const data = await res.json();
            if (data.status === 'added') {
                isFavorite = true;
            } else if (data.status === 'removed') {
                isFavorite = false;
            }
            updateFavoriteButton(btn);
        } catch(e) {
            alert("Erreur lors de la mise √† jour des favoris.");
        } finally {
            btn.disabled = false;
        }
    }

    // ====================================================
    // --- LOGIQUE PROFIL JOUEUR / PARTENAIRE (Inchang√©) ---
    // ====================================================

    function setupRankGrids(gameRanks) {
        const rankGrid = document.getElementById('rank-grid');
        const partnerRankGrid = document.getElementById('partner-rank-grid');
        rankGrid.innerHTML = '';
        partnerRankGrid.innerHTML = '';
        gameRanks.forEach(rank => {
            const playerItem = createRankItem(rank.name, rank.img, (e) => selectRank(e, 'player'));
            rankGrid.appendChild(playerItem);
            const partnerItem = createRankItem(rank.name, rank.img, (e) => selectRank(e, 'partner'));
            partnerRankGrid.appendChild(partnerItem);
        });
    }

    function createRankItem(rankName, imgName, onclickHandler) {
        const item = document.createElement('div');
        item.className = 'rank-item';
        item.setAttribute('data-rank', rankName);
        item.onclick = onclickHandler;
        // Utilisez le nom du jeu pour construire le chemin de l'image
        const gameName = gameId.toLowerCase();
        item.innerHTML = `
            <img src="/img/ranks/${gameName}/${imgName}" alt="${rankName}" onerror="this.onerror=null;this.src='/img/ranks/default.png';">
            <span>${rankName}</span>
        `;
        return item;
    }

    function selectRank(event, type) {
        const target = event.currentTarget;
        const rank = target.getAttribute('data-rank');
        const gridId = type === 'player' ? 'rank-grid' : 'partner-rank-grid';
        const currentSelectionVar = type === 'player' ? 'currentRankSelection' : 'currentPartnerRankSelection';

        document.querySelectorAll(`#${gridId} .rank-item`).forEach(item => {
            item.classList.remove('selected');
        });

        target.classList.add('selected');

        if (type === 'player') {
            currentRankSelection = target;
            saveGameSettings();
        } else {
            currentPartnerRankSelection = target;
            savePartnerPreferences();
        }
    }

    window.toggleRanks = function(save = true) {
        const rankedChecked = document.getElementById('ranked').checked;
        const rankSelector = document.getElementById('rank-selector');
        rankSelector.style.display = rankedChecked ? 'block' : 'none';

        if (!rankedChecked) {
            if (currentRankSelection) {
                currentRankSelection.classList.remove('selected');
                currentRankSelection = null;
            }
        }
        if (save) saveGameSettings();
    }

    window.togglePartnerRanks = function(save = true) {
        const partnerRankedChecked = document.getElementById('partner-ranked').checked;
        const partnerRankSelector = document.getElementById('partner-rank-selector');
        partnerRankSelector.style.display = partnerRankedChecked ? 'block' : 'none';

        if (!partnerRankedChecked) {
            if (currentPartnerRankSelection) {
                currentPartnerRankSelection.classList.remove('selected');
                currentPartnerRankSelection = null;
            }
        }
        if (save) savePartnerPreferences();
    }


    window.saveGameSettings = function() {
        const mode = document.getElementById('ranked').checked ? 'ranked' : 'unrank';
        const rank = currentRankSelection ? currentRankSelection.getAttribute('data-rank') : null;
        const vocal = document.getElementById('discord-vocal').checked;

        const settings = { mode, rank, vocal };
        localStorage.setItem(`gameSettings-${gameId}`, JSON.stringify(settings));
    }

    window.loadGameSettings = function() {
        const settingsRadio = document.getElementById('ranked');
        const settingsUnrank = document.getElementById('unrank');

        const savedSettings = localStorage.getItem(`gameSettings-${gameId}`);
        if (!savedSettings) {
            settingsRadio.checked = true;
            document.getElementById('discord-vocal').checked = false;
            toggleRanks(false);
            return;
        }

        const settings = JSON.parse(savedSettings);

        if(settings.mode === 'ranked') {
            settingsRadio.checked = true;
            settingsUnrank.checked = false;
        } else {
            settingsRadio.checked = false;
            settingsUnrank.checked = true;
        }
        document.getElementById('discord-vocal').checked = settings.vocal;

        toggleRanks(false);

        if (settings.rank && settings.mode === 'ranked') {
            const rankItem = document.querySelector(`#rank-grid [data-rank="${settings.rank}"]`);
            if (rankItem) {
                rankItem.classList.add('selected');
                currentRankSelection = rankItem;
            }
        }
    }

    window.savePartnerPreferences = async function() {
        const mode = document.getElementById('partner-ranked').checked ? 'ranked' : 'unrank';
        const min_rank = currentPartnerRankSelection ? currentPartnerRankSelection.getAttribute('data-rank') : null;
        const vocal_required = document.getElementById('partner-discord-vocal').checked;

        const data = { mode, min_rank, vocal_required };
        
        try {
            await fetch(`/api/partner-preferences/${gameId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        } catch (e) {
            console.error("Erreur de sauvegarde des pr√©f√©rences partenaire:", e);
        }
    }

    async function loadPartnerPreferences() {
        const partnerRankedRadio = document.getElementById('partner-ranked');
        const partnerUnrankRadio = document.getElementById('partner-unrank');
        
        try {
            const response = await fetch(`/api/partner-preferences/${gameId}`);
            if (!response.ok) throw new Error('Failed to load partner preferences');
            
            const prefs = await response.json();

            if(prefs.mode === 'ranked') {
                partnerRankedRadio.checked = true;
                partnerUnrankRadio.checked = false;
            } else {
                partnerRankedRadio.checked = false;
                partnerUnrankRadio.checked = true;
            }

            document.getElementById('partner-discord-vocal').checked = prefs.vocal_required;
            
            togglePartnerRanks(false);

            if (prefs.min_rank && prefs.mode === 'ranked') {
                const rankItem = document.querySelector(`#partner-rank-grid [data-rank="${prefs.min_rank}"]`);
                if (rankItem) {
                    rankItem.classList.add('selected');
                    currentPartnerRankSelection = rankItem;
                }
            }
        } catch (e) {
            console.error("Erreur chargement des pr√©f√©rences partenaire:", e);
            // Si erreur, utiliser les valeurs par d√©faut
            partnerRankedRadio.checked = true;
            document.getElementById('partner-discord-vocal').checked = false;
            togglePartnerRanks(false);
        }
    }


    window.publishProfile = async function() {
        const statusEl = document.getElementById('publish-status');
        const btn = document.getElementById('publish-profile-btn');
        btn.disabled = true;
        statusEl.textContent = "Publication en cours...";
        statusEl.style.color = 'var(--text-muted)';
        
        const mode = document.getElementById('ranked').checked ? 'ranked' : 'unrank';
        const rank = currentRankSelection ? currentRankSelection.getAttribute('data-rank') : null;
        const vocal = document.getElementById('discord-vocal').checked;
        
        const data = { mode, rank, vocal };

        try {
            const res = await fetch(`/api/publish-profile/${gameId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                statusEl.textContent = "‚úÖ Profil publi√© avec succ√®s !";
                statusEl.style.color = 'var(--primary-color)';
            } else {
                throw new Error("Erreur de publication");
            }

        } catch (e) {
            statusEl.textContent = "‚ùå Erreur de publication. Veuillez v√©rifier votre rang/mode.";
            statusEl.style.color = '#ef4444';
        } finally {
            btn.disabled = false;
            setTimeout(() => statusEl.textContent = '', 5000);
        }
    }

    window.findPlayers = async function() {
        const matchCard = document.getElementById('match-results-card');
        const matchList = document.getElementById('match-list');
        const noMatchMessage = document.getElementById('no-match-message');

        matchList.innerHTML = '<p style="text-align:center; color:var(--text-muted);">Recherche en cours...</p>';
        noMatchMessage.style.display = 'none';

        try {
            const response = await fetch(`/api/match-players/${gameId}`);
            if (!response.ok) throw new Error('Failed to fetch matches');
            
            const data = await response.json();

            if (data.matches && data.matches.length > 0) {
                renderMatches(data.matches);
            } else {
                matchList.innerHTML = '';
                noMatchMessage.style.display = 'block';
            }
        } catch (e) {
            matchList.innerHTML = '<p style="text-align:center; color:#ef4444;">Une erreur est survenue lors de la recherche.</p>';
        }
    }

    function renderMatches(matches) {
        const matchList = document.getElementById('match-list');
        matchList.innerHTML = '';
        matches.forEach(match => {
            const card = document.createElement('div');
            card.className = 'card match-profile-card';
            card.style.marginBottom = '10px';
            card.style.padding = '15px';
            card.style.display = 'flex';
            card.style.alignItems = 'center';
            card.style.justifyContent = 'space-between';

            let rankText = match.rank ? `Rang: ${match.rank}` : 'Non Class√©';
            let vocalIcon = match.vocal ? ' üé§' : '';

            card.innerHTML = `
                <div style="display:flex; flex-direction:column; gap:3px;">
                    <div style="font-weight: 600; font-size:1.1rem; color: white;">${match.username} ${vocalIcon}</div>
                    <div style="color: var(--text-muted); font-size: 0.85rem;">${rankText}</div>
                </div>
                <div class="actions-bar" style="margin: 0; gap: 5px;">
                    <button class="action-btn btn-secondary" style="padding: 6px 12px; font-size: 0.8rem;" onclick="sendFriendRequest('${match.username}')"> + Ami </button>
                    <button class="action-btn btn-primary" style="padding: 6px 12px; font-size: 0.8rem;" onclick="openChat('${match.username}')"> üí¨ Chat </button>
                </div>`;

            matchList.appendChild(card);
        });
    }

    // Fonction d'envoi de demande d'ami rapide depuis la liste de match
    window.sendFriendRequest = async function(username) {
        const res=await fetch('/api/friends/request',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({toUsername:username})});
        const d=await res.json(); 
        alert(d.ok ? `Demande d'ami envoy√©e √† ${username} !` : d.error || `Erreur: impossible d'ajouter ${username}`);
        loadSocial();
    }

    
    // ====================================================
    // --- LOGIQUE SOCIALE (Chat & Amis) --- (R√©int√©gr√©e)
    // ====================================================
    
    async function loadSocial() {
        try {
            const [fRes, rRes] = await Promise.all([fetch('/api/friends'), fetch('/api/friends/requests')]);
            const fData = await fRes.json();
            const rData = await rRes.json();
            renderFriends(fData.friends);
            renderRequests(rData.incoming, rData.outgoing);
        } catch(e) {}
    }

    function renderFriends(list) {
        const c = document.getElementById('friends-list');
        document.getElementById('friend-count').innerText = list.length;
        c.innerHTML = "";
        if(list.length===0) { c.innerHTML='<div style="text-align:center;color:#64748b;font-size:0.8rem;margin-top:10px;">Aucun ami.</div>'; return; }
        list.forEach(f => {
            const d = document.createElement('div'); d.className='friend-card'; d.onclick=()=>openChat(f.username);
            d.innerHTML=`<div style="display:flex;align-items:center;"><div class="friend-avatar">${f.username[0].toUpperCase()}</div><div><div style="font-size:0.9rem;font-weight:500;color:white;">${f.username}</div><div class="friend-status">‚óè En ligne</div></div></div><span>üí¨</span>`;
            c.appendChild(d);
        });
    }

    function renderRequests(inc, out) {
        const iC=document.getElementById('list-requests-in'); document.getElementById('section-requests-in').style.display=inc.length?'block':'none'; iC.innerHTML="";
        inc.forEach(r=>{ const d=document.createElement('div'); d.className='friend-card'; d.style.border='1px solid #eab308';
            d.innerHTML=`<span style="font-size:0.85rem;">${r.from_username}</span><div><button onclick="hReq(${r.id},'accept')" style="background:#22c55e;border:none;border-radius:4px;cursor:pointer;">‚úî</button><button onclick="hReq(${r.id},'reject')" style="background:#ef4444;border:none;border-radius:4px;cursor:pointer;margin-left:5px;">‚úñ</button></div>`; iC.appendChild(d); });
        
        const oC=document.getElementById('list-requests-out'); document.getElementById('section-requests-out').style.display=out.length?'block':'none'; oC.innerHTML="";
        out.forEach(r=>{ const d=document.createElement('div'); d.className='friend-card'; d.style.cursor='default';
            d.innerHTML=`<div style="display:flex;align-items:center;opacity:0.7;"><div class="friend-avatar" style="background:#64748b;width:24px;height:24px;font-size:0.7rem;">?</div><div><div style="font-size:0.85rem;">${r.to_username}</div><div class="friend-status pending">En attente...</div></div></div>`; oC.appendChild(d); });
    }

    document.getElementById('add-friend-form').addEventListener('submit', async(e)=>{
        e.preventDefault(); const i=document.getElementById('friend-input'); if(!i.value.trim()) return;
        const res=await fetch('/api/friends/request',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({toUsername:i.value.trim()})});
        const d=await res.json(); friendNotif.innerText=d.ok?"Envoy√© !":d.error; friendNotif.style.color=d.ok?"#22c55e":"#ef4444";
        i.value=""; loadSocial(); setTimeout(()=>friendNotif.innerText="",3000);
    });

    window.hReq = async(id,a)=>{ await fetch(`/api/friends/requests/${id}/${a}`,{method:'POST'}); loadSocial(); };

    window.openChat=(u)=>{ if(document.getElementById(`cw-${u}`)) return;
        const d=document.createElement('div'); d.className='chat-window'; d.id=`cw-${u}`;
        d.innerHTML=`<div class="chat-header" onclick="closeChat('${u}')"><span>${u}</span><span>‚úñ</span></div><div class="chat-body" id="msg-${u}"></div><form class="chat-input-area" onsubmit="sM(event,'${u}')"><input type="text" placeholder="..." autocomplete="off"></form>`;
        chatContainer.appendChild(d); fM(u); activeChats[u]=setInterval(()=>fM(u),3000);
    };
    window.closeChat=(u)=>{ const el=document.getElementById(`cw-${u}`); if(el) el.remove(); if(activeChats[u]){clearInterval(activeChats[u]);delete activeChats[u];} };
    window.sM=async(e,u)=>{ e.preventDefault(); const i=e.target.querySelector('input'); if(!i.value.trim()) return;
        await fetch('/api/messages',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({toUsername:u,content:i.value.trim()})}); i.value=\"\"; fM(u); };
    async function fM(u){ const c=document.getElementById(`msg-${u}`); if(!c) return;
        const res=await fetch(`/api/messages/${u}`); const d=await res.json();
        c.innerHTML=d.messages.map(m=>`<div class="msg ${m.fromSelf?'me':'them'}">${m.content}</div>`).join(''); c.scrollTop=c.scrollHeight; }

    
    // ====================================================
    // --- INITIALISATION FINALE ---
    // ====================================================
    
    (async function() {
        // D√©finition des rangs pour le jeu actuel
        const gameRanks = RANKS[gameId.toLowerCase()] || RANKS.valorant;
        setupRankGrids(gameRanks);

        // Chargement des donn√©es 
        loadGameSettings();
        await loadPartnerPreferences();

        await loadGameInfo(); 

        // Initialisation de la logique sociale r√©int√©gr√©e
        loadSocial(); 
        setInterval(loadSocial, 5000);
    })();
  </script>
</body>
</html>
