<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Jeu ‚Äì MatchMates</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />

  <style>
    /* On r√©utilise les m√™mes variables et styles de base pour la coh√©rence */
    :root { 
        --primary-color: #22c55e; 
        --sidebar-width: 320px; 
        --bg-dark: #0f172a; 
        --bg-card: #1e293b; 
        --text-main: #f1f5f9; 
        --text-muted: #94a3b8; 
    }
    body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Inter', sans-serif; margin: 0; overflow-x: hidden; }
    
    /* HEADER */
    header { display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(10px); position: fixed; top: 0; width: 100%; z-index: 800; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
    .logo { color: var(--primary-color); font-size: 1.5rem; font-weight: 800; text-decoration: none; }
    .nav-links a { color: var(--text-main); text-decoration: none; margin-left: 20px; font-weight: 500; transition: color 0.2s; }
    .nav-links a:hover { color: var(--primary-color); }
    .user-info { color: var(--text-main); font-weight: 500; }
    
    /* LAYOUT PRINCIPAL */
    main { padding-top: 80px; }

    /* Conteneur pour le contenu de la page jeu */
    .game-content-area {
        margin: 20px 30px;
        /* La largeur est ajust√©e pour laisser l'espace √† la sidebar sociale */
        max-width: calc(100% - var(--sidebar-width) - 60px); 
    }
    
    /* Structure 2 colonnes du contenu sp√©cifique au jeu (R√©tabli) */
    .game-settings-layout {
        display: flex;
        gap: 30px;
        align-items: flex-start;
    }
    .settings-column {
        flex: 1;
    }


    /* CARD STYLING */
    .card { background-color: var(--bg-card); padding: 25px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); }
    .card h3 { color: var(--text-main); margin-top: 0; margin-bottom: 20px; font-weight: 600; font-size: 1.4rem; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 10px; }

    /* FORM / INPUTS */
    .checkbox-group { display: flex; align-items: center; margin-bottom: 15px; }
    .checkbox-group input[type="radio"], .checkbox-group input[type="checkbox"] { margin-right: 10px; width: 16px; height: 16px; border-radius: 4px; border: 1px solid var(--text-muted); background: transparent; appearance: none; cursor: pointer; position: relative; }
    .checkbox-group input:checked::before { content: '‚úì'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--primary-color); font-size: 14px; font-weight: bold; }
    .checkbox-group label { color: var(--text-main); font-size: 1rem; cursor: pointer; }
    .profile-controls { margin-bottom: 25px; display: flex; flex-direction: column; gap: 15px;}
    #ranked-options { margin-bottom: 10px; }

    /* RANK GRID */
    .rank-selector-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px; margin-top: 15px; }
    .rank-item { background-color: rgba(255,255,255,0.05); border: 2px solid transparent; border-radius: 8px; padding: 10px 5px; text-align: center; cursor: pointer; font-size: 0.8rem; font-weight: 500; transition: all 0.2s; }
    .rank-item:hover { border-color: rgba(255,255,255,0.2); }
    .rank-item.selected { border-color: var(--primary-color); background-color: rgba(34, 197, 94, 0.15); font-weight: 700; color: var(--primary-color); }
    .rank-item img { width: 30px; height: 30px; display: block; margin: 0 auto 5px; }

    /* BUTTONS */
    .action-btn { background-color: var(--primary-color); color: var(--bg-dark); border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; font-size: 1rem; }
    .action-btn:hover { background-color: #10b981; }
    .btn-secondary { background-color: var(--bg-card); color: var(--primary-color); border: 1px solid var(--primary-color); }
    .btn-secondary:hover { background-color: rgba(34, 197, 94, 0.1); }
    .action-btn:disabled { background-color: var(--text-muted); cursor: not-allowed; }

    /* ------------------------------------------- */
    /* SIDEBAR SOCIALE (Amis - Retractable logic) */
    /* ------------------------------------------- */
    .social-sidebar { 
        width: var(--sidebar-width); 
        min-height: calc(100vh - 80px); 
        background-color: #172031; 
        padding: 20px; 
        position: fixed; 
        right: 0; /* CORRIG√â : Assure que la barre est bien ancr√©e √† droite */
        top: 80px; 
        z-index: 700; 
        border-left: 1px solid rgba(255,255,255,0.05); 
        transition: transform 0.3s ease;
    }
    .social-sidebar.collapsed {
        transform: translateX(var(--sidebar-width)); /* SORT LA SIDEBAR DE L'√âCRAN */
    }
    
    /* Bouton pour basculer la sidebar */
    #sidebar-toggle {
        position: fixed;
        right: var(--sidebar-width); /* Le positionne √† c√¥t√© de la sidebar */
        top: 150px;
        z-index: 701;
        background: var(--bg-card);
        color: var(--primary-color);
        border: 1px solid rgba(255,255,255,0.1);
        border-right: none;
        padding: 8px 12px;
        border-radius: 8px 0 0 8px;
        cursor: pointer;
        transition: transform 0.3s ease;
    }
    /* D√©place le bouton avec la sidebar quand elle est r√©tract√©e */
    .social-sidebar.collapsed + #sidebar-toggle {
        transform: translateX(var(--sidebar-width));
    }
    #sidebar-toggle svg {
        width: 20px;
        height: 20px;
    }

    /* Le reste des styles sociaux et chat... (inchang√©s) */
    .friend-card { background-color: var(--bg-card); padding: 12px; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: background-color 0.2s; display: flex; justify-content: space-between; align-items: center; }
    .friend-card:hover { background-color: #2b3a50; }
    .friend-request-title { color: var(--text-muted); font-size: 0.8rem; margin-top: 10px; margin-bottom: 5px; }
    .request-actions button { margin-left: 5px; padding: 4px 8px; font-size: 0.7rem; border-radius: 4px; }
    .request-actions .btn-primary { background-color: #10b981; }
    .request-actions .btn-secondary { border-color: #ef4444; color: #ef4444; }
    #friend-notif { text-align: center; color: var(--primary-color); font-size: 0.9rem; margin-top: 10px; }

    /* CHAT WINDOWS */
    /* Position de la fen√™tre de chat ajust√©e pour laisser la place √† la social-sidebar */
    .chat-container { position: fixed; bottom: 0; right: calc(var(--sidebar-width) + 20px); display: flex; gap: 10px; z-index: 900; }
    .chat-window { width: 300px; height: 400px; background-color: var(--bg-card); border-radius: 8px 8px 0 0; overflow: hidden; box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.3); display: flex; flex-direction: column; }
    .chat-header { background-color: var(--primary-color); color: var(--bg-dark); padding: 10px; font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .chat-header span:last-child { font-size: 1.2rem; }
    .chat-body { flex-grow: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; font-size: 0.9rem; }
    .chat-body .msg { max-width: 80%; padding: 8px 12px; border-radius: 15px; }
    .chat-body .msg.self { background-color: var(--primary-color); color: var(--bg-dark); align-self: flex-end; border-bottom-right-radius: 0; }
    .chat-body .msg.other { background-color: #334155; color: var(--text-main); align-self: flex-start; border-bottom-left-radius: 0; }
    .chat-input-area { padding: 10px; border-top: 1px solid #334155; }
    .chat-input-area input { width: 100%; padding: 8px; border: 1px solid #475569; border-radius: 4px; background-color: #1e293b; color: var(--text-main); outline: none; }

    /* RESPONSIVE */
    @media (max-width: 1200px) {
        .social-sidebar { width: 280px; --sidebar-width: 280px; }
        .game-content-area { max-width: calc(100% - 280px - 60px); }
        #sidebar-toggle { right: 280px; }
        .chat-container { right: 300px; } /* Ajust√© pour la nouvelle largeur */
    }
    @media (max-width: 900px) {
        /* En mode mobile, empilement vertical */
        .game-content-area { max-width: 100%; margin: 20px; }
        .game-settings-layout { flex-direction: column; gap: 0; }
        /* La sidebar sociale redevient relative et non-collapsable en bas */
        .social-sidebar { position: relative; width: 100%; top: auto; right: auto; border-left: none; border-bottom: 1px solid rgba(255,255,255,0.05); transform: none !important; padding: 20px; }
        #sidebar-toggle { display: none; } /* On cache le bouton de bascule */
        .chat-container { right: 10px; } /* Le chat se d√©cale en bas √† droite */
    }
  </style>
</head>
<body>
  <header>
    <a href="/dashboard" class="logo">MatchMates</a>
    <div class="nav-links">
      <a href="/dashboard">Dashboard</a>
      <a href="/profile">Profil</a>
      <a href="/logout">D√©connexion</a>
    </div>
  </header>

  <main>
    <button id="sidebar-toggle" onclick="toggleSocialSidebar()">
        <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
    </button>
    
    <div class="game-content-area">
        <h1 id="game-title">Chargement du Jeu...</h1>

        <div class="game-settings-layout">
            
            <div class="settings-column"> 
                
                <div class="card">
                    <h3>Ton profil de joueur</h3>
                    <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 15px;">
                        Configurez votre style de jeu pour trouver des partenaires compatibles.
                    </p>

                    <div class="profile-controls">
                        <div id="ranked-options" style="display: flex; gap: 20px;">
                            <div class="checkbox-group">
                                <input type="radio" id="ranked" name="mode" value="ranked" onchange="toggleRanks(true)">
                                <label for="ranked">Class√©</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="radio" id="unrank" name="mode" value="unrank" onchange="toggleRanks(true)">
                                <label for="unrank">Non class√©</label>
                            </div>
                        </div>
                        
                        <div class="checkbox-group">
                            <input type="checkbox" id="discord-vocal" onchange="saveGameSettings()">
                            <label for="discord-vocal">Vocal Discord</label>
                        </div>
                    </div>

                    <div id="rank-selector" style="display: none;">
                        <div class="sidebar-section-title" style="margin-top:0; color: #cbd5e1; font-size: 0.9rem;">Mon rang actuel</div>
                        <div id="rank-grid" class="rank-selector-grid">
                            </div>
                    </div>

                    <div style="margin-top: 25px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 20px;">
                        <button class="action-btn btn-primary" id="publish-profile-btn" onclick="publishProfile()" style="width: 100%;">
                            üì¢ Publier mon profil
                        </button>
                        <div id="publish-status" style="font-size:0.8rem; text-align:center; margin-top:10px; min-height: 1.2em;"></div>
                    </div>
                </div>

                <div class="card" id="partner-profile-card">
                    <h3>üéØ Les joueurs que tu recherches</h3>
                    <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 15px;">
                        D√©finis les crit√®res des joueurs que tu souhaites rencontrer.
                    </p>

                    <div class="profile-controls">
                        <div id="partner-ranked-options" style="display: flex; gap: 20px;">
                            <div class="checkbox-group">
                                <input type="radio" id="partner-ranked" name="partner-mode" value="ranked" onchange="togglePartnerRanks(true)">
                                <label for="partner-ranked">Class√©</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="radio" id="partner-unrank" name="partner-mode" value="unrank" onchange="togglePartnerRanks(true)">
                                <label for="partner-unrank">Non class√©</label>
                            </div>
                        </div>
                        
                        <div class="checkbox-group">
                            <input type="checkbox" id="partner-discord-vocal" onchange="savePartnerPreferences()">
                            <label for="partner-discord-vocal">Vocal Discord (requis)</label>
                        </div>
                    </div>

                    <div id="partner-rank-selector" style="display: none;">
                        <div class="sidebar-section-title" style="margin-top:0; color: #cbd5e1; font-size: 0.9rem;">Rang minimum recherch√©</div>
                        <div id="partner-rank-grid" class="rank-selector-grid">
                            </div>
                    </div>

                    <div style="margin-top: 25px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 20px;">
                        <button class="action-btn btn-primary" style="width: 100%;" onclick="findPlayers()">
                            üîç Trouver des joueurs !
                        </button>
                    </div>
                </div>

                <div class="card" id="match-results-card" style="display:none;">
                    <h3>Joueurs trouv√©s (Matchs)</h3>
                    <div id="match-list">
                        </div>
                    <div id="no-match-message" style="text-align:center; color:var(--text-muted); font-size:0.9rem; padding-top:10px; display:none;">
                        Aucun joueur trouv√© correspondant √† vos crit√®res.
                    </div>
                </div>

            </div>

            <div class="settings-column" style="flex: 0.6;"> 
                <div class="card">
                    <h3 style="font-size: 1.2rem;">Actualit√©s & Infos</h3>
                    <p style="color: var(--text-muted);">
                        Ici, vous pourriez int√©grer des actualit√©s, des statistiques ou d'autres informations sp√©cifiques au jeu (via une API de jeu ou des donn√©es fictives).
                    </p>
                    
                    <div style="margin-top: 25px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 15px;">
                        <h4 style="font-size: 0.95rem; margin-bottom: 5px;">Description de Profil</h4>
                        <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 15px; background: rgba(255,255,255,0.02); padding: 10px; border-radius: 6px;">
                            "Je suis un joueur orient√© support, cherchant une √©quipe chill pour monter en Platine. Je suis dispo le soir apr√®s 20h !"
                        </p>
                        <button class="action-btn btn-secondary" style="width: 100%; font-size: 0.85rem; padding: 8px 15px;">
                            üîó Lier compte {{ gameId }}
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div> <div class="social-sidebar" id="social-sidebar">
      <h3>Social</h3>

      <div class="card" style="background: rgba(255,255,255,0.05); margin-bottom: 20px; padding: 15px;">
        <form onsubmit="sendFriendRequest(event)">
          <input type="text" id="friend-username" placeholder="Pseudo √† ajouter" style="width: calc(100% - 70px); padding: 8px; border-radius: 4px; border: 1px solid #475569; background: #1e293b; color: var(--text-main);" required>
          <button type="submit" class="action-btn" style="padding: 8px 10px; margin-left: 5px;">+ Ami</button>
        </form>
        <div id="friend-notif"></div>
      </div>

      <div id="friend-requests-list" style="margin-bottom: 20px;">
        </div>
      
      <div id="friends-list">
        <p class="sidebar-section-title">Mes Amis</p>
        </div>

    </div>
  </main>

  <div class="chat-container" id="chat-container"></div>
  
  <script>
    // Variables globales
    const chatContainer = document.getElementById('chat-container');
    const friendNotif = document.getElementById('friend-notif');
    const friendsListEl = document.getElementById('friends-list');
    const friendRequestsListEl = document.getElementById('friend-requests-list');
    const pathSegments = window.location.pathname.split('/');
    const gameId = pathSegments[pathSegments.length - 1]; // ex: 'valorant'

    let currentRankSelection = null;
    let currentPartnerRankSelection = null;
    let activeChats = {}; // Ajout√© pour le suivi du chat

    // D√©finitions des rangs (√† adapter par jeu)
    const RANKS = {
      valorant: [
        { name: 'Fer', img: 'fer.png' }, { name: 'Bronze', img: 'bronze.png' }, { name: 'Argent', img: 'argent.png' }, 
        { name: 'Or', img: 'or.png' }, { name: 'Platine', img: 'platine.png' }, { name: 'Diamant', img: 'diamant.png' }, 
        { name: 'Ascendant', img: 'ascendant.png' }, { name: 'Immortel', img: 'immortel.png' }, { name: 'Radiant', img: 'radiant.png' },
      ],
      lol: [
        { name: 'Fer', img: 'fer_lol.png' }, { name: 'Bronze', img: 'bronze_lol.png' }, { name: 'Argent', img: 'argent_lol.png' }, 
        { name: 'Or', img: 'or_lol.png' }, { name: 'Platine', img: 'platine_lol.png' }, { name: '√âmeraude', img: 'emeraude_lol.png' }, 
        { name: 'Diamant', img: 'diamant_lol.png' }, { name: 'Ma√Ætre', img: 'maitre_lol.png' }, { name: 'Grand Ma√Ætre', img: 'gmaitre_lol.png' }, 
        { name: 'Challenger', img: 'challenger_lol.png' },
      ]
    };

    // ====================================================
    // --- LOGIQUE SIDEBAR SOCIALE RETRACTABLE (MAINTENUE) ---
    // ====================================================
    window.toggleSocialSidebar = function() {
        const sidebar = document.getElementById('social-sidebar');
        const isCollapsed = sidebar.classList.toggle('collapsed');
        localStorage.setItem('socialSidebarCollapsed', isCollapsed);
    }
    
    // Auto-ex√©cut√©e au chargement de la page
    (async function() {

        // ====================================================
        // --- LOGIQUE G√âN√âRALE ET INITIALISATION ---
        // ====================================================

        // Initialisation de la sidebar r√©tractable
        if (localStorage.getItem('socialSidebarCollapsed') === 'true') {
            document.getElementById('social-sidebar').classList.add('collapsed');
        }

        // R√©cup√©rer le titre du jeu pour l'affichage
        function updateGameTitle() {
            const gameTitleEl = document.getElementById('game-title');
            const titleMap = {
                'valorant': 'VALORANT - Matchmaking',
                'lol': 'League of Legends - Matchmaking',
            };
            gameTitleEl.textContent = titleMap[gameId] || `Jeu : ${gameId}`;
        }
        updateGameTitle();

        // Cr√©ation des √©l√©ments de rang dans le DOM
        function setupRankGrids(gameRanks) {
            const rankGrid = document.getElementById('rank-grid');
            const partnerRankGrid = document.getElementById('partner-rank-grid');
            rankGrid.innerHTML = '';
            partnerRankGrid.innerHTML = '';

            gameRanks.forEach(rank => {
                const playerItem = createRankItem(rank.name, (e) => selectRank(e, 'player'));
                rankGrid.appendChild(playerItem);

                const partnerItem = createRankItem(rank.name, (e) => selectRank(e, 'partner'));
                partnerRankGrid.appendChild(partnerItem);
            });
        }

        function createRankItem(rankName, onClickHandler) {
            const item = document.createElement('div');
            item.className = 'rank-item';
            item.setAttribute('data-rank', rankName);
            item.innerHTML = `<span>${rankName}</span>`;
            item.onclick = onClickHandler;
            return item;
        }


        // ====================================================
        // --- LOGIQUE PROFIL JOUEUR (Sauvegarde) ---
        // ====================================================

        window.selectRank = function(event, type) {
            const rankItem = event.currentTarget;
            const rankName = rankItem.getAttribute('data-rank');
            const gridId = type === 'player' ? 'rank-grid' : 'partner-rank-grid';
            const grid = document.getElementById(gridId);

            grid.querySelectorAll('.rank-item').forEach(item => item.classList.remove('selected'));
            rankItem.classList.add('selected');

            if (type === 'player') {
                currentRankSelection = rankItem;
                saveGameSettings();
            } else {
                currentPartnerRankSelection = rankItem;
                savePartnerPreferences();
            }
        }

        window.toggleRanks = function(shouldSave = true) {
            const isRanked = document.getElementById('ranked').checked;
            document.getElementById('rank-selector').style.display = isRanked ? 'block' : 'none';
            if (!isRanked) {
                document.getElementById('rank-grid').querySelectorAll('.rank-item').forEach(item => item.classList.remove('selected'));
                currentRankSelection = null;
            }
            if (shouldSave) saveGameSettings();
        }

        window.saveGameSettings = function() {
            const mode = document.getElementById('ranked').checked ? 'ranked' : 'unrank';
            const rank = currentRankSelection ? currentRankSelection.getAttribute('data-rank') : null;
            const vocal = document.getElementById('discord-vocal').checked;

            const settings = { mode, rank, vocal };
            localStorage.setItem(`gameSettings-${gameId}`, JSON.stringify(settings));
        }

        function loadGameSettings() {
            const savedSettings = localStorage.getItem(`gameSettings-${gameId}`);
            if (!savedSettings) {
                document.getElementById('ranked').checked = true;
                document.getElementById('discord-vocal').checked = false;
                toggleRanks(false);
                return;
            }

            const settings = JSON.parse(savedSettings);
            document.getElementById(settings.mode).checked = true;
            document.getElementById('discord-vocal').checked = settings.vocal;
            
            toggleRanks(false);

            if (settings.rank && settings.mode === 'ranked') {
                const rankItem = document.querySelector(`#rank-grid [data-rank="${settings.rank}"]`);
                if (rankItem) {
                    rankItem.classList.add('selected');
                    currentRankSelection = rankItem;
                }
            }
        }

        // ====================================================
        // --- LOGIQUE PR√âF√âRENCES PARTENAIRE (API) ---
        // ====================================================

        window.savePartnerPreferences = async function() {
            const mode = document.getElementById('partner-ranked').checked ? 'ranked' : 'unrank';
            const min_rank = currentPartnerRankSelection ? currentPartnerRankSelection.getAttribute('data-rank') : null;
            const vocal_required = document.getElementById('partner-discord-vocal').checked;

            const data = { mode, min_rank, vocal_required };
            
            try {
                await fetch(`/api/partner-preferences/${gameId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } catch (e) {
                console.error("Erreur de sauvegarde des pr√©f√©rences partenaire:", e);
            }
        }

        async function loadPartnerPreferences() {
            try {
                const response = await fetch(`/api/partner-preferences/${gameId}`);
                if (!response.ok) throw new Error('Failed to load partner preferences');
                
                const prefs = await response.json();
                
                document.getElementById(`partner-${prefs.mode}`).checked = true;
                document.getElementById('partner-discord-vocal').checked = prefs.vocal_required;
                
                togglePartnerRanks(false);

                if (prefs.min_rank && prefs.mode === 'ranked') {
                    const rankItem = document.querySelector(`#partner-rank-grid [data-rank="${prefs.min_rank}"]`);
                    if (rankItem) {
                        rankItem.classList.add('selected');
                        currentPartnerRankSelection = rankItem;
                    }
                }

            } catch (e) {
                document.getElementById('partner-ranked').checked = true;
                document.getElementById('partner-discord-vocal').checked = false;
                togglePartnerRanks(false);
            }
        }

        window.togglePartnerRanks = function(shouldSave = true) {
            const isRanked = document.getElementById('partner-ranked').checked;
            document.getElementById('partner-rank-selector').style.display = isRanked ? 'block' : 'none';
            if (!isRanked) {
                document.getElementById('partner-rank-grid').querySelectorAll('.rank-item').forEach(item => item.classList.remove('selected'));
                currentPartnerRankSelection = null;
            }
            if (shouldSave) savePartnerPreferences();
        }

        // ====================================================
        // --- LOGIQUE PROFIL JOUEUR PUBLICATION/RECHERCHE ---
        // ====================================================

        window.publishProfile = async function() {
            const statusEl = document.getElementById('publish-status');
            const btn = document.getElementById('publish-profile-btn');
            
            const mode = document.getElementById('ranked').checked ? 'ranked' : 'unrank';
            const rank = currentRankSelection ? currentRankSelection.getAttribute('data-rank') : null;
            const vocal_discord = document.getElementById('discord-vocal').checked;

            const data = { mode, rank, vocal_discord };
            
            statusEl.textContent = "Publication en cours...";
            btn.disabled = true;

            try {
                const response = await fetch(`/api/publish-profile/${gameId}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
                });
                
                const result = await response.json();

                if (response.ok && result.status === 'profile_published') {
                    statusEl.textContent = "‚úÖ Profil publi√© ! Les autres joueurs peuvent vous trouver.";
                    statusEl.style.color = '#22c55e';
                } else {
                    throw new Error(result.error || 'Erreur inconnue');
                }

            } catch (e) {
                statusEl.textContent = "‚ùå Erreur de publication. Veuillez v√©rifier votre rang/mode.";
                statusEl.style.color = '#ef4444';
            } finally {
                btn.disabled = false;
                setTimeout(() => statusEl.textContent = '', 5000);
            }
        }

        window.findPlayers = async function() {
            const matchCard = document.getElementById('match-results-card');
            const matchList = document.getElementById('match-list');
            const noMatchMessage = document.getElementById('no-match-message');
            
            matchCard.style.display = 'block';
            matchList.innerHTML = '<p style="text-align:center; color:var(--text-muted);">Recherche en cours...</p>';
            noMatchMessage.style.display = 'none';

            try {
                const response = await fetch(`/api/match-players/${gameId}`);
                if (!response.ok) throw new Error('Failed to fetch matches');
                const data = await response.json();
                
                if (data.matches && data.matches.length > 0) {
                    renderMatches(data.matches);
                } else {
                    matchList.innerHTML = '';
                    noMatchMessage.style.display = 'block';
                }

            } catch (e) {
                matchList.innerHTML = '<p style="text-align:center; color:#ef4444;">Une erreur est survenue lors de la recherche.</p>';
            }
        }

        function renderMatches(matches) {
            const matchList = document.getElementById('match-list');
            matchList.innerHTML = '';

            matches.forEach(match => {
                const card = document.createElement('div');
                card.className = 'card match-profile-card';
                card.style.marginBottom = '10px'; card.style.padding = '15px'; card.style.display = 'flex';
                card.style.alignItems = 'center'; card.style.justifyContent = 'space-between';
                
                let rankText = match.rank ? `Rang: ${match.rank}` : 'Non Class√©';
                let vocalIcon = match.vocal ? ' üé§' : '';
                
                card.innerHTML = `
                    <div style="display:flex; flex-direction:column; gap:3px;">
                        <div style="font-weight: 600; font-size:1.1rem; color: white;">${match.username} ${vocalIcon}</div>
                        <div style="color: var(--text-muted); font-size: 0.85rem;">${rankText}</div>
                    </div>
                    <div class="actions-bar" style="margin: 0; gap: 5px;">
                        <button class="action-btn btn-secondary" style="padding: 6px 12px; font-size: 0.8rem;" onclick="sendFriendRequestByUsername('${match.username}')">
                            + Ami
                        </button>
                        <button class="action-btn btn-primary" style="padding: 6px 12px; font-size: 0.8rem;" onclick="openChat('${match.username}')">
                            üí¨ Message
                        </button>
                    </div>
                `;
                matchList.appendChild(card);
            });
        }
        
        window.sendFriendRequestByUsername = async function(username) {
            try {
                const res = await fetch('/api/friends/request', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ toUsername: username })
                });
                const data = await res.json();
                if(data.ok) {
                    alert(`Demande d'ami envoy√©e √† ${username} !`);
                    loadSocial();
                } else {
                    alert(`Erreur : ${data.error}`);
                }
            } catch (e) {
                alert("Erreur serveur lors de l'envoi de la demande.");
            }
        }


        // ====================================================
        // --- LOGIQUE G√âN√âRALE SOCIALE ---
        // ====================================================
        
        window.sendFriendRequest = async function(e) {
            e.preventDefault();
            const usernameInput = document.getElementById('friend-username');
            const toUsername = usernameInput.value.trim();
            usernameInput.value = '';
            
            const res = await fetch('/api/friends/request', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ toUsername })
            });
            const data = await res.json();

            if (data.ok) {
                friendNotif.innerText = `Demande envoy√©e √† ${toUsername}!`;
            } else {
                friendNotif.innerText = `Erreur : ${data.error}`;
            }
            setTimeout(() => friendNotif.innerText = "", 3000);
            loadSocial();
        }

        window.handleRequest = async function(id, action) {
            await fetch(`/api/friends/requests/${id}/${action}`, { method: 'POST' });
            loadSocial();
        }

        window.openChat = (username) => {
            if (document.getElementById(`cw-${username}`)) return;

            const chatWindow = document.createElement('div');
            chatWindow.className = 'chat-window';
            chatWindow.id = `cw-${username}`;
            chatWindow.innerHTML = `
                <div class="chat-header" onclick="closeChat('${username}')">
                    <span>${username}</span>
                    <span>‚úñ</span>
                </div>
                <div class="chat-body" id="msg-${username}"></div>
                <form class="chat-input-area" onsubmit="sendMessage(event, '${username}')">
                    <input type="text" placeholder="√âcrire un message..." autocomplete="off">
                </form>
            `;
            chatContainer.appendChild(chatWindow);
            fetchMessages(username);
            
            activeChats[username] = setInterval(() => fetchMessages(username), 3000);
        }

        window.closeChat = (username) => {
            const el = document.getElementById(`cw-${username}`);
            if (el) el.remove();
            if (activeChats[username]) {
                clearInterval(activeChats[username]);
                delete activeChats[username];
            }
        }

        window.sendMessage = async function(e, username) {
            e.preventDefault();
            const input = e.target.querySelector('input');
            if (!input.value.trim()) return;

            await fetch('/api/messages', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ toUsername: username, content: input.value.trim() })
            });
            input.value = "";
            fetchMessages(username);
        }

        async function fetchMessages(username) {
            const chatBody = document.getElementById(`msg-${username}`);
            if (!chatBody) return;

            const res = await fetch(`/api/messages/${username}`);
            const data = await res.json();
            
            if (!data.messages) return;

            const isScrolledToBottom = chatBody.scrollHeight - chatBody.clientHeight <= chatBody.scrollTop + 1;
            
            chatBody.innerHTML = data.messages.map(msg => `
                <div class="msg ${msg.fromSelf ? 'self' : 'other'}">${msg.content}</div>
            `).join('');

            if (isScrolledToBottom || data.messages.length === 1) {
                chatBody.scrollTop = chatBody.scrollHeight;
            }
        }

        async function loadSocial() {
            try {
                const friendsRes = await fetch('/api/friends');
                const friendsData = await friendsRes.json();
                renderFriends(friendsData.friends || []);

                const requestsRes = await fetch('/api/friends/requests');
                const requestsData = await requestsRes.json();
                renderRequests(requestsData.incoming || [], requestsData.outgoing || []);

            } catch (e) {
                console.error("Erreur chargement social:", e);
            }
        }

        function renderFriends(friends) {
            friendsListEl.innerHTML = '<p class="sidebar-section-title">Mes Amis</p>';
            if (!friends.length) {
                friendsListEl.innerHTML += '<p style="color:var(--text-muted); font-size:0.9rem;">Aucun ami pour l\'instant.</p>';
                return;
            }

            friends.forEach(friend => {
                const card = document.createElement('div');
                card.className = 'friend-card';
                card.textContent = friend.username;
                card.addEventListener('click', () => openChat(friend.username));
                friendsListEl.appendChild(card);
            });
        }

        function renderRequests(incoming, outgoing) {
            friendRequestsListEl.innerHTML = '';

            if (incoming.length > 0) {
                const title = document.createElement('p');
                title.textContent = `Demandes re√ßues (${incoming.length})`;
                title.className = 'friend-request-title';
                friendRequestsListEl.appendChild(title);

                incoming.forEach(req => {
                    const card = document.createElement('div');
                    card.className = 'friend-card';
                    card.innerHTML = `
                        <span>${req.from_username}</span>
                        <div class="request-actions">
                            <button class="action-btn btn-primary" onclick="handleRequest(${req.id}, 'accept')">Accepter</button>
                            <button class="action-btn btn-secondary" onclick="handleRequest(${req.id}, 'reject')">Refuser</button>
                        </div>
                    `;
                    friendRequestsListEl.appendChild(card);
                });
            }

            if (outgoing.length > 0) {
                const title = document.createElement('p');
                title.textContent = `Demandes envoy√©es en attente (${outgoing.length})`;
                title.className = 'friend-request-title';
                friendRequestsListEl.appendChild(title);

                outgoing.forEach(req => {
                    const card = document.createElement('div');
                    card.className = 'friend-card';
                    card.style.opacity = 0.7;
                    card.innerHTML = `
                        <span>${req.to_username} (En attente)</span>
                    `;
                    friendRequestsListEl.appendChild(card);
                });
            }
        }

        // ====================================================
        // --- INITIALISATION FINALE ---
        // ====================================================
        
        const gameRanks = RANKS[gameId] || RANKS.valorant;
        setupRankGrids(gameRanks);

        loadGameSettings();
        await loadPartnerPreferences();

        loadSocial();
        setInterval(loadSocial, 5000);
        
    })();
  </script>
</body>
</html>
