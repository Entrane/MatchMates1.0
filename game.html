<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Jeu ‚Äì MatchMates</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />

  <style>
    /* On r√©utilise les m√™mes variables et styles de base pour la coh√©rence */
    :root { --primary-color: #22c55e; --sidebar-width: 320px; --bg-dark: #0f172a; --bg-card: #1e293b; --text-main: #f1f5f9; --text-muted: #94a3b8; }
    body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Inter', sans-serif; margin: 0; overflow-x: hidden; }
    
    /* HEADER */
    header { display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(10px); position: fixed; top: 0; width: 100%; z-index: 800; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    .logo { font-size: 1.8rem; font-weight: 800; color: var(--primary-color); text-decoration: none; }
    .nav-links a { margin-left: 25px; color: var(--text-main); text-decoration: none; font-weight: 500; opacity: 0.8; transition: opacity 0.2s; }
    .nav-links a:hover { opacity: 1; }
    .user-info { display: flex; align-items: center; }
    .user-info span { margin-right: 15px; font-weight: 600; }
    .logout-btn { background: none; border: 1px solid var(--text-muted); color: var(--text-muted); padding: 5px 12px; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
    .logout-btn:hover { border-color: var(--primary-color); color: var(--primary-color); }

    /* LAYOUT PRINCIPAL */
    .game-page-layout { display: flex; max-width: 1400px; margin: 90px auto 40px; padding: 0 20px; gap: 30px; }
    .game-sidebar { width: var(--sidebar-width); flex-shrink: 0; }
    .game-content-area { flex-grow: 1; display: flex; flex-direction: column; gap: 25px; }
    
    @media (max-width: 1050px) {
        .game-page-layout { flex-direction: column; align-items: center; }
        .game-sidebar { width: 100%; max-width: 600px; }
        .game-content-area { width: 100%; max-width: 800px; }
    }

    /* CARTES & STYLES COMMUNS */
    .card { background-color: var(--bg-card); padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); }
    .card h3 { color: var(--primary-color); margin-top: 0; font-size: 1.4rem; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 10px; margin-bottom: 15px; }
    .action-btn { background-color: var(--primary-color); color: var(--bg-dark); border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background-color 0.2s; }
    .action-btn:hover { background-color: #16a34a; }
    .btn-secondary { background: none; border: 1px solid var(--text-muted); color: var(--text-muted); }
    .btn-secondary:hover { border-color: var(--primary-color); color: var(--primary-color); background-color: rgba(34, 197, 94, 0.1); }
    
    /* GAME INFO */
    #game-info h1 { font-size: 2.5rem; margin-top: 0; margin-bottom: 5px; }
    #game-info p { color: var(--text-muted); margin-bottom: 15px; }
    #game-logo { width: 100%; max-height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 15px; }
    .favorite-btn { width: 100%; margin-top: 15px; }

    /* PROFIL & RECHERCHE (FILTRES) */
    .profile-controls { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
    .checkbox-group { display: flex; align-items: center; gap: 10px; padding: 8px 0; }
    .checkbox-group input[type="radio"], .checkbox-group input[type="checkbox"] { 
        width: 18px; height: 18px; margin: 0; accent-color: var(--primary-color); cursor: pointer;
    }
    .checkbox-group label { font-size: 1rem; cursor: pointer; user-select: none; }
    #ranked-options { display: flex; gap: 20px; }
    #partner-ranked-options { display: flex; gap: 20px; } /* Style pour la nouvelle section */

    .rank-selector-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
    .rank-option { 
        padding: 8px; text-align: center; border-radius: 6px; 
        background-color: #0f172a; border: 1px solid rgba(255, 255, 255, 0.1); 
        cursor: pointer; transition: all 0.1s; font-size: 0.9rem;
    }
    .rank-option:hover { background-color: #1e293b; border-color: var(--primary-color); }
    .rank-option.selected { background-color: var(--primary-color); color: var(--bg-dark); font-weight: 600; border-color: var(--primary-color); }
    
    .sidebar-section-title { font-weight: 600; color: var(--text-main); margin: 15px 0 5px 0; font-size: 1rem; opacity: 0.9; }

    /* CHAT TEMPORAIRE (Pour le contexte) */
    #chat-container { position: fixed; bottom: 0; right: 0; z-index: 900; display: flex; align-items: flex-end; }
    .chat-window { width: 280px; height: 350px; background: var(--bg-card); border-radius: 8px 8px 0 0; margin-right: 15px; box-shadow: 0 0 15px rgba(0,0,0,0.5); display: flex; flex-direction: column; }
    .chat-header { background: var(--primary-color); color: var(--bg-dark); padding: 10px; border-radius: 8px 8px 0 0; cursor: pointer; display: flex; justify-content: space-between; font-weight: 600; }
    .chat-body { flex-grow: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; font-size: 0.9rem; }
    .chat-body::-webkit-scrollbar { width: 5px; }
    .chat-body::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); border-radius: 10px; }
    .message { max-width: 80%; padding: 6px 10px; border-radius: 10px; margin: 3px 0; }
    .msg-self { background: var(--primary-color); color: var(--bg-dark); align-self: flex-end; border-bottom-right-radius: 2px; }
    .msg-other { background: #334155; color: var(--text-main); align-self: flex-start; border-bottom-left-radius: 2px; }
    .chat-input-area { padding: 8px 10px; border-top: 1px solid rgba(255,255,255,0.1); }
    .chat-input-area input { width: 100%; padding: 8px; border: none; border-radius: 5px; background: #0f172a; color: var(--text-main); }

  </style>
</head>
<body>

  <header>
    <a href="/dashboard" class="logo">MatchMates</a>
    <div class="nav-links">
        <a href="/dashboard">Accueil</a>
        <a href="/profile">Profil</a>
    </div>
    <div class="user-info">
        <span>Bienvenue, {{ username }}</span>
        <a href="/logout" class="logout-btn">D√©connexion</a>
    </div>
  </header>

  <main class="game-page-layout">
    
    <aside class="game-sidebar">
      <div class="card" id="game-info">
        <img id="game-logo" src="" alt="Logo du jeu">
        <h1 id="game-title">Chargement...</h1>
        <p id="game-description">Chargement des informations...</p>
        <button id="favorite-toggle-btn" class="action-btn favorite-btn" disabled>
          Ajouter aux Favoris
        </button>
      </div>
    </aside>

    <div class="game-content-area">

      <div class="card">
          <h3>Ton profil de joueur</h3>
          <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 15px;">
              Ces informations d√©terminent ton affichage pour les autres joueurs.
          </p>

          <div class="profile-controls">
              <div id="ranked-options" style="display: none;">
                  <div class="checkbox-group">
                      <input type="radio" id="ranked" name="mode" value="ranked" onchange="toggleRanks(true)">
                      <label for="ranked">Class√©</label>
                  </div>
                  <div class="checkbox-group">
                      <input type="radio" id="unrank" name="mode" value="unrank" onchange="toggleRanks(true)">
                      <label for="unrank">Non class√©</label>
                  </div>
              </div>
              
              <div class="checkbox-group">
                  <input type="checkbox" id="discord-vocal" onchange="saveGameSettings()">
                  <label for="discord-vocal">Vocal Discord</label>
              </div>
          </div>

          <div id="rank-selector" style="display: none;">
              <div class="sidebar-section-title" style="margin-top:0;">Mon rang actuel</div>
              <div id="rank-grid" class="rank-selector-grid">
                  </div>
          </div>
      </div>
      
      <div class="card" id="partner-profile-card">
          <h3>üéØ Les joueurs que tu recherches</h3>
          <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 15px;">
              D√©finis les crit√®res de tes co√©quipiers pour un match parfait.
          </p>

          <div class="profile-controls">
              <div id="partner-ranked-options" style="display: none;">
                  <div class="checkbox-group">
                      <input type="radio" id="partner-ranked" name="partner_mode" value="ranked" onchange="togglePartnerRanks(true)">
                      <label for="partner-ranked">Class√© uniquement</label>
                  </div>
                  <div class="checkbox-group">
                      <input type="radio" id="partner-unrank" name="partner_mode" value="unrank" onchange="togglePartnerRanks(true)">
                      <label for="partner-unrank">Non class√©</label>
                  </div>
              </div>
              
              <div class="checkbox-group">
                  <input type="checkbox" id="partner-discord-vocal" onchange="savePartnerSettings()">
                  <label for="partner-discord-vocal">Vocal requis</label>
              </div>
          </div>

          <div id="partner-rank-selector" style="display: none;">
              <div class="sidebar-section-title" style="margin-top:0;">Rang minimum recherch√©</div>
              <div id="partner-rank-grid" class="rank-selector-grid">
                  </div>
          </div>
          
          <div style="margin-top: 25px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 20px;">
              <button class="action-btn btn-primary" style="width: 100%;">
                  üîç Trouver des joueurs !
              </button>
          </div>
      </div>

    </div>

  </main>

  <div id="chat-container"></div>
  <script>
    // URL-safe ID du jeu (inject√© par le serveur)
    const gameId = "{{ gameId }}"; 

    // Donn√©es de simulation (√† remplacer par une vraie base de donn√©es de jeux plus tard)
    const MOCK_GAMES_DB = {
        'lol': {
            id: 'lol',
            title: 'League of Legends',
            description: 'Jeu comp√©titif MOBA 5v5.',
            logo: 'https://cdn.matchmates.gg/logos/lol.webp', // Lien fictif
            isCompetitive: true,
            ranks: ['Bronze', 'Silver', 'Gold', 'Platinum', 'Diamond', 'Master', 'Challenger']
        },
        'valorant': {
            id: 'valorant',
            title: 'VALORANT',
            description: 'FPS tactique 5v5 par Riot Games.',
            logo: 'https://cdn.matchmates.gg/logos/valorant.webp', // Lien fictif
            isCompetitive: true,
            ranks: ['Iron', 'Bronze', 'Silver', 'Gold', 'Platinum', 'Diamond', 'Ascendant', 'Immortal', 'Radiant']
        },
        'fortnite': {
            id: 'fortnite',
            title: 'Fortnite',
            description: 'Battle Royale populaire et cr√©atif.',
            logo: 'https://cdn.matchmates.gg/logos/fortnite.webp', // Lien fictif
            isCompetitive: false
        }
    };

    let gameData = null;
    let favoritesList = [];
    let rankSelection = null;
    let partnerRankSelection = null; // Nouvelle variable pour le rang du partenaire

    // Cl√© pour la sauvegarde locale (√† terme, tout passera par l'API)
    const gameSettingsKey = `mm_game_settings_${gameId}`;


    // ====================================================
    // 1. LOGIQUE G√âN√âRALE DE LA PAGE
    // ====================================================

    /** Charge les donn√©es du jeu, initialise l'interface et les param√®tres. */
    async function loadGameData() {
        gameData = MOCK_GAMES_DB[gameId];
        
        if (gameData) {
            // Affichage des infos de base
            document.getElementById('game-title').textContent = gameData.title;
            document.getElementById('game-description').textContent = gameData.description;
            document.getElementById('game-logo').src = gameData.logo;
            document.title = `${gameData.title} ‚Äì MatchMates`;

            // 1. Afficher les options Class√©/Unrank si le jeu a des rangs
            if (gameData.ranks && gameData.ranks.length > 0) {
                document.getElementById('ranked-options').style.display = 'flex';
                renderRanks(gameData.ranks);

                // NOUVEAU: Afficher et rendre les options pour le profil partenaire
                document.getElementById('partner-ranked-options').style.display = 'flex';
                renderPartnerRanks(gameData.ranks);
            }
            
            // 2. Charger les param√®tres sp√©cifiques au jeu (votre profil)
            loadGameSettings();
            
            // NOUVEAU: Charger les pr√©f√©rences de recherche de partenaire
            await loadPartnerSettings(); 
            
            // 3. Charger les favoris du compte utilisateur
            await loadUserFavorites();

        } else {
            // Gestion de jeu introuvable
            document.getElementById('game-title').textContent = 'Jeu Inconnu';
            document.getElementById('game-description').textContent = `Le jeu avec l'ID "${gameId}" n'a pas √©t√© trouv√©.`;
            document.getElementById('game-logo').src = '';
            document.getElementById('favorite-toggle-btn').disabled = true;
        }
    }


    // ====================================================
    // 2. LOGIQUE FAVORIS (API)
    // ====================================================

    /** Charge la liste des favoris de l'API et met √† jour le bouton. */
    async function loadUserFavorites() {
        try {
            const response = await fetch('/api/favorites');
            const data = await response.json();
            favoritesList = data.favorites || [];
            updateFavoriteButton();
        } catch (error) {
            console.error('Erreur chargement favoris:', error);
        }
    }

    /** Met √† jour l'affichage du bouton Favoris. */
    function updateFavoriteButton() {
        const btn = document.getElementById('favorite-toggle-btn');
        const isFavorite = favoritesList.includes(gameId);
        
        btn.disabled = false;
        if (isFavorite) {
            btn.textContent = '‚òÖ Retirer des Favoris';
            btn.classList.remove('btn-secondary');
            btn.classList.add('action-btn');
        } else {
            btn.textContent = '‚òÜ Ajouter aux Favoris';
            btn.classList.remove('action-btn');
            btn.classList.add('btn-secondary');
        }
    }

    /** G√®re l'ajout/suppression via l'API. */
    async function toggleFavorite() {
        try {
            const response = await fetch(`/api/favorites/${gameId}`, { method: 'POST' });
            const data = await response.json();
            
            if (data.status === 'added') {
                favoritesList.push(gameId);
            } else if (data.status === 'removed') {
                favoritesList = favoritesList.filter(id => id !== gameId);
            }
            updateFavoriteButton();
        } catch (error) {
            console.error('Erreur toggle favoris:', error);
        }
    }


    // ====================================================
    // 3. LOGIQUE PROFIL JOUEUR (Votre Profil - utilise localStorage pour l'instant)
    // ====================================================

    window.saveGameSettings = function() {
        const settings = {
            mode: document.getElementById('ranked').checked ? 'ranked' : 'unrank',
            rank: rankSelection ? rankSelection.getAttribute('data-rank') : null,
            vocal: document.getElementById('discord-vocal').checked
        };
        localStorage.setItem(gameSettingsKey, JSON.stringify(settings));
    };

    function loadGameSettings() {
        const savedSettings = JSON.parse(localStorage.getItem(gameSettingsKey));
        
        let settings = { mode: 'unrank', rank: null, vocal: false };
        if (savedSettings) {
            settings = savedSettings;
        }

        // 1. Mode Class√©/Unrank
        if (gameData.ranks && gameData.ranks.length > 0) {
            document.getElementById('ranked').checked = settings.mode === 'ranked';
            document.getElementById('unrank').checked = settings.mode === 'unrank';
            window.toggleRanks(false); // Charge l'√©tat sans sauvegarder imm√©diatement
        }

        // 2. Vocal Discord
        document.getElementById('discord-vocal').checked = settings.vocal;

        // 3. Rang s√©lectionn√©
        if (settings.mode === 'ranked' && settings.rank) {
            const rankEl = document.querySelector(`#rank-grid .rank-option[data-rank="${settings.rank}"]`);
            if (rankEl) {
                selectRank(rankEl, false); // Charge le rang sans sauvegarder imm√©diatement
            }
        }
    }

    function renderRanks(ranks) {
        const rankGrid = document.getElementById('rank-grid');
        rankGrid.innerHTML = '';
        ranks.forEach(rank => {
            const rankEl = document.createElement('div');
            rankEl.className = 'rank-option';
            rankEl.textContent = rank;
            rankEl.setAttribute('data-rank', rank);
            rankEl.onclick = () => selectRank(rankEl, true);
            rankGrid.appendChild(rankEl);
        });
    }

    window.selectRank = function(el, shouldSave = true) {
        if (rankSelection) {
            rankSelection.classList.remove('selected');
        }
        el.classList.add('selected');
        rankSelection = el;
        
        if (shouldSave) {
            saveGameSettings();
        }
    }

    window.toggleRanks = function(shouldSave = true) {
        const isRanked = document.getElementById('ranked').checked;
        const rankSelector = document.getElementById('rank-selector');

        if (isRanked && gameData.ranks) {
            rankSelector.style.display = 'block';
        } else {
            rankSelector.style.display = 'none';
            if (rankSelection) {
                rankSelection.classList.remove('selected');
                rankSelection = null;
            }
        }

        if (shouldSave) {
            saveGameSettings();
        }
    };


    // ====================================================
    // 4. LOGIQUE PROFIL PARTENAIRE (Recherche - utilise API)
    // ====================================================

    // A. Sauvegarde les param√®tres du partenaire via API
    window.savePartnerSettings = async function() {
        const settings = {
            mode: document.getElementById('partner-ranked').checked ? 'ranked' : 'unrank',
            // Si 'unrank' est coch√©, le rang minimum est NULL
            min_rank: document.getElementById('partner-ranked').checked ? 
                      (partnerRankSelection ? partnerRankSelection.getAttribute('data-rank') : null) : 
                      null,
            vocal_required: document.getElementById('partner-discord-vocal').checked
        };
        
        // Appel API pour sauvegarder
        try {
            await fetch(`/api/partner-preferences/${gameId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });
        } catch (e) {
            console.error("Erreur de sauvegarde des pr√©f√©rences partenaire:", e);
        }
    };

    // B. Charge les param√®tres du partenaire depuis l'API
    async function loadPartnerSettings() {
        try {
            const response = await fetch(`/api/partner-preferences/${gameId}`);
            const settings = await response.json();
            
            // 1. Mode Class√©/Unrank
            if (gameData.ranks && gameData.ranks.length > 0) {
                // Mettre √† jour l'interface
                document.getElementById('partner-ranked').checked = settings.mode === 'ranked';
                document.getElementById('partner-unrank').checked = settings.mode === 'unrank';
                
                // Afficher ou masquer le s√©lecteur de rang
                window.togglePartnerRanks(false); 
            }

            // 2. Vocal Discord
            document.getElementById('partner-discord-vocal').checked = settings.vocal_required;

            // 3. Rang s√©lectionn√©
            if (settings.mode === 'ranked' && settings.min_rank) {
                const rankEl = document.querySelector(`#partner-rank-grid .rank-option[data-rank="${settings.min_rank}"]`);
                if (rankEl) {
                    selectPartnerRank(rankEl, false); // Charge le rang sans sauvegarder
                }
            }
        } catch (e) {
            console.error("Erreur de chargement des pr√©f√©rences partenaire:", e);
        }
    }

    // C. Rend le s√©lecteur de rangs
    function renderPartnerRanks(ranks) {
        const rankGrid = document.getElementById('partner-rank-grid');
        rankGrid.innerHTML = '';
        ranks.forEach(rank => {
            const rankEl = document.createElement('div');
            rankEl.className = 'rank-option';
            rankEl.textContent = rank;
            rankEl.setAttribute('data-rank', rank);
            rankEl.onclick = () => selectPartnerRank(rankEl, true);
            rankGrid.appendChild(rankEl);
        });
    }

    // D. S√©lectionne un rang
    window.selectPartnerRank = function(el, shouldSave = true) {
        if (partnerRankSelection) {
            partnerRankSelection.classList.remove('selected');
        }
        el.classList.add('selected');
        partnerRankSelection = el;
        
        if (shouldSave) {
            savePartnerSettings();
        }
    }

    // E. Bascule l'affichage du s√©lecteur de rang
    window.togglePartnerRanks = function(shouldSave = true) {
        const isRanked = document.getElementById('partner-ranked').checked;
        const rankSelector = document.getElementById('partner-rank-selector');

        if (isRanked && gameData.ranks) {
            rankSelector.style.display = 'block';
        } else {
            rankSelector.style.display = 'none';
            if (partnerRankSelection) {
                partnerRankSelection.classList.remove('selected');
                partnerRankSelection = null;
            }
        }

        if (shouldSave) {
            savePartnerSettings();
        }
    };


    // ====================================================
    // 5. CHAT ET SOCIAUX (Logique r√©utilis√©e)
    // ====================================================

    // Logique Chat/Sociale (d√©j√† pr√©sente, inchang√©e)
    const chatContainer = document.getElementById('chat-container');
    const friendNotif = document.getElementById('friend-notif');
    let activeChats = {};

    window.loadSocial = async() => {
        // ... (Logique loadSocial)
    };
    window.hReq = async(id, a) => {
        // ... (Logique hReq)
    };
    window.openChat = (u) => {
        // ... (Logique openChat)
    };
    window.closeChat = (u) => {
        // ... (Logique closeChat)
    };
    window.sM = async(e, u) => {
        // ... (Logique sM)
    };
    async function fM(u) {
        // ... (Logique fM)
    }

    // √âcouteurs
    document.addEventListener('DOMContentLoaded', loadGameData);
    document.getElementById('favorite-toggle-btn').addEventListener('click', toggleFavorite);
  </script>
</body>
</html>
