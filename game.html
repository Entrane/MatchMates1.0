<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Jeu ‚Äì MatchMates</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />

  <style>
    /* On r√©utilise les m√™mes variables et styles de base pour la coh√©rence */
    :root { --primary-color: #22c55e; --sidebar-width: 320px; --bg-dark: #0f172a; --bg-card: #1e293b; --text-main: #f1f5f9; --text-muted: #94a3b8; }
    body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Inter', sans-serif; margin: 0; overflow-x: hidden; }
    
    /* HEADER */
    header { display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(10px); position: fixed; top: 0; width: 100%; z-index: 800; box-sizing: border-box; border-bottom: 1px solid rgba(255,255,255,0.05); }
    nav a { color: var(--text-muted); text-decoration: none; margin-left: 20px; font-size: 0.9rem; }
    nav a:hover { color: white; }

    /* LAYOUT GLOBAL PAGE JEU */
    .game-layout { max-width: 1300px; margin: 80px auto 40px; padding: 0 20px; }
    
    /* GRILLE PRINCIPALE (Menu √† gauche + Contenu √† droite) */
    .game-main-layout {
        display: grid;
        grid-template-columns: 320px 1fr; /* 320px pour la sidebar gauche, 1fr pour le contenu */
        gap: 30px;
        align-items: flex-start;
    }

    /* BARRE DE PR√âSENTATION GAUCHE (STICKY) */
    .game-sidebar-left {
        position: sticky;
        top: 100px; /* Commence 100px sous le header */
    }
    .game-sidebar-img {
        width: 100%;
        aspect-ratio: 3/4; /* Format affiche de jeu */
        object-fit: cover;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .game-title-sidebar {
        font-size: 2rem;
        font-weight: 800;
        color: white;
        margin: 0 0 5px 0;
    }
    .game-genre-sidebar {
        color: var(--text-muted);
        font-size: 0.9rem;
        margin-bottom: 20px;
    }
    .back-btn { display: inline-flex; align-items: center; gap: 5px; color: var(--text-muted); text-decoration: none; font-weight: 600; transition: 0.2s; margin-bottom: 15px; }
    .back-btn:hover { color: white; transform: translateX(-3px); }


    /* ZONE DE CONTENU DROITE */
    .game-content-area {
        min-height: 800px; /* Assure un d√©filement */
    }

    /* CARTES DE CONTENU (Utilis√© pour les sections de la sidebar maintenant) */
    .card { background: var(--bg-card); border-radius: 15px; padding: 25px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 20px; }
    h3 { margin-top: 0; color: white; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; margin-bottom: 15px; }
    p { line-height: 1.6; color: #cbd5e1; }

    /* BOUTONS ACTIONS */
    .actions-bar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;}
    .action-btn { padding: 10px 20px; border-radius: 20px; border: none; font-weight: 600; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
    .btn-primary { background: var(--primary-color); color: #020617; }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 3px 10px rgba(34, 197, 94, 0.4); }
    .btn-secondary { background: transparent; color: white; border: 1px solid #334155; }
    .btn-secondary:hover { background: #334155; }
    .btn-fav-active { background: #ef4444 !important; color: white !important; border-color: #ef4444 !important; }

    /* CONTR√îLES FORMULAIRE */
    .profile-controls { display: flex; gap: 20px; margin-bottom: 15px; }
    .checkbox-group { display: flex; gap: 10px; align-items: center; margin-right: 20px; }
    .checkbox-group input[type="radio"],
    .checkbox-group input[type="checkbox"] { margin-right: 5px; transform: scale(1.2); }
    .rank-selector-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); 
        gap: 10px; 
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid rgba(255,255,255,0.05);
    }
    .rank-option {
        background: #334155;
        color: white;
        padding: 8px;
        border-radius: 8px;
        text-align: center;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s, border 0.2s;
        border: 2px solid transparent;
        font-size: 0.85rem;
    }
    .rank-option.selected {
        background: var(--primary-color);
        color: #020617;
        border: 2px solid #a7f3d0;
    }

    /* Media query pour les petits √©crans (la sidebar devient statique) */
    @media (max-width: 900px) {
        .game-main-layout {
            grid-template-columns: 1fr;
            gap: 20px;
        }
        .game-sidebar-left {
            position: static;
            top: auto;
        }
        .game-layout {
            margin-top: 10px;
        }
    }

    /* Le reste du CSS (Sidebar Amis, Chat) doit √™tre conserv√© pour le bon fonctionnement */

    .toggle-friends-btn { position: fixed; top: 80px; right: 20px; z-index: 1100; background: var(--primary-color); color: #020617; border: none; padding: 10px 16px; border-radius: 30px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: 600; box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3); transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .friends-sidebar { position: fixed; top: 0; right: -340px; width: var(--sidebar-width); height: 100vh; background: rgba(15, 23, 42, 0.98); border-left: 1px solid rgba(255,255,255,0.1); box-shadow: -10px 0 30px rgba(0,0,0,0.5); padding: 80px 15px 20px; z-index: 1000; transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; gap: 15px; backdrop-filter: blur(12px); }
    .friends-sidebar.active { right: 0; }
    .friends-sidebar.active ~ .toggle-friends-btn { right: 280px; background: #ef4444; color: white; }
    .friends-sidebar.active ~ .toggle-friends-btn span { display: none; } .friends-sidebar.active ~ .toggle-friends-btn::after { content: "‚úï"; }
    .sidebar-section-title { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-top: 15px; font-weight: 700; }
    .friend-card { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-radius: 12px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); cursor: pointer; margin-bottom: 5px;} .friend-card:hover { background: rgba(255,255,255,0.08); }
    .friend-avatar { width: 32px; height: 32px; border-radius: 50%; background: #3b82f6; display: flex; justify-content: center; align-items: center; font-weight: bold; margin-right: 10px; }
    .friend-status.pending { color: #fbbf24; }
    .add-friend-box { display: flex; gap: 5px; } .add-friend-box input { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid #334155; border-radius: 20px; padding: 6px 12px; color: white; outline: none; } .add-friend-box button { background: var(--primary-color); border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-weight: bold; }
    .chat-container { position: fixed; bottom: 0; right: 360px; display: flex; flex-direction: row-reverse; gap: 15px; z-index: 900; pointer-events: none; } @media(max-width: 900px) { .chat-container { right: 10px; } }
    .chat-window { width: 300px; height: 400px; background: var(--bg-card); border-radius: 12px 12px 0 0; display: flex; flex-direction: column; pointer-events: auto; border: 1px solid #334155; }
    .chat-header { background: #0f172a; padding: 10px; cursor: pointer; display: flex; justify-content: space-between; border-bottom: 1px solid #334155; }
    .chat-body { flex: 1; padding: 10px; overflow-y: auto; background: #020617; display: flex; flex-direction: column; gap: 8px; }
    .chat-input-area { padding: 10px; background: #1e293b; border-top: 1px solid #334155; display: flex; } .chat-input-area input { flex: 1; padding: 8px; border-radius: 20px; border: none; background: #334155; color: white; outline: none; }
    .msg { padding: 6px 12px; border-radius: 12px; max-width: 80%; font-size: 0.85rem; } .msg.me { align-self: flex-end; background: var(--primary-color); color: #020617; } .msg.them { align-self: flex-start; background: #334155; color: white; }
  </style>
</head>

<body data-current-username="{{ username }}" data-game-id="{{ gameId }}">

  <header>
    <div style="font-weight: 800; font-size: 1.2rem; display:flex; align-items:center; gap:10px;">
        <span style="color:var(--primary-color); font-size:1.5rem;">M</span> MatchMates
    </div>
    <nav>
        <a href="/dashboard">Tableau de bord</a>
        <a href="/logout">D√©connexion</a>
    </nav>
  </header>

  <main class="game-layout">
    <a href="/dashboard" class="back-btn">‚Üê Retour au tableau de bord</a>

    <div class="game-main-layout">
        
        <aside class="game-sidebar-left">
            
            <div class="card" style="padding: 20px;">
                <img src="" id="game-img-sidebar" class="game-sidebar-img" alt="Game Cover">
                <h1 class="game-title-sidebar" id="game-title">Chargement...</h1>
                <div class="game-genre-sidebar" id="game-genre">Genre ‚Ä¢ Multijoueur</div>
                
                <div class="actions-bar" style="border-top: 1px solid #1e293b; padding-top: 15px; margin-bottom: 0;">
                    <button id="fav-action-btn" class="action-btn btn-secondary" style="flex-grow:1;" onclick="toggleCurrentFav()">
                        ‚ô° Ajouter aux favoris
                    </button>
                </div>
            </div>

            <section id="game-about" class="card">
                <h3>√Ä Propos</h3>
                <p id="game-desc">Description du jeu en chargement...</p>
                <div style="margin-top: 20px;">
                    <button class="action-btn btn-secondary" style="width: 100%;">üí¨ Discussion publique</button>
                </div>
            </section>

            <section id="game-stats" class="card">
                <h3>Mes Stats et Compte</h3>
                <p style="font-size: 0.9rem; color: var(--text-muted);">
                    Connectez votre compte de jeu pour voir vos statistiques, vos rangs et vos succ√®s.
                </p>
                <div style="display: flex; gap: 10px; align-items: center; margin-top: 15px;">
                    <button class="action-btn btn-secondary" style="flex-grow:1;">Lier un compte</button>
                    <button class="action-btn btn-secondary" style="flex-grow:1;">Voir l'historique</button>
                </div>
            </section>
        </aside>

        <div class="game-content-area">

            <div class="card">
                <h3>Ton profil de joueur</h3>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 15px;">
                    Configurez votre style de jeu pour trouver des partenaires compatibles.
                </p>

                <div class="profile-controls">
                    <div id="ranked-options" style="display: none;">
                        <div class="checkbox-group">
                            <input type="radio" id="ranked" name="mode" value="ranked" onchange="toggleRanks()">
                            <label for="ranked">Class√©</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="radio" id="unrank" name="mode" value="unrank" onchange="toggleRanks()">
                            <label for="unrank">Non class√©</label>
                        </div>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="discord-vocal" onchange="saveGameSettings()">
                        <label for="discord-vocal">Vocal Discord</label>
                    </div>
                </div>

                <div id="rank-selector" style="display: none;">
                    <div class="sidebar-section-title" style="margin-top:0;">Mon rang actuel</div>
                    <div id="rank-grid" class="rank-selector-grid">
                        </div>
                </div>
            </div>
            
        </div>

    </div>
  </main>

  <button class="toggle-friends-btn" onclick="toggleSidebar()"><span>üí¨ Amis</span></button>
  <aside class="friends-sidebar" id="friendsSidebar">
    <h2 style="margin: 0; font-size: 1.1rem;">Social</h2>
    <div class="sidebar-section-title">Ajouter</div>
    <form class="add-friend-box" id="add-friend-form"><input type="text" id="friend-input" placeholder="Pseudo..." autocomplete="off"><button type="submit">+</button></form>
    <div id="friend-notif" style="font-size:0.75rem; margin-top:5px; min-height:1em;"></div>
    <div id="section-requests-in" style="display:none;"><div class="sidebar-section-title">Re√ßues</div><div id="list-requests-in"></div></div>
    <div id="section-requests-out" style="display:none;"><div class="sidebar-section-title">Envoy√©es</div><div id="list-requests-out"></div></div>
    <div class="sidebar-section-title">Mes Amis (<span id="friend-count">0</span>)</div><div id="friends-list" style="overflow-y: auto; flex: 1;"></div>
  </aside>
  <div id="chat-container" class="chat-container"></div>

  <script>
    function toggleSidebar() { document.getElementById('friendsSidebar').classList.toggle('active'); }

    (function() {
        /* --- DONN√âES JEUX (Ajout des rangs pour les jeux comp√©titifs) --- */
        const VALORANT_RANKS = ['Fer', 'Bronze', 'Argent', 'Or', 'Platine', 'Diamant', 'Ascendant', 'Immortel', 'Radiant'];
        const LOL_RANKS = ['Fer', 'Bronze', 'Argent', 'Or', 'Platine', '√âmeraude', 'Diamant', 'Ma√Ætre', 'Grand Ma√Ætre', 'Challenger'];
        const OVERWATCH_RANKS = ['Bronze', 'Argent', 'Or', 'Platine', 'Diamant', 'Ma√Ætre', 'Grand Ma√Ætre', 'Top 500'];

        const GAMES_DB = {
            'lol': { name: 'League of Legends', genre: 'MOBA', img: 'https://placehold.co/400x533/16213e/fff?text=LoL', desc: 'League of Legends est un jeu de strat√©gie en √©quipe...', ranks: LOL_RANKS },
            'valorant': { name: 'Valorant', genre: 'FPS Tactique', img: 'https://placehold.co/400x533/ff4655/fff?text=Valorant', desc: 'Un jeu de tir tactique 5c5...', ranks: VALORANT_RANKS },
            'wow': { name: 'World of Warcraft', genre: 'MMORPG', img: 'https://placehold.co/400x533/f1c40f/000?text=WoW', desc: 'Le MMORPG l√©gendaire.', ranks: null },
            'minecraft': { name: 'Minecraft', genre: 'Sandbox', img: 'https://placehold.co/400x533/27ae60/fff?text=Minecraft', desc: 'Pr√©parez-vous √† une aventure aux possibilit√©s illimit√©es.', ranks: null },
            'gta': { name: 'GTA V', genre: 'Action-Aventure', img: 'https://placehold.co/400x533/2c3e50/fff?text=GTA+V', desc: 'Explorez le monde ouvert de Los Santos...', ranks: null },
            'rocket': { name: 'Rocket League', genre: 'Sport', img: 'https://placehold.co/400x533/2980b9/fff?text=Rocket+League', desc: 'Un m√©lange d√©tonant de football d\'arcade...', ranks: ['Bronze', 'Argent', 'Or', 'Platine', 'Diamant', 'Champion', 'Grand Champion', 'Supersonique'] },
            'fortnite': { name: 'Fortnite', genre: 'Battle Royale', img: 'https://placehold.co/400x533/8e44ad/fff?text=Fortnite', desc: 'Le jeu de Battle Royale o√π 100 joueurs s\'affrontent...', ranks: ['Bronze', 'Argent', 'Or', 'Platine', 'Diamant', '√âlite', 'Champion', 'Iridescent'] },
            'cod': { name: 'Call of Duty', genre: 'FPS', img: 'https://placehold.co/400x533/34495e/fff?text=Call+of+Duty', desc: 'L\'exp√©rience FPS ultime...', ranks: ['Bronze', 'Argent', 'Or', 'Platine', 'Diamant', '√âcarlate', 'Iridescent', 'Top 250'] },
            'apex': { name: 'Apex Legends', genre: 'Battle Royale', img: 'https://placehold.co/400x533/e74c3c/fff?text=Apex+Legends', desc: 'Ma√Ætrisez des personnages l√©gendaires...', ranks: ['Bronze', 'Argent', 'Or', 'Platine', 'Diamant', 'Ma√Ætre', 'Pr√©dateur'] },
            'overwatch': { name: 'Overwatch 2', genre: 'FPS H√©ro√Øque', img: 'https://placehold.co/400x533/e67e22/fff?text=Overwatch+2', desc: 'Overwatch 2 est un jeu d\'action en √©quipe...', ranks: OVERWATCH_RANKS },
            'csgo': { name: 'CS:GO 2', genre: 'FPS', img: 'https://placehold.co/400x533/333/fff?text=CS:GO+2', desc: 'La nouvelle √®re de Counter-Strike...', ranks: ['Argent', 'Or', 'Nova', 'Ma√Ætre Gardien', 'Aigle L√©gendaire', 'Supr√™me', 'Global'] },
            'fifa': { name: 'EA FC 24', genre: 'Sport', img: 'https://placehold.co/400x533/222/fff?text=EA+FC+24', desc: 'Le jeu de football le plus r√©aliste au monde.', ranks: null }
        };

        const gameId = document.body.getAttribute('data-game-id');
        const gameData = GAMES_DB[gameId];
        let currentRankSelection = null;
        let settingsKey = `mm_game_settings_${gameId}`;
        let favorites = []; // MAINTENANT G√âR√â PAR LE SERVEUR

        // --- Fonctions de gestion de l'√©tat (Profil Joueur) ---

        // Sauvegarde les param√®tres actuels du jeu dans localStorage
        window.saveGameSettings = function() {
            const settings = {
                mode: document.getElementById('ranked').checked ? 'ranked' : 'unrank',
                rank: currentRankSelection ? currentRankSelection.getAttribute('data-rank') : null,
                vocal: document.getElementById('discord-vocal').checked
            };
            localStorage.setItem(settingsKey, JSON.stringify(settings));
        };

        // Charge les param√®tres depuis localStorage et met √† jour l'interface
        function loadGameSettings() {
            const savedSettings = JSON.parse(localStorage.getItem(settingsKey));
            
            // Param√®tres par d√©faut
            let settings = { mode: 'ranked', rank: null, vocal: false };

            if (savedSettings) {
                settings = savedSettings;
            }

            // 1. Mode Class√©/Unrank
            if (gameData.ranks && gameData.ranks.length > 0) {
                document.getElementById('ranked').checked = settings.mode === 'ranked';
                document.getElementById('unrank').checked = settings.mode === 'unrank';
                window.toggleRanks(false); 
            }

            // 2. Vocal Discord
            document.getElementById('discord-vocal').checked = settings.vocal;

            // 3. Rang s√©lectionn√©
            if (settings.mode === 'ranked' && settings.rank) {
                const rankEl = document.querySelector(`.rank-option[data-rank="${settings.rank}"]`);
                if (rankEl) {
                    selectRank(rankEl, false); 
                }
            }
        }


        // --- Fonctions d'interaction utilisateur (Profil Joueur) ---

        function renderRanks(ranks) {
            const rankGrid = document.getElementById('rank-grid');
            rankGrid.innerHTML = '';
            ranks.forEach(rank => {
                const rankEl = document.createElement('div');
                rankEl.className = 'rank-option';
                rankEl.textContent = rank;
                rankEl.setAttribute('data-rank', rank);
                rankEl.onclick = () => selectRank(rankEl, true);
                rankGrid.appendChild(rankEl);
            });
        }

        window.selectRank = function(el, shouldSave = true) {
            if (currentRankSelection) {
                currentRankSelection.classList.remove('selected');
            }
            el.classList.add('selected');
            currentRankSelection = el;
            
            if (shouldSave) {
                saveGameSettings();
            }
        }

        window.toggleRanks = function(shouldSave = true) {
            const isRanked = document.getElementById('ranked').checked;
            const rankSelector = document.getElementById('rank-selector');

            if (isRanked && gameData.ranks) {
                rankSelector.style.display = 'block';
            } else {
                rankSelector.style.display = 'none';
                if (currentRankSelection) {
                    currentRankSelection.classList.remove('selected');
                    currentRankSelection = null;
                }
            }

            if (shouldSave) {
                saveGameSettings();
            }
        };


        // --- NOUVELLE LOGIQUE FAVORIS (Bas√©e sur l'API) ---

        const favBtn = document.getElementById('fav-action-btn');

        // Met √† jour l'affichage du bouton en fonction de la liste globale 'favorites'
        function updateFavBtn() {
            if(favorites.includes(gameId)) {
                favBtn.textContent = "‚ô• Retirer des favoris";
                favBtn.classList.add('btn-fav-active');
            } else {
                favBtn.textContent = "‚ô° Ajouter aux favoris";
                favBtn.classList.remove('btn-fav-active');
            }
        }

        // R√©cup√®re les favoris du serveur
        async function loadUserFavorites() {
            try {
                const response = await fetch('/api/favorites');
                if (response.ok) {
                    const data = await response.json();
                    favorites = data.favorites || [];
                    updateFavBtn(); // Met √† jour le bouton de favoris apr√®s le chargement
                }
            } catch (e) {
                console.error("Erreur de chargement des favoris:", e);
            }
        }

        // Bascule l'√©tat du favori via l'API
        window.toggleCurrentFav = async () => {
            const isFavorite = favorites.includes(gameId);
            favBtn.disabled = true; // D√©sactive le bouton pendant l'appel

            try {
                const response = await fetch(`/api/favorites/${gameId}`, { method: 'POST' });
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'added') {
                        favorites.push(gameId);
                    } else if (data.status === 'removed') {
                        favorites = favorites.filter(id => id !== gameId);
                    }
                    updateFavBtn(); // Met √† jour l'affichage
                }
            } catch (e) {
                console.error("Erreur de bascule des favoris:", e);
            } finally {
                favBtn.disabled = false;
            }
        };

        // --- Initialisation de la page ---

        if (gameData) {
            document.getElementById('game-title').textContent = gameData.name;
            document.getElementById('game-img-sidebar').src = gameData.img;
            document.getElementById('game-genre').textContent = gameData.genre;
            document.getElementById('game-desc').textContent = gameData.desc;
            document.title = `${gameData.name} ‚Äì MatchMates`;

            // 1. Afficher les options Class√©/Unrank si le jeu a des rangs
            if (gameData.ranks && gameData.ranks.length > 0) {
                document.getElementById('ranked-options').style.display = 'flex';
                renderRanks(gameData.ranks);
            }
            
            // 2. Charger les param√®tres sp√©cifiques au jeu (utilise toujours localStorage)
            loadGameSettings();
            
            // 3. Charger les favoris du compte utilisateur (NOUVEAU)
            loadUserFavorites();

        } else {
            document.getElementById('game-title').textContent = "Jeu introuvable";
            document.getElementById('game-genre').textContent = "V√©rifiez l'URL.";
            document.getElementById('game-desc').textContent = "Les donn√©es pour ce jeu n'ont pas √©t√© trouv√©es.";
        }

        /* --- LOGIQUE SOCIALE (inchang√©) --- */
        const friendNotif = document.getElementById('friend-notif');
        const chatContainer = document.getElementById('chat-container');
        const activeChats = {}; 
        async function loadSocial() { try { const [f, r] = await Promise.all([fetch('/api/friends'), fetch('/api/friends/requests')]); const fd=await f.json(); const rd=await r.json(); renderFriends(fd.friends); renderRequests(rd.incoming, rd.outgoing); } catch(e){} }
        function renderFriends(l) { const c=document.getElementById('friends-list'); document.getElementById('friend-count').innerText=l.length; c.innerHTML=""; if(!l.length){c.innerHTML='<div style="text-align:center;color:#64748b;font-size:0.8rem;margin-top:10px;">Aucun ami.</div>';return;} l.forEach(f=>{ const d=document.createElement('div');d.className='friend-card';d.onclick=()=>openChat(f.username);d.innerHTML=`<div style="display:flex;align-items:center;"><div class="friend-avatar">${f.username[0].toUpperCase()}</div><div><div style="font-size:0.9rem;font-weight:500;color:white;">${f.username}</div><div class="friend-status">‚óè En ligne</div></div></div><span>üí¨</span>`;c.appendChild(d);}); }
        function renderRequests(inc,out){ const ic=document.getElementById('list-requests-in'); document.getElementById('section-requests-in').style.display=inc.length?'block':'none'; ic.innerHTML=""; inc.forEach(r=>{const d=document.createElement('div');d.className='friend-card';d.style.border='1px solid #eab308';d.innerHTML=`<span style="font-size:0.85rem;">${r.from_username}</span><div><button onclick="hReq(${r.id},'accept')" style="background:#22c55e;border:none;border-radius:4px;cursor:pointer;">‚úî</button><button onclick="hReq(${r.id},'reject')" style="background:#ef4444;border:none;border-radius:4px;cursor:pointer;margin-left:5px;">‚úñ</button></div>`;ic.appendChild(d);}); const oc=document.getElementById('list-requests-out'); document.getElementById('section-requests-out').style.display=out.length?'block':'none'; oc.innerHTML=""; out.forEach(r=>{const d=document.createElement('div');d.className='friend-card';d.style.cursor='default';d.innerHTML=`<div style="display:flex;align-items:center;opacity:0.7;"><div class="friend-avatar" style="background:#64748b;width:24px;height:24px;font-size:0.7rem;">?</div><div><div style="font-size:0.85rem;">${r.to_username}</div><div class="friend-status pending">En attente...</div></div></div>`;oc.appendChild(d);}); }
        document.getElementById('add-friend-form').addEventListener('submit', async(e)=>{ e.preventDefault(); const i=document.getElementById('friend-input'); if(!i.value.trim())return; const res=await fetch('/api/friends/request',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({toUsername:i.value.trim()})}); const d=await res.json(); friendNotif.innerText=d.ok?"Envoy√© !":d.error; friendNotif.style.color=d.ok?"#22c55e":"#ef4444"; i.value=""; loadSocial(); setTimeout(()=>friendNotif.innerText="",3000); });
        window.hReq=async(id,a)=>{await fetch(`/api/friends/requests/${id}/${a}`,{method:'POST'});loadSocial();};
        window.openChat=(u)=>{if(document.getElementById(`cw-${u}`))return; const d=document.createElement('div');d.className='chat-window';d.id=`cw-${u}`;d.innerHTML=`<div class="chat-header" onclick="closeChat('${u}')"><span>${u}</span><span>‚úñ</span></div><div class="chat-body" id="msg-${u}"></div><form class="chat-input-area" onsubmit="sM(event,'${u}')"><input type="text" placeholder="..." autocomplete="off"></form>`;chatContainer.appendChild(d);fM(u);activeChats[u]=setInterval(()=>fM(u),3000);};
        window.closeChat=(u)=>{const el=document.getElementById(`cw-${u}`);if(el)el.remove();if(activeChats[u]){clearInterval(activeChats[u]);delete activeChats[u];}};
        window.sM=async(e,u)=>{e.preventDefault();const i=e.target.querySelector('input');if(!i.value.trim())return;await fetch('/api/messages',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({toUsername:u,content:i.value.trim()})});i.value="";fM(u);};
        async function fM(u){const c=document.getElementById(`msg-${u}`);if(!c)return;const res=await fetch(`/api/messages/${u}`);const d=await res.json();c.innerHTML=d.messages.map(m=>`<div class="msg ${m.fromSelf?'me':'them'}">${m.content}</div>`).join('');c.scrollTop=c.scrollHeight;}
        loadSocial(); setInterval(loadSocial, 5000);
    })();
  </script>
</body>
</html>
