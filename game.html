<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Jeu – MatchMates</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

  <style>
    /* On réutilise les mêmes variables et styles de base pour la cohérence */
    :root { 
        --primary-color: #22c55e; 
        --sidebar-width: 320px; 
        --game-info-width: 280px; 
        --bg-dark: #0f172a; 
        --bg-card: #1e293b; 
        --text-main: #f1f5f9; 
        --text-muted: #94a3b8; 
    }
    body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Inter', sans-serif; margin: 0; overflow-x: hidden; }
    
    /* HEADER */
    header { display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(10px); position: fixed; top: 0; width: 100%; z-index: 800; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); }
    .logo { color: var(--primary-color); font-size: 1.5rem; font-weight: 800; text-decoration: none; }
    .nav-links a { color: var(--text-main); text-decoration: none; margin-left: 25px; transition: color 0.2s; }
    .nav-links a:hover { color: var(--primary-color); }
    .profile-section { display: flex; align-items: center; }
    .profile-avatar { width: 35px; height: 35px; border-radius: 50%; background: var(--primary-color); color: var(--bg-dark); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1rem; margin-right: 15px; cursor: pointer; }

    /* LAYOUT PRINCIPAL */
    .game-layout {
        max-width: 1300px;
        margin: 80px auto 40px;
        padding: 0 20px;
        display: flex;
        gap: 30px;
    }

    /* COLONNE GAUCHE (INFO JEU) */
    .game-info-column {
        flex: 0 0 var(--game-info-width);
        position: sticky;
        top: 95px; /* Décalage pour le header */
        height: fit-content;
        padding: 20px;
        background: var(--bg-card);
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    .game-title-info { font-size: 1.8rem; font-weight: 800; margin-bottom: 10px; color: var(--primary-color); }
    .game-stats p { font-size: 0.95rem; color: var(--text-muted); margin: 5px 0; }
    .info-line { display: flex; justify-content: space-between; margin-bottom: 5px; }
    .info-label { font-weight: 500; color: var(--text-main); }
    .info-value { color: var(--text-muted); }
    /* L'ancienne règle .update-btn est retirée/modifiée ici */
    .update-btn:hover { opacity: 0.9; }

    /* COLONNE CENTRALE (OPTIONS & MATCH) */
    .main-content-column {
        flex-grow: 1;
    }
    h2 { color: var(--text-main); margin-bottom: 20px; border-bottom: 1px solid #334155; padding-bottom: 5px; font-size: 1.5rem; }
    
    /* PARTIE RANG / MODE */
    .settings-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }
    .setting-box {
        background: var(--bg-card);
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    .setting-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; color: var(--text-main); }
    .radio-group { display: flex; flex-direction: column; gap: 10px; }
    .radio-option { display: flex; align-items: center; gap: 10px; cursor: pointer; }
    .radio-option input[type="radio"], .radio-option input[type="checkbox"] { display: none; }
    .radio-option label { 
        padding: 8px 12px; border-radius: 6px; border: 2px solid #334155; 
        background: var(--bg-dark); color: var(--text-muted); 
        transition: all 0.2s; cursor: pointer;
        flex-grow: 1; text-align: center;
    }
    .radio-option input[type="radio"]:checked + label,
    .radio-option input[type="checkbox"]:checked + label {
        border-color: var(--primary-color);
        background: rgba(34, 197, 94, 0.2);
        color: var(--text-main);
    }
    .rank-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
    }
    .rank-option {
        text-align: center;
        cursor: pointer;
        opacity: 0.6;
        transition: opacity 0.2s, transform 0.2s;
        border: 2px solid transparent;
        border-radius: 8px;
        padding: 5px;
    }
    .rank-option.active {
        opacity: 1;
        transform: scale(1.05);
        border-color: var(--primary-color);
    }
    .rank-option img {
        width: 100%;
        max-width: 60px;
        height: auto;
        border-radius: 4px;
        display: block;
        margin: 0 auto 5px;
    }
    .rank-option span {
        font-size: 0.8rem;
        color: var(--text-muted);
    }
    .rank-option.active span {
        color: var(--text-main);
        font-weight: 600;
    }
    .range-selector { margin-top: 15px; }
    .range-selector label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: var(--text-muted); }
    #rankRange { width: 100%; height: 8px; background: #334155; border-radius: 4px; appearance: none; cursor: pointer; }
    #rankRange::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: var(--primary-color);
        cursor: pointer;
    }
    #rankRange::-moz-range-thumb {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: var(--primary-color);
        cursor: pointer;
    }

    /* PARTIE RECHERCHE DE PARTENAIRE */
    #partnerSearchButton {
        width: 100%;
        padding: 15px;
        font-size: 1.1rem;
        font-weight: 700;
        background: #f97316; /* Orange pour l'action principale */
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
    }
    #partnerSearchButton:hover { background: #ea580c; }
    #partnerSearchButton.searching {
        background: #334155;
        cursor: default;
    }
    .match-results { margin-top: 30px; }
    .match-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 15px;
        background: var(--bg-card);
        border-radius: 10px;
        margin-bottom: 10px;
        border-left: 5px solid var(--primary-color);
    }
    .match-info { display: flex; align-items: center; gap: 15px; }
    .match-rank-img { width: 40px; height: 40px; border-radius: 4px; }
    .match-username { font-weight: 600; font-size: 1.1rem; }
    .match-details { font-size: 0.9rem; color: var(--text-muted); }
    .match-actions button { 
        padding: 8px 15px; border: none; border-radius: 6px; 
        font-weight: 600; cursor: pointer; margin-left: 10px;
    }
    .add-friend-match { background: var(--primary-color); color: var(--bg-dark); }
    .send-msg-match { background: #3b82f6; color: white; }

    /* SIDEBAR & CHAT STYLES (Copiés du dashboard) */
    .toggle-friends-btn { position: fixed; top: 80px; right: 20px; z-index: 9999; background: var(--primary-color); color: #020617; border: none; padding: 10px 16px; border-radius: 30px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: 600; box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3); transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .toggle-friends-btn.active { right: calc(var(--sidebar-width) + 20px); background: #ef4444; color: white; }
    .toggle-friends-btn.active span { display: none; }
    .toggle-friends-btn.active::after { content: "×"; }

    .friends-sidebar { position: fixed; top: 0; right: calc(0px - var(--sidebar-width)); width: var(--sidebar-width); height: 100vh; background: rgba(15, 23, 42, 0.98); border-left: 1px solid rgba(255,255,255,0.1); box-shadow: -10px 0 30px rgba(0,0,0,0.5); padding: 80px 15px 20px; z-index: 1000; transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; gap: 15px; backdrop-filter: blur(12px); box-sizing: border-box; }
    .friends-sidebar.active { right: 0; } 

    .sidebar-section-title { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-top: 15px; font-weight: 700; }
    .friend-card { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-radius: 12px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); cursor: pointer; margin-bottom: 5px; }
    .friend-card:hover { background: rgba(255,255,255,0.08); }
    .friend-avatar { width: 32px; height: 32px; border-radius: 50%; background: #3b82f6; display: flex; justify-content: center; align-items: center; font-weight: bold; margin-right: 10px; color: white; }
    .add-friend-box { display: flex; gap: 5px; }
    .add-friend-box input { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid #334155; border-radius: 20px; padding: 6px 12px; color: white; outline: none; }
    .add-friend-box button { background: var(--primary-color); border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-weight: bold; color: var(--bg-dark);}

    .chat-container { position: fixed; bottom: 0; right: calc(20px); display: flex; flex-direction: row-reverse; gap: 15px; z-index: 900; transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1); pointer-events: none; }
    .friends-sidebar.active ~ .chat-container { right: calc(var(--sidebar-width) + 20px); }
    .chat-window { width: 300px; height: 400px; background: var(--bg-card); border-radius: 12px 12px 0 0; display: flex; flex-direction: column; box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.4); pointer-events: auto; }
    .chat-header { padding: 10px 15px; background: var(--primary-color); color: var(--bg-dark); font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-radius: 10px 10px 0 0; }
    .chat-body { flex-grow: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; background: #141c2c; }
    .msg { max-width: 80%; padding: 8px 12px; border-radius: 16px; font-size: 0.9rem; word-wrap: word-wrap; }
    .msg.self { background: var(--primary-color); color: var(--bg-dark); align-self: flex-end; border-bottom-right-radius: 4px; }
    .msg.other { background: #334155; color: var(--text-main); align-self: flex-start; border-bottom-left-radius: 4px; }
    .chat-input-area { display: flex; padding: 10px; border-top: 1px solid #334155; }
    .chat-input-area input { flex-grow: 1; padding: 10px; border: 1px solid #334155; border-radius: 8px; background: var(--bg-dark); color: var(--text-main); margin-right: 10px; outline: none; }
    .chat-input-area button { background: var(--primary-color); color: var(--bg-dark); border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1rem; }

  </style>
</head>
<body>

    <header>
        <a href="/dashboard" class="logo">MatchMates</a>
        <div class="nav-links">
            <a href="/dashboard">Tableau de bord</a>
            <a href="/logout">Déconnexion</a>
        </div>
        <div class="profile-section">
            <div class="profile-avatar">U</div> 
        </div>
    </header>

    <div class="game-layout">

        <div class="game-info-column">
            <div class="game-title-info" id="gameTitle">Jeu - MatchMates</div>
            <img id="gameImg" src="image match mates/valorant.jpg" alt="Valorant" style="width: 100%; border-radius: 8px; margin-bottom: 20px;">

            <div class="game-stats">
                <div class="info-line"><span class="info-label">Joueurs actifs :</span><span id="playerCount" class="info-value">0</span></div>
                <div class="info-line"><span class="info-label">Mode de jeu :</span><span id="gameModeDisplay" class="info-value">Non défini</span></div>
                <div class="info-line"><span class="info-label">Votre Rang :</span><span id="userRankDisplay" class="info-value">Non défini</span></div>
                <div class="info-line"><span class="info-label">Tolérance :</span><span id="rankRangeDisplay" class="info-value">±1 Rang</span></div>
            </div>
            
            </div>

        <div class="main-content-column">
            
            <h2>Mon profil de joueur</h2>
            <div class="settings-grid">
                
                <div class="setting-box">
                    <div class="setting-title">Votre grade Actuel</div>
                    <div class="rank-grid" id="rankGrid">
                        </div>
                </div>

                <div class="setting-box">
                    <div class="setting-title">Mode de Jeu</div>
                    <div class="radio-group" id="modeGroup">
                        </div>
                </div>

            </div>
            <button class="update-btn" onclick="saveGameSettings()" style="margin-top: -10px; margin-bottom: 30px; width: 50%; padding: 10px; background: var(--primary-color); color: var(--bg-dark); border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: opacity 0.2s;">Mettre à jour mes infos</button>
            <h2>Recherche de partenaire</h2>
            
            <div class="setting-box">
                <div class="setting-title">Préférences du partenaire</div>

                <div class="rank-grid" id="prefRankGrid">
                    </div>
                
                <div class="range-selector">
                    <label for="rankRange">Tolérance de Rang : <span id="rangeValue">±1 Rang</span></label>
                    <input type="range" id="rankRange" min="0" max="3" step="1" value="1">
                </div>
            </div>

            <button id="partnerSearchButton" onclick="toggleSearch()">
                <i class="fas fa-search"></i> <span>Rechercher un partenaire</span>
            </button>
            
            <div class="match-results">
                <h2>Partenaires potentiels (<span id="matchCount">0</span>)</h2>
                <div id="matchList">
                    <p style="color:var(--text-muted); text-align:center; padding: 20px; background: var(--bg-card); border-radius: 8px;">Lancez une recherche pour trouver des joueurs !</p>
                </div>
            </div>

        </div>

    </div>

    <button class="toggle-friends-btn" onclick="toggleSidebar()">
        <i class="fas fa-users"></i> <span>Amis</span>
    </button>
    
    <aside class="friends-sidebar" id="friendsSidebar">
        <h2 style="margin: 0; font-size: 1.1rem; color: var(--primary-color);">Social</h2>
        
        <div class="sidebar-section-title">Ajouter</div>
        <form class="add-friend-box" id="add-friend-form">
            <input type="text" id="friend-input" placeholder="Pseudo..." autocomplete="off">
            <button type="submit"><i class="fas fa-user-plus"></i></button>
        </form>
        <div id="friend-notif" style="color:var(--primary-color); font-size: 0.8rem; margin-top: 5px;"></div>

        <div class="sidebar-section-title">Amis (<span id="friendsCount">0</span>)</div>
        <div id="friendsList">
            <p style="text-align:center; color:var(--text-muted); font-size:0.9rem;">Ajoutez des amis !</p>
        </div>

        <div class="sidebar-section-title" id="receivedRequestsTitle" style="display:none;">Demandes reçues (<span id="receivedCount">0</span>)</div>
        <div id="requestsList">
            </div>
        
        <div class="sidebar-section-title" id="sentRequestsTitle" style="display:none;">Demandes envoyées (<span id="sentCount">0</span>)</div>
        <div id="sentList">
            </div>

    </aside>
    
    <div id="chat-container" class="chat-container"></div>
<script>
        // ====================================================
        // --- 0. DÉCLARATION DES VARIABLES GLOBALES ---
        // ====================================================

       // Variables de jeu
        const gameId = window.location.pathname.split('/').pop() || 'valorant';
       const gameInfo = {
            valorant: {
                title: 'Valorant',
                img: '/Image/Image_jeux/valorant.jpg',
                mainModes: ['Classé', 'Non Classé'], // Modes principaux (radio)
                options: ['Vocal Obligatoire'], // Options supplémentaires (checkbox)
                players: 15000 
            },
            lol: {
                title: 'League of Legends',
                img: '/Image/Image_jeux/lol.jpg',
                mainModes: ['Classé', 'Non Classé'], // Modes principaux (radio)
                options: ['Vocal Obligatoire'], // Options supplémentaires (checkbox)
                players: 25000 
            }
        };

        // Rangs unifiés avec le serveur (IDs raccourcis pour Valorant)
        const RANKS = {
            lol: [
                { id: 'Iron',    name: 'Iron',    img: '/lol_rank/Iron.webp' },
                { id: 'Bronze',  name: 'Bronze',  img: '/lol_rank/Bronze.webp' },
                { id: 'Silver',  name: 'Silver',  img: '/lol_rank/Silver.webp' },
                { id: 'Gold',    name: 'Gold',    img: '/lol_rank/Gold.webp' },
                { id: 'Platinum',name: 'Platinum',img: '/lol_rank/Platinum.webp' },
                { id: 'Emerald', name: 'Emerald', img: '/lol_rank/Emerald.webp' },
                { id: 'diamond', name: 'Diamant', img: '/lol_rank/diamond.webp' },
                { id: 'Master',  name: 'Master',  img: '/lol_rank/Master.webp' },
                { id: 'GrandM',  name: 'Grand Master', img: '/lol_rank/Grand_Master.webp' },
                { id: 'Challenger', name: 'Challenger', img: '/lol_rank/Challenger.webp' },
            ],
            valorant: [
                { id: 'fer1', name: 'Fer 1', img: '/Valorant_rank/Iron_1_Rank.webp' },
                { id: 'fer2', name: 'Fer 2', img: '/Valorant_rank/Iron_2_Rank.webp' },
                { id: 'fer3', name: 'Fer 3', img: '/Valorant_rank/Iron_3_Rank.webp' },
                { id: 'bronze1', name: 'Bronze 1', img: '/Valorant_rank/Bronze_1_Rank.webp' },
                { id: 'bronze2', name: 'Bronze 2', img: '/Valorant_rank/Bronze_2_Rank.webp' },
                { id: 'bronze3', name: 'Bronze 3', img: '/Valorant_rank/Bronze_3_Rank.webp' },
                { id: 'argent1', name: 'Argent 1', img: '/Valorant_rank/Silver_1_Rank.webp' },
                { id: 'argent2', name: 'Argent 2', img: '/Valorant_rank/Silver_2_Rank.webp' },
                { id: 'argent3', name: 'Argent 3', img: '/Valorant_rank/Silver_3_Rank.webp' },
                { id: 'or1', name: 'Or 1', img: '/Valorant_rank/Gold_1_Rank.webp' },
                { id: 'or2', name: 'Or 2', img: '/Valorant_rank/Gold_2_Rank.webp' },
                { id: 'or3', name: 'Or 3', img: '/Valorant_rank/Gold_3_Rank.webp' },
                { id: 'platine1', name: 'Platine 1', img: '/Valorant_rank/Platinum_1_Rank.webp' },
                { id: 'platine2', name: 'Platine 2', img: '/Valorant_rank/Platinum_2_Rank.webp' },
                { id: 'platine3', name: 'Platine 3', img: '/Valorant_rank/Platinum_3_Rank.webp' },
                { id: 'diamant1', name: 'Diamant 1', img: '/Valorant_rank/Diamond_1_Rank.webp' },
                { id: 'diamant2', name: 'Diamant 2', img: '/Valorant_rank/Diamond_2_Rank.webp' },
                { id: 'diamant3', name: 'Diamant 3', img: '/Valorant_rank/Diamond_3_Rank.webp' },
                { id: 'ascendant_1', name: 'Ascendant 1', img: '/Valorant_rank/Ascendant_1_Rank.webp' },
                { id: 'ascendant_2', name: 'Ascendant 2', img: '/Valorant_rank/Ascendant_2_Rank.webp' },
                { id: 'ascendant_3', name: 'Ascendant 3', img: '/Valorant_rank/Ascendant_3_Rank.webp' },
                { id: 'immortal_1', name: 'Immortal 1', img: '/Valorant_rank/Immortal_1_Rank.webp' },
                { id: 'immortal_2', name: 'Immortal 2', img: '/Valorant_rank/Immortal_2_Rank.webp' },
                { id: 'immortal_3', name: 'Immortal 3', img: '/Valorant_rank/Immortal_3_Rank.webp' },
                { id: 'radiant', name: 'Radiant', img: '/Valorant_rank/Radiant_Rank.webp' },
            ],
        };

        let userGameData = {
            rank: null,
            mainMode: null, 
            options: [],     
            mode: null,      
            prefRanks: [],
            rankTolerance: 1,
            isSearching: false
        };

        // Variables sociales/chat
        const activeChats = {}; 
        const friendsSidebar = document.getElementById('friendsSidebar');
        const chatContainer = document.getElementById('chat-container'); 
        
        // Variables DOM
        const rankRangeInput = document.getElementById('rankRange');
        const rangeValueSpan = document.getElementById('rangeValue');
        const partnerSearchButton = document.getElementById('partnerSearchButton');
        const matchListDiv = document.getElementById('matchList');


        // ====================================================
        // --- NOUVELLES FONCTIONS JWT UTILS ---
        // ====================================================

        /** Récupère l'en-tête d'autorisation JWT. */
        function getAuthHeader() {
            const token = localStorage.getItem('token');
            return token ? { 'Authorization': `Bearer ${token}` } : {};
        }

        /** Wrapper fetch pour les requêtes protégées. */
        async function fetchProtected(url, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                ...getAuthHeader(),
                ...(options.headers || {})
            };

            const response = await fetch(url, {
                ...options,
                headers: headers,
            });

            // Gère l'expiration ou l'invalidité du token
            if (response.status === 401) {
                alert("Session expirée. Veuillez vous reconnecter.");
                localStorage.removeItem('token');
                localStorage.removeItem('username');
                window.location.href = '/login';
            }

            return response;
        }

        // ====================================================
        // --- 1. LOGIQUE D'AFFICHAGE DU JEU ---
        // ====================================================
        async function loadGameInfo() {
            const info = gameInfo[gameId] || gameInfo.valorant;
            document.getElementById('gameTitle').textContent = info.title;
            document.getElementById('gameImg').src = info.img;
            document.getElementById('gameImg').alt = info.title;
            document.getElementById('playerCount').textContent = info.players ? info.players.toLocaleString() : '0';

            // Génération des modes principaux (radio)
            const mainModesHtml = info.mainModes.map((mode, index) => `
                <div class="radio-option">
                    <input type="radio" id="mode-main-${index}" name="gameMode" value="${mode}" onchange="updateMainMode('${mode}')">
                    <label for="mode-main-${index}">${mode}</label>
                </div>
            `).join('');

            // Génération des options (checkbox)
            const optionsHtml = info.options.map((option, index) => `
                <div class="radio-option" style="margin-top: 10px;">
                    <input type="checkbox" id="mode-opt-${index}" name="gameOption" value="${option}" onchange="toggleOption('${option}')">
                    <label for="mode-opt-${index}">${option}</label>
                </div>
            `).join('');
            
            document.getElementById('modeGroup').innerHTML = mainModesHtml + optionsHtml;
        }

        // ====================================================
        // --- 2. LOGIQUE DES RANGS ET PRÉFÉRENCES ---
        // ====================================================

        function setupRankGrids(ranks) {
            const rankGrid = document.getElementById('rankGrid');
            const prefRankGrid = document.getElementById('prefRankGrid');

            if (!rankGrid || !prefRankGrid) return;
            
            // Rendu de la grille de rangs (Rang utilisateur)
            rankGrid.innerHTML = ranks.map(rank => `
                <div class="rank-option" data-rank-id="${rank.id}" onclick="selectRank('${rank.id}')">
                    <img src="${rank.img}" alt="${rank.name}">
                    <span>${rank.name}</span>
                </div>
            `).join('');

            // Rendu de la grille de préférences (Rangs du partenaire)
            prefRankGrid.innerHTML = ranks.map(rank => `
                <div class="rank-option" data-pref-rank-id="${rank.id}" onclick="togglePrefRank('${rank.id}')">
                    <img src="${rank.img}" alt="${rank.name}">
                    <span>${rank.name}</span>
                </div>
            `).join('');
        }

        window.selectRank = (rankId) => {
            userGameData.rank = rankId;
            document.querySelectorAll('#rankGrid .rank-option').forEach(el => {
                el.classList.toggle('active', el.getAttribute('data-rank-id') === rankId);
            });
            document.getElementById('userRankDisplay').textContent = RANKS[gameId.toLowerCase()].find(r => r.id === rankId)?.name || 'Non défini';
        };

        window.togglePrefRank = async (rankId) => {
            const index = userGameData.prefRanks.indexOf(rankId);
            if (index > -1) {
                userGameData.prefRanks.splice(index, 1);
            } else {
                userGameData.prefRanks.push(rankId);
            }
            document.querySelectorAll('#prefRankGrid .rank-option').forEach(el => {
                el.classList.toggle('active', userGameData.prefRanks.includes(el.getAttribute('data-pref-rank-id')));
            });
            // Sauvegarde immédiate des préférences lors du changement de rangs préférés
            await savePartnerPreferences();
        };

        window.updateMainMode = (mode) => {
            userGameData.mainMode = mode;
            updateModeDisplay();
        };

        window.toggleOption = (option) => {
            if (!userGameData.options) userGameData.options = [];
            const index = userGameData.options.indexOf(option);
            
            if (index > -1) {
                userGameData.options.splice(index, 1); 
            } else {
                userGameData.options.push(option); 
            }
            
            updateModeDisplay();
        };
        
        // Fonction utilitaire pour mettre à jour l'affichage dans la colonne de gauche
        function updateModeDisplay() {
            let display = userGameData.mainMode || 'Non défini';
            if (userGameData.options && userGameData.options.length > 0) {
                 display += ` (+ ${userGameData.options.join(', ')})`;
            }
            userGameData.mode = display; 
            document.getElementById('gameModeDisplay').textContent = display;
        }

        // Événement pour la tolérance de rang
        if (rankRangeInput) {
            rankRangeInput.addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                userGameData.rankTolerance = value;
                const display = value === 0 ? 'Exact' : (value === 1 ? '±1 Rang' : `±${value} Rangs`);
                rangeValueSpan.textContent = display;
                document.getElementById('rankRangeDisplay').textContent = display;
                
                // Sauvegarde immédiate de la tolérance (optionnel, mais pratique)
                savePartnerPreferences();
            });
        }


        // ====================================================
        // --- 3. PERSISTENCE & SAUVEGARDE (API) ---
        // ====================================================

        /** Charge le profil complet de l'utilisateur depuis le serveur. */
        async function loadProfileAndSettings() {
            const response = await fetchProtected('/api/user/profile');
            
            if (!response.ok) {
                 // Le 401 est géré par fetchProtected, pour les autres erreurs on continue avec les valeurs par défaut.
                 return;
            }

            const profile = await response.json();
            const settings = profile.gameSettings;
            const prefs = profile.partnerPreferences;

            // Mise à jour de userGameData
            userGameData.rank = settings.rank;
            userGameData.mainMode = settings.mainMode;
            userGameData.options = settings.options || [];
            userGameData.prefRanks = prefs.prefRanks || [];
            userGameData.rankTolerance = prefs.rankTolerance || 1;
            
            // --- Application à l'interface ---
            
            // 1. Rang
            if (settings.rank) {
                selectRank(settings.rank); 
            }

            // 2. Mode principal (Radio)
            if (settings.mainMode) {
                const modeInput = document.querySelector(`#modeGroup input[name="gameMode"][value="${settings.mainMode}"]`);
                if (modeInput) modeInput.checked = true;
            }

            // 3. Options (Checkbox)
            if (Array.isArray(settings.options)) {
                 settings.options.forEach(option => {
                    const optionInput = document.querySelector(`#modeGroup input[name="gameOption"][value="${option}"][type="checkbox"]`);
                    if (optionInput) optionInput.checked = true;
                 });
            }
            
            updateModeDisplay(); 

            // 4. Tolérance de rang
            if (rankRangeInput && prefs.rankTolerance !== undefined) {
                rankRangeInput.value = prefs.rankTolerance;
                rankRangeInput.dispatchEvent(new Event('input')); 
            }
            
            // 5. Rangs préférés
            if (Array.isArray(prefs.prefRanks)) {
                // Bascule de l'état "active" pour chaque rang préféré
                document.querySelectorAll('#prefRankGrid .rank-option').forEach(el => {
                    el.classList.toggle('active', prefs.prefRanks.includes(el.getAttribute('data-pref-rank-id')));
                });
            }
        }

        /** Sauvegarde des settings de jeu (Rang/Mode/Options) */
        window.saveGameSettings = async () => {
            if (!userGameData.rank || !userGameData.mainMode) {
                alert("Veuillez sélectionner votre rang et votre mode de jeu.");
                return;
            }

            const settingsPayload = { 
                gameId: gameId,
                rank: userGameData.rank, 
                mainMode: userGameData.mainMode,
                options: userGameData.options
            };
            
            const settingsRes = await fetchProtected('/api/game/settings', {
                method: 'POST',
                body: JSON.stringify(settingsPayload)
            });

            if (settingsRes.ok) {
                alert(`Paramètres de jeu sauvegardés !`);
            } else if (settingsRes.status !== 401) {
                alert("Erreur lors de la sauvegarde des paramètres de jeu.");
            }
        };

        /** Sauvegarde des préférences de partenaire (Rangs Préférés/Tolérance) */
        async function savePartnerPreferences() {
             const prefsPayload = { 
                prefRanks: userGameData.prefRanks, 
                rankTolerance: userGameData.rankTolerance 
            };
            
            const prefsRes = await fetchProtected('/api/game/preferences', {
                method: 'POST',
                body: JSON.stringify(prefsPayload)
            });

            if (prefsRes.ok) {
                // Message de confirmation discrèt ou rien.
            } else if (prefsRes.status !== 401) {
                console.error("Erreur lors de la sauvegarde des préférences de partenaire.");
            }
        }
        
        // ====================================================
        // --- 4. LOGIQUE DE RECHERCHE DE PARTENAIRE (SERVEUR) ---
        // ====================================================

        window.toggleSearch = async () => {
            if (userGameData.isSearching) {
                // Arrêter la recherche
                userGameData.isSearching = false;
                partnerSearchButton.innerHTML = `<i class="fas fa-search"></i> <span>Rechercher un partenaire</span>`;
                partnerSearchButton.classList.remove('searching');
                
                // Simule l'arrêt sur le serveur (si un endpoint d'arrêt est nécessaire)
                // await fetchProtected(`/api/match/${gameId}/stop`, { method: 'POST' }); 
                matchListDiv.innerHTML = `<p style="color:var(--text-muted); text-align:center; padding: 20px; background: var(--bg-card); border-radius: 8px;">Recherche arrêtée. Lancez une recherche pour trouver des joueurs !</p>`;
                document.getElementById('matchCount').textContent = '0';
            } else {
                // Lancer la recherche
                if (!userGameData.rank || !userGameData.mainMode) {
                    alert("Veuillez définir votre rang et votre mode de jeu avant de lancer la recherche.");
                    return;
                }

                userGameData.isSearching = true;
                partnerSearchButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i> <span>Recherche en cours...</span>`;
                partnerSearchButton.classList.add('searching');
                
                // Lancement (Simulé si nécessaire)
                // await fetchProtected(`/api/match/${gameId}/start`, { method: 'POST' });

                // Démarrer la boucle de rafraîchissement des matchs
                fetchMatches();
                // Mise à jour toutes les 5 secondes
                setInterval(fetchMatches, 5000); 
            }
        };

        /** Récupère les matchs depuis l'API serveur */
        async function fetchMatches() {
            if (!userGameData.isSearching) return;
            
            // Appel au nouveau endpoint serveur de recherche
            const response = await fetchProtected(`/api/match/search/${gameId}`);

            if (response.ok) {
                const foundMatches = await response.json();
                renderMatches(foundMatches);
            } else if (response.status !== 401) {
                // En cas d'erreur côté serveur (ex: 400 - pas de settings)
                partnerSearchButton.innerHTML = `<i class="fas fa-search"></i> <span>Rechercher un partenaire</span>`;
                partnerSearchButton.classList.remove('searching');
                userGameData.isSearching = false;
                renderMatches([]); 
                
                try {
                     const err = await response.json();
                     alert("Erreur de recherche : " + (err.message || "Veuillez vérifier vos paramètres de jeu."));
                } catch {
                     alert("Erreur de recherche. Serveur injoignable.");
                }
            }
        }

        function renderMatches(matches) {
            document.getElementById('matchCount').textContent = matches.length.toString();
            if (!matchListDiv) return;
            
            if (matches.length === 0) {
                matchListDiv.innerHTML = `<p style="color:var(--text-muted); text-align:center; padding: 20px; background: var(--bg-card); border-radius: 8px;">${userGameData.isSearching ? "Aucun partenaire trouvé pour l'instant. Patience..." : "Lancez une recherche pour trouver des joueurs !"}</p>`;
                return;
            }

            const matchHtml = matches.map(match => {
                const gameRanks = RANKS[gameId.toLowerCase()] || [];
                const rankInfo = gameRanks.find(r => r.id === match.rank) || { name: 'Non classé', img: '' };
                const modeDisplay = match.mainMode + (match.options && match.options.length > 0 ? ` (${match.options.join(', ')})` : ''); 
                
                return `
                    <div class="match-card">
                        <div class="match-info">
                            <img src="${rankInfo.img}" alt="${rankInfo.name}" class="match-rank-img">
                            <div>
                                <div class="match-username">${match.username}</div>
                                <div class="match-details">Rang: ${rankInfo.name} | Mode: ${modeDisplay}</div>
                            </div>
                        </div>
                        <div class="match-actions">
                            <button class="send-msg-match" onclick="openChat('${match.username}')"><i class="fas fa-comment"></i> Message</button>
                            <button class="add-friend-match" onclick="sendFriendRequest('${match.username}')"><i class="fas fa-user-plus"></i> Ami</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            matchListDiv.innerHTML = matchHtml;
        }
        
        // Simule l'envoi d'une demande d'ami depuis la liste de match (utilise la même logique que le dashboard)
        window.sendFriendRequest = async (username) => {
            const res = await fetchProtected('/api/friends/request', {
                method:'POST',
                body:JSON.stringify({toUsername:username})
            });
            const d = await res.json();
            alert(d.message || d.error || `Demande d'ami envoyée à ${username} !`);
            loadSocial(); // Rafraîchit la sidebar
        };


// ----------------------------------------------------------------
// --- LOGIQUE SOCIALE (Ré-intégrée du Dashboard et mise à jour JWT) ---
// ----------------------------------------------------------------

// ====================================================
// --- 1. FONCTION DE BASCULE DE LA SIDEBAR (Amis) ---
// ====================================================
window.toggleSidebar = function() {
    if (!friendsSidebar) return;
    const isActive = friendsSidebar.classList.toggle('active');
    const toggleBtn = document.querySelector('.toggle-friends-btn');
    
    if (toggleBtn) toggleBtn.classList.toggle('active', isActive);
    
    // Si la sidebar est fermée, on ferme aussi tous les chats actifs.
    if (!isActive) {
        Object.keys(activeChats).forEach(closeChat);
    }

    localStorage.setItem('socialSidebarActive', isActive);
};

// ====================================================
// --- 2. LOGIQUE SOCIALE (Amis/Requests) ---
// ====================================================

async function loadSocial() {
    try {
        // Utilisation de fetchProtected
        const [fRes, rRes] = await Promise.all([
            fetchProtected('/api/friends'), 
            fetchProtected('/api/friends/requests')
        ]);
        
        if (!fRes.ok || !rRes.ok) {
            throw new Error("Erreur de récupération des données sociales.");
        }
        
        const fData = await fRes.json();
        const rData = await rRes.json();

        renderFriends(fData.friends || []);
        renderRequests(rData.incoming || []); 
        renderSent(rData.outgoing || []); 

    } catch (e) {
        renderFriends([]);
        renderRequests([]); 
        renderSent([]); 
        console.error("Erreur chargement social:", e);
    }
}

function renderFriends(list) {
    const c = document.getElementById('friendsList');
    if (!c) return;
    c.innerHTML = "";
    const countSpan = document.getElementById('friendsCount');
    if(countSpan) countSpan.textContent = list.length;
    
    if (!list.length) {
        c.innerHTML = `<p style="text-align:center; color:var(--text-muted); font-size:0.9rem;">Ajoutez des amis !</p>`;
        return;
    }

    list.forEach(f => {
        const d = document.createElement('div');
        d.className = 'friend-card';
        d.onclick = () => openChat(f.username); 
        d.innerHTML = `
            <div style="display: flex; align-items: center;">
                <div class="friend-avatar">${f.username.charAt(0).toUpperCase()}</div>
                <span>${f.username}</span>
            </div>
        `;
        c.appendChild(d);
    });
}

function renderRequests(list) {
    const c = document.getElementById('requestsList');
    if (!c) return;
    c.innerHTML = "";
    const countSpan = document.getElementById('receivedCount');
    if(countSpan) countSpan.textContent = list.length;
    const title = document.getElementById('receivedRequestsTitle');
    if(title) title.style.display = list.length ? 'block' : 'none';

    list.forEach(r => {
        const d = document.createElement('div');
        d.className = 'friend-card';
        d.innerHTML = `
            <div style="display: flex; align-items: center; flex-grow: 1;">
                <div class="friend-avatar">${r.from_username.charAt(0).toUpperCase()}</div>
                <span>${r.from_username}</span>
            </div>
            <div class="request-actions" style="display:flex; gap:5px;">
                <button class="action-btn" style="padding: 5px 8px; font-size: 0.8rem; background: #10b981;" onclick="hReq(${r.id}, 'accept')"><i class="fas fa-check"></i></button>
                <button class="action-btn" style="padding: 5px 8px; font-size: 0.8rem; background: #ef4444;" onclick="hReq(${r.id}, 'reject')"><i class="fas fa-times"></i></button>
            </div>
        `;
        c.appendChild(d);
    });
}

function renderSent(list) {
    const c = document.getElementById('sentList');
    if (!c) return;
    c.innerHTML = "";
    const countSpan = document.getElementById('sentCount');
    if(countSpan) countSpan.textContent = list.length;
    const title = document.getElementById('sentRequestsTitle');
    if(title) title.style.display = list.length ? 'block' : 'none';

    list.forEach(r => {
        const d = document.createElement('div');
        d.className = 'friend-card';
        d.style.opacity = 0.7; 
        d.innerHTML = `
            <div style="display: flex; align-items: center; flex-grow: 1;">
                <div class="friend-avatar">${r.to_username.charAt(0).toUpperCase()}</div>
                <span style="font-style:italic;">${r.to_username} (En attente)</span>
            </div>
            <div class="request-actions">
                <button class="action-btn" style="padding: 5px 8px; font-size: 0.8rem; background: #334155;" onclick="hReq(${r.id}, 'reject')"><i class="fas fa-minus-circle"></i></button>
            </div>
        `;
        c.appendChild(d);
    });
}

// Gère l'envoi de la demande d'ami
const addFriendForm = document.getElementById('add-friend-form');
if (addFriendForm) {
    addFriendForm.addEventListener('submit', async function(e) { 
        e.preventDefault(); 
        const input = document.getElementById('friend-input'); 
        const friendNotif = document.getElementById('friend-notif');
        
        const res = await fetchProtected('/api/friends/request', {
            method:'POST',
            body:JSON.stringify({toUsername:input.value})
        });
        const d = await res.json();
        
        friendNotif.innerText = d.message || d.error || `Erreur: impossible d'envoyer la demande.`;
        input.value = "";
        loadSocial();
        setTimeout(()=>friendNotif.innerText="",3000); 
    });
}

// Gère l'acceptation/rejet d'une demande d'ami
window.hReq = async(id, a) => { 
    await fetchProtected(`/api/friends/requests/${id}/${a}`, {method:'POST'}); 
    loadSocial(); 
};

// ====================================================
// --- 3. LOGIQUE DE CHAT ---
// ====================================================

async function fetchMessages(u) {
    const c = document.getElementById(`msg-${u}`);
    if (!c) return;

    const res = await fetchProtected(`/api/messages/${u}`);
    
    if(!res.ok) return;

    const d = await res.json();
    
    const isScrolledToBottom = c.scrollHeight - c.clientHeight <= c.scrollTop + 1;
    
    c.innerHTML = d.messages.map(m =>
        `<div class="msg ${m.fromSelf ? 'self' : 'other'}">${m.content}</div>`
    ).join('');
    
    if (isScrolledToBottom || d.messages.length <= 10) { // Scroll au premier chargement ou si on est proche du bas
        c.scrollTop = c.scrollHeight;
    }
}

window.openChat = (u) => { 
    if(document.getElementById(`cw-${u}`)) return;
    const d=document.createElement('div'); d.className='chat-window'; d.id=`cw-${u}`;
    d.innerHTML=`
        <div class="chat-header" onclick="closeChat('${u}')">
            <span>${u}</span>
            <span><i class="fas fa-times"></i></span>
        </div>
        <div class="chat-body" id="msg-${u}"></div>
        <form class="chat-input-area" onsubmit="sM(event,'${u}')">
            <input type="text" placeholder="Écrire un message..." autocomplete="off">
            <button type="submit"><i class="fas fa-paper-plane"></i></button>
        </form>
    `;
    if (chatContainer) {
         chatContainer.appendChild(d); 
         fetchMessages(u); 
         activeChats[u]=setInterval(()=>fetchMessages(u),3000);
    }
};

window.closeChat = (u) => { 
    const el=document.getElementById(`cw-${u}`); 
    if(el) el.remove(); 
    if(activeChats[u]){
        clearInterval(activeChats[u]);
        delete activeChats[u];
    } 
};

window.sM = async (e, u) => {
    e.preventDefault();
    const input = e.target.querySelector('input');
    if (!input.value.trim()) return; 

    await fetchProtected('/api/messages', {
        method: 'POST',
        body: JSON.stringify({ toUsername: u, content: input.value.trim() })
    });
    
    input.value = "";
    fetchMessages(u); 
};


// ====================================================
// --- 5. INITIALISATION FINALE ---
// ====================================================
(async function() {
    // Vérifie le token (redirection automatique par fetchProtected si absent/expiré)
    if (!localStorage.getItem('token')) {
        window.location.href = '/login';
        return;
    }
    
    // Initialisation des grilles de rangs
    const gameRanks = RANKS[gameId.toLowerCase()] || RANKS.valorant;
    setupRankGrids(gameRanks); 

    // Chargement des données 
    await loadGameInfo();
    await loadProfileAndSettings(); // Charge les données du serveur
    
    // Rétablit l'état de la sidebar (Amis) au chargement
    const friendsSidebarActive = localStorage.getItem('socialSidebarActive') === 'true';
    if (friendsSidebarActive) {
        friendsSidebar.classList.add('active');
        const toggleBtn = document.querySelector('.toggle-friends-btn');
        if (toggleBtn) toggleBtn.classList.add('active');
    }
    
    // Chargement des données sociales et rafraîchissement
    loadSocial();
    setInterval(loadSocial, 5000); 
})();

    </script>
</body>
</html>
